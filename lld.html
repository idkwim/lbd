

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>LLD for Cpu0 &mdash; Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '3.3.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/theme_extras.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="top" title="Tutorial: Creating an LLVM Backend for the Cpu0 Architecture" href="index.html" />
    <link rel="next" title="Appendix A: Getting Started: Installing LLVM and the Cpu0 example code" href="install.html" />
    <link rel="prev" title="Backend Optimization" href="optimize.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="index.html">
          <span>Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</span></a></h1>
        <h2 class="heading"><span>LLD for Cpu0</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="optimize.html">Backend Optimization</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="install.html">Appendix A: Getting Started: Installing LLVM and the Cpu0 example code</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="lld-for-cpu0">
<span id="sec-lld"></span><h1>LLD for Cpu0<a class="headerlink" href="#lld-for-cpu0" title="Permalink to this headline">¶</a></h1>
<p>This chapter add Cpu0 backend in lld. With this lld Cpu0 for ELF linker support,
the program with global variables can be allocated in ELF file format layout.
Meaning the relocation records of global variable can be solved. In addition,
llvm-objdump driver is modified for support generate Hex file from ELF.
With these two tools supported, the program with global variables exist in section
.data and .rodata can be accessed and transfered to Hex file which feed to
Verilog Cpu0 machine and run on your PC/Laptop.</p>
<p>LLD web site <a class="footnote-reference" href="#id3" id="id1">[1]</a>. LLD install requirement on Linux <a class="footnote-reference" href="#id4" id="id2">[2]</a>.
In spite of the requirement, we
only can build with gcc4.7 above (clang will fail) on Linux.
If you run with Virtual Machine (VM), please keep your phisical memory size
setting over 1GB to avoid link error with insufficient memory.</p>
<div class="section" id="install-lld">
<h2>Install lld<a class="headerlink" href="#install-lld" title="Permalink to this headline">¶</a></h2>
<p>LLD project is underdevelopment and can be compiled with c++11 standard (C++
2011 year announced standard). Currently, we only know how to build lld with
llvm on Linux platform or Linux VM. Please let us know if you know how to build
it on iMac with Xcode. So, if you got iMac only, please install VM (such as
Virtual Box). We porting lld Cpu0 at 2013/08/16, so please checkout the last
commit of 2013/08/15 of llvm and lld or the commit id are
da44b4f68bcf2adcb74214670a266b43a1a6888f(llvm)
014d684d27a0f520a30285051a5c8194c87e0194(lld) as follows,</p>
<div class="highlight-bash"><pre>[Gamma@localhost test]$ mkdir lld
[Gamma@localhost test]$ cd lld
[Gamma@localhost lld]$ git clone http://llvm.org/git/llvm.git src
Cloning into 'src'...
remote: Counting objects: 780029, done.
remote: Compressing objects: 100% (153947/153947), done.
remote: Total 780029 (delta 637206), reused 764781 (delta 622170)
Receiving objects: 100% (780029/780029), 125.74 MiB | 243 KiB/s, done.
Resolving deltas: 100% (637206/637206), done.
[Gamma@localhost lld]$ cd src/
[Gamma@localhost src]$ git log
...
Date:   Fri Aug 16 00:15:20 2013 +0000

    InstCombine: Simplify if(x!=0 &amp;&amp; x!=-1).

    When both constants are positive or both constants are negative,
    InstCombine already simplifies comparisons like this, but when
    it's exactly zero and -1, the operand sorting ends up reversed
    and the pattern fails to match. Handle that special case.

    Follow up for rdar://14689217

    git-svn-id: https://llvm.org/svn/llvm-project/llvm/trunk@188512 91177308-0d3

commit da44b4f68bcf2adcb74214670a266b43a1a6888f
Author: Hans Wennborg &lt;hans@hanshq.net&gt;
Date:   Thu Aug 15 23:44:31 2013 +0000

[Gamma@localhost src]$ git checkout da44b4f68bcf2adcb74214670a266b43a1a6888f
Note: checking out 'da44b4f68bcf2adcb74214670a266b43a1a6888f'.

You are in 'detached HEAD' state. You can look around, make experimental
changes and commit them, and you can discard any commits you make in this
state without impacting any branches by performing another checkout.

If you want to create a new branch to retain commits you create, you may
do so (now or later) by using -b with the checkout command again. Example:

  git checkout -b new_branch_name

HEAD is now at da44b4f... CMake: polish the Windows packaging rules

[Gamma@localhost src]$ cd tools/
[Gamma@localhost tools]$ git clone http://llvm.org/git/lld.git lld
...
Resolving deltas: 100% (6422/6422), done.
[Gamma@localhost tools]$ cd lld/[Gamma@localhost src]$ git log
...
Date:   Wed Aug 21 22:57:10 2013 +0000

    add InputGraph functionality

    git-svn-id: https://llvm.org/svn/llvm-project/lld/trunk@188958 91177308-0d34

commit 014d684d27a0f520a30285051a5c8194c87e0194
Author: Hans Wennborg &lt;hans@hanshq.net&gt;
Date:   Tue Aug 13 21:44:44 2013 +0000
[Gamma@localhost lld]$ git checkout 014d684d27a0f520a30285051a5c8194c87e0194
Note: checking out '014d684d27a0f520a30285051a5c8194c87e0194'.

You are in 'detached HEAD' state. You can look around, make experimental
changes and commit them, and you can discard any commits you make in this
state without impacting any branches by performing another checkout.

If you want to create a new branch to retain commits you create, you may
do so (now or later) by using -b with the checkout command again. Example:

  git checkout -b new_branch_name

HEAD is now at 014d684... [PECOFF] Handle "--" option explicitly</pre>
</div>
<p>Next, update llvm 2013/08/16 source code to support Cpu0 as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>Gamma@localhost src<span class="o">]</span><span class="nv">$ </span><span class="nb">pwd</span>
/home/Gamma/test/lld/src
<span class="o">[</span>Gamma@localhost src<span class="o">]</span><span class="nv">$ </span>cp -rf ~/test/lbd/docs/BackendTutorial/
LLVMBackendTutorialExampleCode/3.4_20130816_src_files_modify/modify/src/* .
<span class="o">[</span>Gamma@localhost src<span class="o">]</span><span class="nv">$ </span>grep -R <span class="s2">&quot;cpu0&quot;</span> include/
include/llvm/ADT/Triple.h:#undef cpu0
include/llvm/ADT/Triple.h:    cpu0,    // For Tutorial Backend Cpu0
include/llvm/ADT/Triple.h:    cpu0el,
include/llvm/Object/ELFObjectFile.h:           Triple::cpu0el : Triple::cpu0;
include/llvm/Support/ELF.h:  <span class="nv">EF_CPU0_ARCH_32R2</span> <span class="o">=</span> 0x70000000, // cpu032r2
include/llvm/Support/ELF.h:  <span class="nv">EF_CPU0_ARCH_64R2</span> <span class="o">=</span> 0x80000000, // cpu064r2
<span class="o">[</span>Gamma@localhost src<span class="o">]</span><span class="nv">$ </span><span class="nb">cd </span>lib/Target/
<span class="o">[</span>Gamma@localhost Target<span class="o">]</span><span class="nv">$ </span>ls
AArch64         MSP430                   TargetJITInfo.cpp
ARM             NVPTX                    TargetLibraryInfo.cpp
CMakeLists.txt  PowerPC                  TargetLoweringObjectFile.cpp
CppBackend      R600                     TargetMachineC.cpp
Hexagon         README.txt               TargetMachine.cpp
LLVMBuild.txt   Sparc                    TargetSubtargetInfo.cpp
Makefile        SystemZ                  X86
Mangler.cpp     Target.cpp               XCore
Mips            TargetIntrinsicInfo.cpp
<span class="o">[</span>Gamma@localhost Target<span class="o">]</span><span class="nv">$ </span>mkdir Cpu0
<span class="o">[</span>Gamma@localhost Target<span class="o">]</span><span class="nv">$ </span><span class="nb">cd </span>Cpu0/
<span class="o">[</span>Gamma@localhost Cpu0<span class="o">]</span><span class="nv">$ </span>cp -rf ~/test/lbd/docs/BackendTutorial/
LLVMBackendTutorialExampleCode/3.4_20130816_Chapter11_2/* .
<span class="o">[</span>Gamma@localhost Cpu0<span class="o">]</span><span class="nv">$ </span>ls
AsmParser                 Cpu0InstrInfo.h           Cpu0SelectionDAGInfo.h
CMakeLists.txt            Cpu0InstrInfo.td          Cpu0Subtarget.cpp
Cpu0AnalyzeImmediate.cpp  Cpu0ISelDAGToDAG.cpp      Cpu0Subtarget.h
Cpu0AnalyzeImmediate.h    Cpu0ISelLowering.cpp      Cpu0TargetMachine.cpp
Cpu0AsmPrinter.cpp        Cpu0ISelLowering.h        Cpu0TargetMachine.h
Cpu0AsmPrinter.h          Cpu0MachineFunction.cpp   Cpu0TargetObjectFile.cpp
Cpu0CallingConv.td        Cpu0MachineFunction.h     Cpu0TargetObjectFile.h
Cpu0DelUselessJMP.cpp     Cpu0MCInstLower.cpp       Cpu0.td
Cpu0EmitGPRestore.cpp     Cpu0MCInstLower.h         Disassembler
Cpu0FrameLowering.cpp     Cpu0RegisterInfo.cpp      InstPrinter
Cpu0FrameLowering.h       Cpu0RegisterInfo.h        LLVMBuild.txt
Cpu0.h                    Cpu0RegisterInfo.td       MCTargetDesc
Cpu0InstrFormats.td       Cpu0Schedule.td           TargetInfo
Cpu0InstrInfo.cpp         Cpu0SelectionDAGInfo.cpp
</pre></div>
</div>
<p>Next, copy lld Cpu0 architecture ELF support as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>Gamma@localhost Cpu0<span class="o">]</span><span class="nv">$ </span><span class="nb">cd</span> ../../../tools/lld/lib/ReaderWriter/ELF/
<span class="o">[</span>Gamma@localhost ELF<span class="o">]</span><span class="nv">$ </span><span class="nb">pwd</span>
/home/Gamma/test/lld/src/tools/lld/lib/ReaderWriter/ELF
<span class="o">[</span>Gamma@localhost ELF<span class="o">]</span><span class="nv">$ </span>cp -rf ~/test/lbd/docs/BackendTutorial/
LLVMBackendTutorialExampleCode/Cpu0_lld_20130816/CMakeLists.txt ~/test/lbd/
docs/BackendTutorial/LLVMBackendTutorialExampleCode/Cpu0_lld_20130816/
ELFLinkingContext.cpp ~/test/lbd/docs/BackendTutorial/
LLVMBackendTutorialExampleCode/Cpu0_lld_20130816/Targets.h .
<span class="o">[</span>Gamma@localhost ELF<span class="o">]</span><span class="nv">$ </span>cp -rf ~/test/lbd/docs/BackendTutorial/
LLVMBackendTutorialExampleCode/Cpu0_lld_20130816/Resolver.cpp ../../Core/.
</pre></div>
</div>
<p>Finally, update llvm-objdump to support convert ELF file to Hex file as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>Gamma@localhost ELF<span class="o">]</span><span class="nv">$ </span><span class="nb">cd</span> ../../../../llvm-objdump/
<span class="o">[</span>Gamma@localhost llvm-objdump<span class="o">]</span><span class="nv">$ </span><span class="nb">pwd</span>
/home/Gamma/test/lld/src/tools/llvm-objdump
<span class="o">[</span>Gamma@localhost llvm-objdump<span class="o">]</span><span class="nv">$ </span>cp -rf ~/test/lbd/docs/BackendTutorial/
LLVMBackendTutorialExampleCode/llvm-objdump/* .
</pre></div>
</div>
<p>Now, build llvm/lld 2013/08/16 with Cpu0 support as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>Gamma@localhost cmake_debug_build<span class="o">]</span><span class="nv">$ </span>cmake -DCMAKE_CXX_COMPILER<span class="o">=</span>g++ -
<span class="nv">DCMAKE_C_COMPILER</span><span class="o">=</span>gcc -DCMAKE_CXX_FLAGS<span class="o">=</span>-std<span class="o">=</span>c++11 -DCMAKE_BUILD_TYPE<span class="o">=</span>Debug
-G <span class="s2">&quot;Unix Makefiles&quot;</span> ../src
-- The C compiler identification is GNU 4.7.2
-- The CXX compiler identification is GNU 4.7.2
...
-- Targeting Cpu0
...
-- Configuring <span class="k">done</span>
-- Generating <span class="k">done</span>
-- Build files have been written to: /home/Gamma/test/lld/cmake_debug_build
</pre></div>
</div>
</div>
<div class="section" id="cpu0-lld">
<h2>Cpu0 lld<a class="headerlink" href="#cpu0-lld" title="Permalink to this headline">¶</a></h2>
<p>The code added on lld to support Cpu0 ELF as follows,</p>
<p class="rubric">LLVMBackendTutorialExampleCode/Cpu0_lld_20130816/CMakeLists.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">target_link_libraries</span><span class="p">(</span><span class="n">lldELF</span>
  <span class="p">...</span>
  <span class="n">lldCpu0ELFTarget</span>
  <span class="p">)</span>
</pre></div>
</div>
<p class="rubric">LLVMBackendTutorialExampleCode/Cpu0_lld_20130816/ELFLinkingContext.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">uint16_t</span> <span class="n">ELFLinkingContext</span><span class="o">::</span><span class="n">getOutputMachine</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">getTriple</span><span class="p">().</span><span class="n">getArch</span><span class="p">())</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span><span class="o">::</span><span class="nl">cpu0:</span>
    <span class="k">return</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="n">EM_CPU0</span><span class="p">;</span>
  <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">LLVMBackendTutorialExampleCode/Cpu0_lld_20130816/Targets.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;Cpu0/Cpu0Target.h&quot;</span>
</pre></div>
</div>
<p class="rubric">LLVMBackendTutorialExampleCode/Cpu0_lld_20130816/Resolver.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">bool</span> <span class="n">Resolver</span><span class="o">::</span><span class="n">checkUndefines</span><span class="p">(</span><span class="kt">bool</span> <span class="n">final</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">_context</span><span class="p">.</span><span class="n">printRemainingUndefines</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">undefAtom</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;_start&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// cschen debug</span>
          <span class="n">foundUndefines</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="p">...</span>
      <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">LLVMBackendTutorialExampleCode/Cpu0_lld_20130816/Cpu0/CMakeLists.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">add_lld_library</span><span class="p">(</span><span class="n">lldCpu0ELFTarget</span>
  <span class="n">Cpu0LinkingContext</span><span class="p">.</span><span class="n">cpp</span>
  <span class="n">Cpu0TargetHandler</span><span class="p">.</span><span class="n">cpp</span>
  <span class="n">Cpu0RelocationHandler</span><span class="p">.</span><span class="n">cpp</span>
  <span class="p">)</span>

<span class="n">target_link_libraries</span><span class="p">(</span><span class="n">lldCpu0ELFTarget</span>
  <span class="n">lldCore</span>
  <span class="p">)</span>
</pre></div>
</div>
<p class="rubric">LLVMBackendTutorialExampleCode/Cpu0_lld_20130816/Cpu0/Cpu0LinkingContext.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===- lib/ReaderWriter/ELF/Cpu0/Cpu0LinkingContext.h ---------------------===//</span>
<span class="c1">//</span>
<span class="c1">//                             The LLVM Linker</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef LLD_READER_WRITER_ELF_CPU0_LINKER_CONTEXT_H</span>
<span class="cp">#define LLD_READER_WRITER_ELF_CPU0_LINKER_CONTEXT_H</span>

<span class="cp">#include &quot;Cpu0TargetHandler.h&quot;</span>

<span class="cp">#include &quot;lld/ReaderWriter/ELFLinkingContext.h&quot;</span>

<span class="cp">#include &quot;llvm/Object/ELF.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/ELF.h&quot;</span>

<span class="k">namespace</span> <span class="n">lld</span> <span class="p">{</span>
<span class="k">namespace</span> <span class="n">elf</span> <span class="p">{</span>
<span class="cp">#if 1</span>
<span class="c1">/// \brief cpu0 internal references.</span>
<span class="k">enum</span> <span class="p">{</span>
  <span class="c1">/// \brief The 32 bit index of the relocation in the got this reference refers</span>
  <span class="c1">/// to.</span>
  <span class="n">LLD_R_CPU0_GOTRELINDEX</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">class</span> <span class="nc">Cpu0LinkingContext</span> <span class="n">LLVM_FINAL</span> <span class="o">:</span> <span class="k">public</span> <span class="n">ELFLinkingContext</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0LinkingContext</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span> <span class="n">triple</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">ELFLinkingContext</span><span class="p">(</span><span class="n">triple</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">TargetHandlerBase</span><span class="o">&gt;</span><span class="p">(</span>
                                  <span class="k">new</span> <span class="n">Cpu0TargetHandler</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)))</span> <span class="p">{}</span>

  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">isLittleEndian</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">addPasses</span><span class="p">(</span><span class="n">PassManager</span> <span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

  <span class="c1">// Cpu0 run begin from address 0 while X86 from 0x400000</span>
  <span class="k">virtual</span> <span class="n">uint64_t</span> <span class="n">getBaseAddress</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_baseAddress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">return</span> <span class="mh">0x000000</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">_baseAddress</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">isDynamicRelocation</span><span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">&amp;</span><span class="p">,</span>
                                   <span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">kind</span><span class="p">()){</span>
<span class="c1">//    case llvm::ELF::R_CPU0_RELATIVE:</span>
    <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="nl">R_CPU0_GLOB_DAT:</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">isPLTRelocation</span><span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">&amp;</span><span class="p">,</span>
                               <span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">kind</span><span class="p">()){</span>
    <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="nl">R_CPU0_JUMP_SLOT:</span>
    <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="nl">R_CPU0_RELGOT:</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">/// \brief Cpu0 has two relative relocations</span>
  <span class="c1">/// a) for supporting IFUNC - R_CPU0_RELGOT</span>
  <span class="c1">/// b) for supporting relative relocs - R_CPU0_RELATIVE</span>
  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">isRelativeReloc</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">kind</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="nl">R_CPU0_RELGOT:</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">    case llvm::ELF::R_CPU0_RELATIVE:</span>
<span class="c">      return true;</span>
<span class="cp">#endif</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="n">Reference</span><span class="o">::</span><span class="n">Kind</span><span class="o">&gt;</span> <span class="n">relocKindFromString</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">str</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">stringFromRelocKind</span><span class="p">(</span><span class="n">Reference</span><span class="o">::</span><span class="n">Kind</span> <span class="n">kind</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

<span class="p">};</span>
<span class="p">}</span> <span class="c1">// end namespace elf</span>
<span class="p">}</span> <span class="c1">// end namespace lld</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">LLVMBackendTutorialExampleCode/Cpu0_lld_20130816/Cpu0/Cpu0LinkingContext.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===- lib/ReaderWriter/ELF/Cpu0/Cpu0LinkingContext.cpp -------------------===//</span>
<span class="c1">//</span>
<span class="c1">//                             The LLVM Linker</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Atoms.h&quot;</span>
<span class="cp">#include &quot;Cpu0LinkingContext.h&quot;</span>

<span class="cp">#include &quot;lld/Core/File.h&quot;</span>
<span class="cp">#include &quot;lld/Core/Instrumentation.h&quot;</span>
<span class="cp">#include &quot;lld/Core/Parallel.h&quot;</span>
<span class="cp">#include &quot;lld/Core/Pass.h&quot;</span>
<span class="cp">#include &quot;lld/Core/PassManager.h&quot;</span>
<span class="cp">#include &quot;lld/ReaderWriter/Simple.h&quot;</span>

<span class="cp">#include &quot;llvm/ADT/ArrayRef.h&quot;</span>
<span class="cp">#include &quot;llvm/ADT/DenseMap.h&quot;</span>
<span class="cp">#include &quot;llvm/ADT/StringSwitch.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">lld</span><span class="p">;</span>
<span class="cp">#if 1</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">lld</span><span class="o">::</span><span class="n">elf</span><span class="p">;</span>

<span class="k">namespace</span> <span class="p">{</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="p">;</span>

<span class="c1">// .got values</span>
<span class="k">const</span> <span class="n">uint8_t</span> <span class="n">cpu0GotAtomContent</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

<span class="c1">// .plt value (entry 0)</span>
<span class="k">const</span> <span class="n">uint8_t</span> <span class="n">cpu0Plt0AtomContent</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// pushq GOT+8(%rip)</span>
  <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// jmp *GOT+16(%rip)</span>
  <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x90</span>              <span class="c1">// nopnopnop</span>
<span class="p">};</span>

<span class="c1">// .plt values (other entries)</span>
<span class="k">const</span> <span class="n">uint8_t</span> <span class="n">cpu0PltAtomContent</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// jmpq *gotatom(%rip)</span>
  <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>       <span class="c1">// pushq reloc-index</span>
  <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>        <span class="c1">// jmpq plt[-1]</span>
<span class="p">};</span>

<span class="c1">/// \brief Atoms that are used by Cpu0 dynamic linking</span>
<span class="k">class</span> <span class="nc">Cpu0GOTAtom</span> <span class="o">:</span> <span class="k">public</span> <span class="n">GOTAtom</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="k">const</span> <span class="n">File</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">secName</span><span class="p">)</span> <span class="o">:</span> <span class="n">GOTAtom</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">secName</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">virtual</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span> <span class="n">rawContent</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cpu0GotAtomContent</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Cpu0PLT0Atom</span> <span class="o">:</span> <span class="k">public</span> <span class="n">PLT0Atom</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0PLT0Atom</span><span class="p">(</span><span class="k">const</span> <span class="n">File</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">)</span> <span class="o">:</span> <span class="n">PLT0Atom</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;.PLT0&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>
  <span class="k">virtual</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span> <span class="n">rawContent</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cpu0Plt0AtomContent</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Cpu0PLTAtom</span> <span class="o">:</span> <span class="k">public</span> <span class="n">PLTAtom</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0PLTAtom</span><span class="p">(</span><span class="k">const</span> <span class="n">File</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">secName</span><span class="p">)</span> <span class="o">:</span> <span class="n">PLTAtom</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">secName</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">virtual</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span> <span class="n">rawContent</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cpu0PltAtomContent</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">ELFPassFile</span> <span class="o">:</span> <span class="k">public</span> <span class="n">SimpleFile</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">ELFPassFile</span><span class="p">(</span><span class="k">const</span> <span class="n">ELFLinkingContext</span> <span class="o">&amp;</span><span class="n">eti</span><span class="p">)</span> <span class="o">:</span> <span class="n">SimpleFile</span><span class="p">(</span><span class="n">eti</span><span class="p">,</span> <span class="s">&quot;ELFPassFile&quot;</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">llvm</span><span class="o">::</span><span class="n">BumpPtrAllocator</span> <span class="n">_alloc</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">/// \brief Create GOT and PLT entries for relocations. Handles standard GOT/PLT</span>
<span class="c1">/// along with IFUNC and TLS.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Derived</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">GOTPLTPass</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Pass</span> <span class="p">{</span>
  <span class="c1">/// \brief Handle a specific reference.</span>
  <span class="kt">void</span> <span class="n">handleReference</span><span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">&amp;</span><span class="n">atom</span><span class="p">,</span> <span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">kind</span><span class="p">())</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">    case R_CPU0_PLT32:</span>
<span class="c">      static_cast&lt;Derived *&gt;(this)-&gt;handlePLT32(ref);</span>
<span class="c">      break;</span>
<span class="cp">#endif</span>
    <span class="k">case</span> <span class="nl">R_CPU0_PC24:</span>
      <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Derived</span> <span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">handlePC24</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">    case R_CPU0_GOTTPOFF: // GOT Thread Pointer Offset</span>
<span class="c">      static_cast&lt;Derived *&gt;(this)-&gt;handleGOTTPOFF(ref);</span>
<span class="c">      break;</span>
<span class="c">    case R_CPU0_GOTPCREL:</span>
<span class="c">      static_cast&lt;Derived *&gt;(this)-&gt;handleGOTPCREL(ref);</span>
<span class="c">      break;</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="k">protected</span><span class="o">:</span>
  <span class="c1">/// \brief get the PLT entry for a given IFUNC Atom.</span>
  <span class="c1">///</span>
  <span class="c1">/// If the entry does not exist. Both the GOT and PLT entry is created.</span>
  <span class="k">const</span> <span class="n">PLTAtom</span> <span class="o">*</span><span class="n">getIFUNCPLTEntry</span><span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">*</span><span class="n">da</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">_pltMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">da</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">plt</span> <span class="o">!=</span> <span class="n">_pltMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
      <span class="k">return</span> <span class="n">plt</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">ga</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got.plt&quot;</span><span class="p">);</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_RELGOT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">pa</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0PLTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.plt&quot;</span><span class="p">);</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ga</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got_ifunc_&quot;</span><span class="p">;</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">da</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__plt_ifunc_&quot;</span><span class="p">;</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">da</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
<span class="cp">#endif</span>
    <span class="n">_gotMap</span><span class="p">[</span><span class="n">da</span><span class="p">]</span> <span class="o">=</span> <span class="n">ga</span><span class="p">;</span>
    <span class="n">_pltMap</span><span class="p">[</span><span class="n">da</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
    <span class="n">_gotVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ga</span><span class="p">);</span>
    <span class="n">_pltVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pa</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">pa</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">/// \brief Redirect the call to the PLT stub for the target IFUNC.</span>
  <span class="c1">///</span>
  <span class="c1">/// This create a PLT and GOT entry for the IFUNC if one does not exist. The</span>
  <span class="c1">/// GOT entry and a RELGOT relocation to the original target resolver.</span>
  <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">handleIFUNC</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">target</span> <span class="o">=</span> <span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">&amp;&amp;</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">contentType</span><span class="p">()</span> <span class="o">==</span> <span class="n">DefinedAtom</span><span class="o">::</span><span class="n">typeResolver</span><span class="p">)</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getIFUNCPLTEntry</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">error_code</span><span class="o">::</span><span class="n">success</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">/// \brief Create a GOT entry for the TP offset of a TLS atom.</span>
  <span class="k">const</span> <span class="n">GOTAtom</span> <span class="o">*</span><span class="n">getGOTTPOFF</span><span class="p">(</span><span class="k">const</span> <span class="n">Atom</span> <span class="o">*</span><span class="n">atom</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">got</span> <span class="o">=</span> <span class="n">_gotMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">atom</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">got</span> <span class="o">==</span> <span class="n">_gotMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">auto</span> <span class="n">g</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got&quot;</span><span class="p">);</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_TLS_TPREL32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got_tls_&quot;</span><span class="p">;</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">atom</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
<span class="cp">#endif</span>
      <span class="n">_gotMap</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
      <span class="n">_gotVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">g</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">got</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">/// \brief Create a TLS_TPREL32 GOT entry and change the relocation to a PC24 to</span>
  <span class="c1">/// the GOT.</span>
  <span class="kt">void</span> <span class="n">handleGOTTPOFF</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getGOTTPOFF</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()));</span>
    <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setKind</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">/// \brief Create a GOT entry containing 0.</span>
  <span class="k">const</span> <span class="n">GOTAtom</span> <span class="o">*</span><span class="n">getNullGOT</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_null</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got.plt&quot;</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
      <span class="n">_null</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got_null&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">GOTAtom</span> <span class="o">*</span><span class="n">getGOT</span><span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">*</span><span class="n">da</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">got</span> <span class="o">=</span> <span class="n">_gotMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">da</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">got</span> <span class="o">==</span> <span class="n">_gotMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">auto</span> <span class="n">g</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got&quot;</span><span class="p">);</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got_&quot;</span><span class="p">;</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">da</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
<span class="cp">#endif</span>
      <span class="n">_gotMap</span><span class="p">[</span><span class="n">da</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
      <span class="n">_gotVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">g</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">got</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">/// \brief Handle a GOTPCREL relocation to an undefined weak atom by using a</span>
  <span class="c1">/// null GOT entry.</span>
  <span class="kt">void</span> <span class="n">handleGOTPCREL</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setKind</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">UndefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getNullGOT</span><span class="p">());</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">*</span><span class="n">da</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getGOT</span><span class="p">(</span><span class="n">da</span><span class="p">));</span>
  <span class="p">}</span>

<span class="k">public</span><span class="o">:</span>
  <span class="n">GOTPLTPass</span><span class="p">(</span><span class="k">const</span> <span class="n">ELFLinkingContext</span> <span class="o">&amp;</span><span class="n">ti</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">_file</span><span class="p">(</span><span class="n">ti</span><span class="p">),</span> <span class="n">_null</span><span class="p">(</span><span class="n">nullptr</span><span class="p">),</span> <span class="n">_PLT0</span><span class="p">(</span><span class="n">nullptr</span><span class="p">),</span> <span class="n">_got0</span><span class="p">(</span><span class="n">nullptr</span><span class="p">),</span>
        <span class="n">_got1</span><span class="p">(</span><span class="n">nullptr</span><span class="p">)</span> <span class="p">{}</span>

  <span class="c1">/// \brief Do the pass.</span>
  <span class="c1">///</span>
  <span class="c1">/// The goal here is to first process each reference individually. Each call</span>
  <span class="c1">/// to handleReference may modify the reference itself and/or create new</span>
  <span class="c1">/// atoms which must be stored in one of the maps below.</span>
  <span class="c1">///</span>
  <span class="c1">/// After all references are handled, the atoms created during that are all</span>
  <span class="c1">/// added to mf.</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">perform</span><span class="p">(</span><span class="n">MutableFile</span> <span class="o">&amp;</span><span class="n">mf</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ScopedTask</span> <span class="n">task</span><span class="p">(</span><span class="n">getDefaultDomain</span><span class="p">(),</span> <span class="s">&quot;Cpu0 GOT/PLT Pass&quot;</span><span class="p">);</span>
    <span class="c1">// Process all references.</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="n">atom</span> <span class="o">:</span> <span class="n">mf</span><span class="p">.</span><span class="n">defined</span><span class="p">())</span>
      <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="n">ref</span> <span class="o">:</span> <span class="o">*</span><span class="n">atom</span><span class="p">)</span>
        <span class="n">handleReference</span><span class="p">(</span><span class="o">*</span><span class="n">atom</span><span class="p">,</span> <span class="o">*</span><span class="n">ref</span><span class="p">);</span>

    <span class="c1">// Add all created atoms to the link.</span>
    <span class="n">uint64_t</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_PLT0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_PLT0</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">ordinal</span><span class="o">++</span><span class="p">);</span>
      <span class="n">mf</span><span class="p">.</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">_PLT0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">plt</span> <span class="o">:</span> <span class="n">_pltVector</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">plt</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">ordinal</span><span class="o">++</span><span class="p">);</span>
      <span class="n">mf</span><span class="p">.</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">plt</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_null</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">ordinal</span><span class="o">++</span><span class="p">);</span>
      <span class="n">mf</span><span class="p">.</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">_null</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_PLT0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_got0</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">ordinal</span><span class="o">++</span><span class="p">);</span>
      <span class="n">_got1</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">ordinal</span><span class="o">++</span><span class="p">);</span>
      <span class="n">mf</span><span class="p">.</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">_got0</span><span class="p">);</span>
      <span class="n">mf</span><span class="p">.</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">_got1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">got</span> <span class="o">:</span> <span class="n">_gotVector</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">got</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">ordinal</span><span class="o">++</span><span class="p">);</span>
      <span class="n">mf</span><span class="p">.</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">got</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="k">protected</span><span class="o">:</span>
  <span class="c1">/// \brief Owner of all the Atoms created by this pass.</span>
  <span class="n">ELFPassFile</span> <span class="n">_file</span><span class="p">;</span>

  <span class="c1">/// \brief Map Atoms to their GOT entries.</span>
  <span class="n">llvm</span><span class="o">::</span><span class="n">DenseMap</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Atom</span> <span class="o">*</span><span class="p">,</span> <span class="n">GOTAtom</span> <span class="o">*&gt;</span> <span class="n">_gotMap</span><span class="p">;</span>

  <span class="c1">/// \brief Map Atoms to their PLT entries.</span>
  <span class="n">llvm</span><span class="o">::</span><span class="n">DenseMap</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Atom</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLTAtom</span> <span class="o">*&gt;</span> <span class="n">_pltMap</span><span class="p">;</span>

  <span class="c1">/// \brief the list of GOT/PLT atoms</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">GOTAtom</span> <span class="o">*&gt;</span> <span class="n">_gotVector</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PLTAtom</span> <span class="o">*&gt;</span> <span class="n">_pltVector</span><span class="p">;</span>

  <span class="c1">/// \brief GOT entry that is always 0. Used for undefined weaks.</span>
  <span class="n">GOTAtom</span> <span class="o">*</span><span class="n">_null</span><span class="p">;</span>

  <span class="c1">/// \brief The got and plt entries for .PLT0. This is used to call into the</span>
  <span class="c1">/// dynamic linker for symbol resolution.</span>
  <span class="c1">/// @{</span>
  <span class="n">PLT0Atom</span> <span class="o">*</span><span class="n">_PLT0</span><span class="p">;</span>
  <span class="n">GOTAtom</span> <span class="o">*</span><span class="n">_got0</span><span class="p">;</span>
  <span class="n">GOTAtom</span> <span class="o">*</span><span class="n">_got1</span><span class="p">;</span>
  <span class="c1">/// @}</span>
<span class="p">};</span>

<span class="c1">/// This implements the static relocation model. Meaning GOT and PLT entries are</span>
<span class="c1">/// not created for references that can be directly resolved. These are</span>
<span class="c1">/// converted to a direct relocation. For entries that do require a GOT or PLT</span>
<span class="c1">/// entry, that entry is statically bound.</span>
<span class="c1">///</span>
<span class="c1">/// TLS always assumes module 1 and attempts to remove indirection.</span>
<span class="k">class</span> <span class="nc">StaticGOTPLTPass</span> <span class="n">LLVM_FINAL</span> <span class="o">:</span> <span class="k">public</span> <span class="n">GOTPLTPass</span><span class="o">&lt;</span><span class="n">StaticGOTPLTPass</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">StaticGOTPLTPass</span><span class="p">(</span><span class="k">const</span> <span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span> <span class="o">&amp;</span><span class="n">ti</span><span class="p">)</span> <span class="o">:</span> <span class="n">GOTPLTPass</span><span class="p">(</span><span class="n">ti</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">handlePLT32</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// __tls_get_addr is handled elsewhere.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;__tls_get_addr&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setKind</span><span class="p">(</span><span class="n">R_CPU0_NONE</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">error_code</span><span class="o">::</span><span class="n">success</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span>
      <span class="c1">// Static code doesn&#39;t need PLTs.</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setKind</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">);</span>
    <span class="c1">// Handle IFUNC.</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">*</span><span class="n">da</span> <span class="o">=</span>
            <span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">da</span><span class="o">-&gt;</span><span class="n">contentType</span><span class="p">()</span> <span class="o">==</span> <span class="n">DefinedAtom</span><span class="o">::</span><span class="n">typeResolver</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">handleIFUNC</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">error_code</span><span class="o">::</span><span class="n">success</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">handlePC24</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">handleIFUNC</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">DynamicGOTPLTPass</span> <span class="n">LLVM_FINAL</span> <span class="o">:</span> <span class="k">public</span> <span class="n">GOTPLTPass</span><span class="o">&lt;</span><span class="n">DynamicGOTPLTPass</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">DynamicGOTPLTPass</span><span class="p">(</span><span class="k">const</span> <span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span> <span class="o">&amp;</span><span class="n">ti</span><span class="p">)</span> <span class="o">:</span> <span class="n">GOTPLTPass</span><span class="p">(</span><span class="n">ti</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">const</span> <span class="n">PLT0Atom</span> <span class="o">*</span><span class="n">getPLT0</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_PLT0</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">_PLT0</span><span class="p">;</span>
    <span class="c1">// Fill in the null entry.</span>
    <span class="n">getNullGOT</span><span class="p">();</span>
    <span class="n">_PLT0</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0PLT0Atom</span><span class="p">(</span><span class="n">_file</span><span class="p">);</span>
    <span class="n">_got0</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got.plt&quot;</span><span class="p">);</span>
    <span class="n">_got1</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got.plt&quot;</span><span class="p">);</span>
    <span class="n">_PLT0</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">_got0</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">);</span>
    <span class="n">_PLT0</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">_got1</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="n">_got0</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got0&quot;</span><span class="p">;</span>
    <span class="n">_got1</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got1&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="k">return</span> <span class="n">_PLT0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">PLTAtom</span> <span class="o">*</span><span class="n">getPLTEntry</span><span class="p">(</span><span class="k">const</span> <span class="n">Atom</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">_pltMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">plt</span> <span class="o">!=</span> <span class="n">_pltMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
      <span class="k">return</span> <span class="n">plt</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">ga</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got.plt&quot;</span><span class="p">);</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_JUMP_SLOT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">pa</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0PLTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.plt&quot;</span><span class="p">);</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ga</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">);</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">LLD_R_CPU0_GOTRELINDEX</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">ga</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">getPLT0</span><span class="p">(),</span> <span class="o">-</span><span class="mi">4</span><span class="p">);</span>
    <span class="c1">// Set the starting address of the got entry to the second instruction in</span>
    <span class="c1">// the plt entry.</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got_&quot;</span><span class="p">;</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__plt_&quot;</span><span class="p">;</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
<span class="cp">#endif</span>
    <span class="n">_gotMap</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">ga</span><span class="p">;</span>
    <span class="n">_pltMap</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
    <span class="n">_gotVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ga</span><span class="p">);</span>
    <span class="n">_pltVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pa</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">pa</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">handlePLT32</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Turn this into a PC24 to the PLT entry.</span>
    <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setKind</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">);</span>
    <span class="c1">// Handle IFUNC.</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">*</span><span class="n">da</span> <span class="o">=</span> 
            <span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">da</span><span class="o">-&gt;</span><span class="n">contentType</span><span class="p">()</span> <span class="o">==</span> <span class="n">DefinedAtom</span><span class="o">::</span><span class="n">typeResolver</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">handleIFUNC</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">SharedLibraryAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getPLTEntry</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()));</span>
    <span class="k">return</span> <span class="n">error_code</span><span class="o">::</span><span class="n">success</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">handlePC24</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">isa</span><span class="o">&lt;</span><span class="n">SharedLibraryAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">return</span> <span class="n">handlePLT32</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">handleIFUNC</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">GOTAtom</span> <span class="o">*</span><span class="n">getSharedGOT</span><span class="p">(</span><span class="k">const</span> <span class="n">SharedLibraryAtom</span> <span class="o">*</span><span class="n">sla</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">got</span> <span class="o">=</span> <span class="n">_gotMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">sla</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">got</span> <span class="o">==</span> <span class="n">_gotMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">auto</span> <span class="n">g</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got.dyn&quot;</span><span class="p">);</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_GLOB_DAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sla</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got_&quot;</span><span class="p">;</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">sla</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
<span class="cp">#endif</span>
      <span class="n">_gotMap</span><span class="p">[</span><span class="n">sla</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
      <span class="n">_gotVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">g</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">got</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">handleGOTPCREL</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setKind</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">UndefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getNullGOT</span><span class="p">());</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">*</span><span class="n">da</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getGOT</span><span class="p">(</span><span class="n">da</span><span class="p">));</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="n">sla</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">SharedLibraryAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getSharedGOT</span><span class="p">(</span><span class="n">sla</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="p">}</span> <span class="c1">// end anon namespace</span>

<span class="kt">void</span> <span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span><span class="o">::</span><span class="n">addPasses</span><span class="p">(</span><span class="n">PassManager</span> <span class="o">&amp;</span><span class="n">pm</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">_outputFileType</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="nl">ET_EXEC:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_isStaticExecutable</span><span class="p">)</span>
      <span class="n">pm</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Pass</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">StaticGOTPLTPass</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)));</span>
    <span class="k">else</span>
      <span class="n">pm</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Pass</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">DynamicGOTPLTPass</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)));</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="nl">ET_DYN:</span>
    <span class="n">pm</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Pass</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">DynamicGOTPLTPass</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)));</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="nl">ET_REL:</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">default</span><span class="o">:</span>
    <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;Unhandled output file type&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">ELFLinkingContext</span><span class="o">::</span><span class="n">addPasses</span><span class="p">(</span><span class="n">pm</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#define LLD_CASE(name) .Case(#name, llvm::ELF::name)</span>

<span class="n">ErrorOr</span><span class="o">&lt;</span><span class="n">Reference</span><span class="o">::</span><span class="n">Kind</span><span class="o">&gt;</span>
<span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span><span class="o">::</span><span class="n">relocKindFromString</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">str</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">int32_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">llvm</span><span class="o">::</span><span class="n">StringSwitch</span><span class="o">&lt;</span><span class="n">int32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_NONE</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_32</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_HI16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_LO16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_GPREL16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_LITERAL</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_GOT16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_CALL24</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;LLD_R_CPU0_GOTRELINDEX&quot;</span><span class="p">,</span> <span class="n">LLD_R_CPU0_GOTRELINDEX</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Default</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">make_error_code</span><span class="p">(</span><span class="n">yaml_reader_error</span><span class="o">::</span><span class="n">illegal_value</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#undef LLD_CASE</span>

<span class="cp">#define LLD_CASE(name) case llvm::ELF::name: return std::string(#name);</span>

<span class="n">ErrorOr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span>
<span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span><span class="o">::</span><span class="n">stringFromRelocKind</span><span class="p">(</span><span class="n">Reference</span><span class="o">::</span><span class="n">Kind</span> <span class="n">kind</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_NONE</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_32</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_HI16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_LO16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_GPREL16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_LITERAL</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_GOT16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_CALL24</span><span class="p">)</span>
  <span class="k">case</span> <span class="nl">LLD_R_CPU0_GOTRELINDEX:</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;LLD_R_CPU0_GOTRELINDEX&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">make_error_code</span><span class="p">(</span><span class="n">yaml_reader_error</span><span class="o">::</span><span class="n">illegal_value</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">LLVMBackendTutorialExampleCode/Cpu0_lld_20130816/Cpu0/Cpu0RelocationHandler.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===- lib/ReaderWriter/ELF/Cpu0/Cpu0RelocationHandler.h</span>
<span class="c1">//------------------===//</span>
<span class="c1">//</span>
<span class="c1">//                             The LLVM Linker</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef Cpu0_RELOCATION_HANDLER_H</span>
<span class="cp">#define Cpu0_RELOCATION_HANDLER_H</span>

<span class="cp">#include &quot;Cpu0TargetHandler.h&quot;</span>

<span class="k">namespace</span> <span class="n">lld</span> <span class="p">{</span>
<span class="k">namespace</span> <span class="n">elf</span> <span class="p">{</span>
<span class="k">typedef</span> <span class="n">llvm</span><span class="o">::</span><span class="n">object</span><span class="o">::</span><span class="n">ELFType</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">big</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="kc">false</span><span class="o">&gt;</span> <span class="n">Cpu0ELFType</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">Cpu0LinkingContext</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0TargetRelocationHandler</span> <span class="n">LLVM_FINAL</span>
    <span class="o">:</span> <span class="k">public</span> <span class="n">TargetRelocationHandler</span><span class="o">&lt;</span><span class="n">Cpu0ELFType</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0TargetRelocationHandler</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0LinkingContext</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">_tlsSize</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">virtual</span> <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">applyRelocation</span><span class="p">(</span><span class="n">ELFWriter</span> <span class="o">&amp;</span><span class="p">,</span> <span class="n">llvm</span><span class="o">::</span><span class="n">FileOutputBuffer</span> <span class="o">&amp;</span><span class="p">,</span>
                                        <span class="k">const</span> <span class="n">lld</span><span class="o">::</span><span class="n">AtomLayout</span> <span class="o">&amp;</span><span class="p">,</span>
                                        <span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

  <span class="k">virtual</span> <span class="n">int64_t</span> <span class="n">relocAddend</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
  <span class="c1">// Cached size of the TLS segment.</span>
  <span class="k">mutable</span> <span class="n">uint64_t</span> <span class="n">_tlsSize</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">Cpu0LinkingContext</span> <span class="o">&amp;</span><span class="n">_context</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">}</span> <span class="c1">// end namespace elf</span>
<span class="p">}</span> <span class="c1">// end namespace lld</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">LLVMBackendTutorialExampleCode/Cpu0_lld_20130816/Cpu0/Cpu0RelocationHandler.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===- lib/ReaderWriter/ELF/Cpu0/Cpu0RelocationHandler.cpp ------------===//</span>
<span class="c1">//</span>
<span class="c1">//                             The LLVM Linker</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0TargetHandler.h&quot;</span>
<span class="cp">#include &quot;Cpu0LinkingContext.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">lld</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">elf</span><span class="p">;</span>

<span class="k">namespace</span> <span class="p">{</span>
<span class="c1">/// \brief R_CPU0_HI16 - word64: (S + A) &gt;&gt; 16</span>
<span class="kt">void</span> <span class="n">relocHI16</span><span class="p">(</span><span class="n">uint8_t</span> <span class="o">*</span><span class="n">location</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">P</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">S</span><span class="p">,</span> <span class="n">int64_t</span> <span class="n">A</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">//  uint32_t result = (uint32_t)((S + A) &gt;&gt; 16); // Don&#39;t know why ref.addend() = 9</span>
  <span class="n">uint32_t</span> <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint32_t</span><span class="p">)(</span><span class="n">S</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
  <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">=</span>
      <span class="n">result</span> <span class="o">|</span>
      <span class="p">(</span><span class="n">uint32_t</span><span class="p">)</span> <span class="o">*</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">location</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">relocLO16</span><span class="p">(</span><span class="n">uint8_t</span> <span class="o">*</span><span class="n">location</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">P</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">S</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">A</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">//  uint32_t result = (uint32_t)((S + A) &amp; 0x0000ffff);</span>
  <span class="n">uint32_t</span> <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint32_t</span><span class="p">)(</span><span class="n">S</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">);</span>
  <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">=</span>
      <span class="n">result</span> <span class="o">|</span>
      <span class="p">(</span><span class="n">uint32_t</span><span class="p">)</span> <span class="o">*</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">location</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">/// \brief R_CPU0_PC24 - word32: S + A - P</span>
<span class="kt">void</span> <span class="n">relocPC24</span><span class="p">(</span><span class="n">uint8_t</span> <span class="o">*</span><span class="n">location</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">P</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">S</span><span class="p">,</span> <span class="n">int64_t</span> <span class="n">A</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">//  uint32_t result = (uint32_t)((S + A) - P);</span>
  <span class="n">uint32_t</span> <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint32_t</span><span class="p">)(</span><span class="n">S</span>  <span class="o">-</span> <span class="n">P</span><span class="p">);</span>
  <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">=</span>
      <span class="n">result</span> <span class="o">+</span>
      <span class="p">(</span><span class="n">uint32_t</span><span class="p">)</span> <span class="o">*</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">location</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">/// \brief R_CPU0_32 - word32:  S + A</span>
<span class="kt">void</span> <span class="n">reloc32</span><span class="p">(</span><span class="n">uint8_t</span> <span class="o">*</span><span class="n">location</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">P</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">S</span><span class="p">,</span> <span class="n">int64_t</span> <span class="n">A</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">//  int32_t result = (uint32_t)(S + A);</span>
  <span class="n">int32_t</span> <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint32_t</span><span class="p">)(</span><span class="n">S</span><span class="p">);</span>
  <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">=</span>
      <span class="n">result</span> <span class="o">|</span>
      <span class="p">(</span><span class="n">uint32_t</span><span class="p">)</span> <span class="o">*</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">location</span><span class="p">);</span>
  <span class="c1">// TODO: Make sure that the result zero extends to the 64bit value.</span>
<span class="p">}</span>

<span class="p">}</span> <span class="c1">// end anon namespace</span>

<span class="n">int64_t</span> <span class="n">Cpu0TargetRelocationHandler</span><span class="o">::</span><span class="n">relocAddend</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">kind</span><span class="p">())</span> <span class="p">{</span>
  <span class="k">case</span> <span class="nl">R_CPU0_PC24:</span>
    <span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
  <span class="k">default</span><span class="o">:</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">Cpu0TargetRelocationHandler</span><span class="o">::</span><span class="n">applyRelocation</span><span class="p">(</span>
    <span class="n">ELFWriter</span> <span class="o">&amp;</span><span class="n">writer</span><span class="p">,</span> <span class="n">llvm</span><span class="o">::</span><span class="n">FileOutputBuffer</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="n">lld</span><span class="o">::</span><span class="n">AtomLayout</span> <span class="o">&amp;</span><span class="n">atom</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">uint8_t</span> <span class="o">*</span><span class="n">atomContent</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="n">getBufferStart</span><span class="p">()</span> <span class="o">+</span> <span class="n">atom</span><span class="p">.</span><span class="n">_fileOffset</span><span class="p">;</span>
  <span class="n">uint8_t</span> <span class="o">*</span><span class="n">location</span> <span class="o">=</span> <span class="n">atomContent</span> <span class="o">+</span> <span class="n">ref</span><span class="p">.</span><span class="n">offsetInAtom</span><span class="p">();</span>
  <span class="n">uint64_t</span> <span class="n">targetVAddress</span> <span class="o">=</span> <span class="n">writer</span><span class="p">.</span><span class="n">addressOfAtom</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">());</span>
  <span class="n">uint64_t</span> <span class="n">relocVAddress</span> <span class="o">=</span> <span class="n">atom</span><span class="p">.</span><span class="n">_virtualAddr</span> <span class="o">+</span> <span class="n">ref</span><span class="p">.</span><span class="n">offsetInAtom</span><span class="p">();</span>

  <span class="k">switch</span> <span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">kind</span><span class="p">())</span> <span class="p">{</span>
  <span class="k">case</span> <span class="nl">R_CPU0_NONE:</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">R_CPU0_HI16:</span>
    <span class="n">relocHI16</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">relocVAddress</span><span class="p">,</span> <span class="n">targetVAddress</span><span class="p">,</span> <span class="n">ref</span><span class="p">.</span><span class="n">addend</span><span class="p">());</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">R_CPU0_LO16:</span>
    <span class="n">relocLO16</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">relocVAddress</span><span class="p">,</span> <span class="n">targetVAddress</span><span class="p">,</span> <span class="n">ref</span><span class="p">.</span><span class="n">addend</span><span class="p">());</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">R_CPU0_PC24:</span>
    <span class="n">relocPC24</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">relocVAddress</span><span class="p">,</span> <span class="n">targetVAddress</span><span class="p">,</span> <span class="n">ref</span><span class="p">.</span><span class="n">addend</span><span class="p">());</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">R_CPU0_32:</span>
    <span class="n">reloc32</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">relocVAddress</span><span class="p">,</span> <span class="n">targetVAddress</span><span class="p">,</span> <span class="n">ref</span><span class="p">.</span><span class="n">addend</span><span class="p">());</span>
    <span class="k">break</span><span class="p">;</span>

  <span class="k">case</span> <span class="n">lld</span><span class="o">::</span><span class="n">Reference</span><span class="o">::</span><span class="nl">kindLayoutAfter:</span>
  <span class="k">case</span> <span class="n">lld</span><span class="o">::</span><span class="n">Reference</span><span class="o">::</span><span class="nl">kindLayoutBefore:</span>
  <span class="k">case</span> <span class="n">lld</span><span class="o">::</span><span class="n">Reference</span><span class="o">::</span><span class="nl">kindInGroup:</span>
    <span class="k">break</span><span class="p">;</span>

  <span class="k">default</span><span class="o">:</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">str</span><span class="p">;</span>
    <span class="n">llvm</span><span class="o">::</span><span class="n">raw_string_ostream</span> <span class="n">s</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">name</span> <span class="o">=</span> <span class="n">_context</span><span class="p">.</span><span class="n">stringFromRelocKind</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">kind</span><span class="p">());</span>
    <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Unhandled relocation: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">atom</span><span class="p">.</span><span class="n">_atom</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">().</span><span class="n">path</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:&quot;</span>
      <span class="o">&lt;&lt;</span> <span class="n">atom</span><span class="p">.</span><span class="n">_atom</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;@&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ref</span><span class="p">.</span><span class="n">offsetInAtom</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span>
      <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">name</span> <span class="o">?</span> <span class="o">*</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;&lt;unknown&gt;&quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; (&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ref</span><span class="p">.</span><span class="n">kind</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;)&quot;</span><span class="p">;</span>
    <span class="n">s</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>
    <span class="n">llvm_unreachable</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">error_code</span><span class="o">::</span><span class="n">success</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">LLVMBackendTutorialExampleCode/Cpu0_lld_20130816/Cpu0/Cpu0LinkingContext.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===- lib/ReaderWriter/ELF/Cpu0/Cpu0LinkingContext.cpp -------------------===//</span>
<span class="c1">//</span>
<span class="c1">//                             The LLVM Linker</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Atoms.h&quot;</span>
<span class="cp">#include &quot;Cpu0LinkingContext.h&quot;</span>

<span class="cp">#include &quot;lld/Core/File.h&quot;</span>
<span class="cp">#include &quot;lld/Core/Instrumentation.h&quot;</span>
<span class="cp">#include &quot;lld/Core/Parallel.h&quot;</span>
<span class="cp">#include &quot;lld/Core/Pass.h&quot;</span>
<span class="cp">#include &quot;lld/Core/PassManager.h&quot;</span>
<span class="cp">#include &quot;lld/ReaderWriter/Simple.h&quot;</span>

<span class="cp">#include &quot;llvm/ADT/ArrayRef.h&quot;</span>
<span class="cp">#include &quot;llvm/ADT/DenseMap.h&quot;</span>
<span class="cp">#include &quot;llvm/ADT/StringSwitch.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">lld</span><span class="p">;</span>
<span class="cp">#if 1</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">lld</span><span class="o">::</span><span class="n">elf</span><span class="p">;</span>

<span class="k">namespace</span> <span class="p">{</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="p">;</span>

<span class="c1">// .got values</span>
<span class="k">const</span> <span class="n">uint8_t</span> <span class="n">cpu0GotAtomContent</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

<span class="c1">// .plt value (entry 0)</span>
<span class="k">const</span> <span class="n">uint8_t</span> <span class="n">cpu0Plt0AtomContent</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// pushq GOT+8(%rip)</span>
  <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// jmp *GOT+16(%rip)</span>
  <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x90</span>              <span class="c1">// nopnopnop</span>
<span class="p">};</span>

<span class="c1">// .plt values (other entries)</span>
<span class="k">const</span> <span class="n">uint8_t</span> <span class="n">cpu0PltAtomContent</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// jmpq *gotatom(%rip)</span>
  <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>       <span class="c1">// pushq reloc-index</span>
  <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>        <span class="c1">// jmpq plt[-1]</span>
<span class="p">};</span>

<span class="c1">/// \brief Atoms that are used by Cpu0 dynamic linking</span>
<span class="k">class</span> <span class="nc">Cpu0GOTAtom</span> <span class="o">:</span> <span class="k">public</span> <span class="n">GOTAtom</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="k">const</span> <span class="n">File</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">secName</span><span class="p">)</span> <span class="o">:</span> <span class="n">GOTAtom</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">secName</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">virtual</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span> <span class="n">rawContent</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cpu0GotAtomContent</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Cpu0PLT0Atom</span> <span class="o">:</span> <span class="k">public</span> <span class="n">PLT0Atom</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0PLT0Atom</span><span class="p">(</span><span class="k">const</span> <span class="n">File</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">)</span> <span class="o">:</span> <span class="n">PLT0Atom</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;.PLT0&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>
  <span class="k">virtual</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span> <span class="n">rawContent</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cpu0Plt0AtomContent</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Cpu0PLTAtom</span> <span class="o">:</span> <span class="k">public</span> <span class="n">PLTAtom</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0PLTAtom</span><span class="p">(</span><span class="k">const</span> <span class="n">File</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">secName</span><span class="p">)</span> <span class="o">:</span> <span class="n">PLTAtom</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">secName</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">virtual</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span> <span class="n">rawContent</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cpu0PltAtomContent</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">ELFPassFile</span> <span class="o">:</span> <span class="k">public</span> <span class="n">SimpleFile</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">ELFPassFile</span><span class="p">(</span><span class="k">const</span> <span class="n">ELFLinkingContext</span> <span class="o">&amp;</span><span class="n">eti</span><span class="p">)</span> <span class="o">:</span> <span class="n">SimpleFile</span><span class="p">(</span><span class="n">eti</span><span class="p">,</span> <span class="s">&quot;ELFPassFile&quot;</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">llvm</span><span class="o">::</span><span class="n">BumpPtrAllocator</span> <span class="n">_alloc</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">/// \brief Create GOT and PLT entries for relocations. Handles standard GOT/PLT</span>
<span class="c1">/// along with IFUNC and TLS.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Derived</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">GOTPLTPass</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Pass</span> <span class="p">{</span>
  <span class="c1">/// \brief Handle a specific reference.</span>
  <span class="kt">void</span> <span class="n">handleReference</span><span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">&amp;</span><span class="n">atom</span><span class="p">,</span> <span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">kind</span><span class="p">())</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">    case R_CPU0_PLT32:</span>
<span class="c">      static_cast&lt;Derived *&gt;(this)-&gt;handlePLT32(ref);</span>
<span class="c">      break;</span>
<span class="cp">#endif</span>
    <span class="k">case</span> <span class="nl">R_CPU0_PC24:</span>
      <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Derived</span> <span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">handlePC24</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">    case R_CPU0_GOTTPOFF: // GOT Thread Pointer Offset</span>
<span class="c">      static_cast&lt;Derived *&gt;(this)-&gt;handleGOTTPOFF(ref);</span>
<span class="c">      break;</span>
<span class="c">    case R_CPU0_GOTPCREL:</span>
<span class="c">      static_cast&lt;Derived *&gt;(this)-&gt;handleGOTPCREL(ref);</span>
<span class="c">      break;</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="k">protected</span><span class="o">:</span>
  <span class="c1">/// \brief get the PLT entry for a given IFUNC Atom.</span>
  <span class="c1">///</span>
  <span class="c1">/// If the entry does not exist. Both the GOT and PLT entry is created.</span>
  <span class="k">const</span> <span class="n">PLTAtom</span> <span class="o">*</span><span class="n">getIFUNCPLTEntry</span><span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">*</span><span class="n">da</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">_pltMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">da</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">plt</span> <span class="o">!=</span> <span class="n">_pltMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
      <span class="k">return</span> <span class="n">plt</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">ga</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got.plt&quot;</span><span class="p">);</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_RELGOT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">pa</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0PLTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.plt&quot;</span><span class="p">);</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ga</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got_ifunc_&quot;</span><span class="p">;</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">da</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__plt_ifunc_&quot;</span><span class="p">;</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">da</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
<span class="cp">#endif</span>
    <span class="n">_gotMap</span><span class="p">[</span><span class="n">da</span><span class="p">]</span> <span class="o">=</span> <span class="n">ga</span><span class="p">;</span>
    <span class="n">_pltMap</span><span class="p">[</span><span class="n">da</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
    <span class="n">_gotVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ga</span><span class="p">);</span>
    <span class="n">_pltVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pa</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">pa</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">/// \brief Redirect the call to the PLT stub for the target IFUNC.</span>
  <span class="c1">///</span>
  <span class="c1">/// This create a PLT and GOT entry for the IFUNC if one does not exist. The</span>
  <span class="c1">/// GOT entry and a RELGOT relocation to the original target resolver.</span>
  <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">handleIFUNC</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">target</span> <span class="o">=</span> <span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">&amp;&amp;</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">contentType</span><span class="p">()</span> <span class="o">==</span> <span class="n">DefinedAtom</span><span class="o">::</span><span class="n">typeResolver</span><span class="p">)</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getIFUNCPLTEntry</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">error_code</span><span class="o">::</span><span class="n">success</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">/// \brief Create a GOT entry for the TP offset of a TLS atom.</span>
  <span class="k">const</span> <span class="n">GOTAtom</span> <span class="o">*</span><span class="n">getGOTTPOFF</span><span class="p">(</span><span class="k">const</span> <span class="n">Atom</span> <span class="o">*</span><span class="n">atom</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">got</span> <span class="o">=</span> <span class="n">_gotMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">atom</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">got</span> <span class="o">==</span> <span class="n">_gotMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">auto</span> <span class="n">g</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got&quot;</span><span class="p">);</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_TLS_TPREL32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got_tls_&quot;</span><span class="p">;</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">atom</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
<span class="cp">#endif</span>
      <span class="n">_gotMap</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
      <span class="n">_gotVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">g</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">got</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">/// \brief Create a TLS_TPREL32 GOT entry and change the relocation to a PC24 to</span>
  <span class="c1">/// the GOT.</span>
  <span class="kt">void</span> <span class="n">handleGOTTPOFF</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getGOTTPOFF</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()));</span>
    <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setKind</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">/// \brief Create a GOT entry containing 0.</span>
  <span class="k">const</span> <span class="n">GOTAtom</span> <span class="o">*</span><span class="n">getNullGOT</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_null</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got.plt&quot;</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
      <span class="n">_null</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got_null&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">GOTAtom</span> <span class="o">*</span><span class="n">getGOT</span><span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">*</span><span class="n">da</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">got</span> <span class="o">=</span> <span class="n">_gotMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">da</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">got</span> <span class="o">==</span> <span class="n">_gotMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">auto</span> <span class="n">g</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got&quot;</span><span class="p">);</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got_&quot;</span><span class="p">;</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">da</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
<span class="cp">#endif</span>
      <span class="n">_gotMap</span><span class="p">[</span><span class="n">da</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
      <span class="n">_gotVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">g</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">got</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">/// \brief Handle a GOTPCREL relocation to an undefined weak atom by using a</span>
  <span class="c1">/// null GOT entry.</span>
  <span class="kt">void</span> <span class="n">handleGOTPCREL</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setKind</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">UndefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getNullGOT</span><span class="p">());</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">*</span><span class="n">da</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getGOT</span><span class="p">(</span><span class="n">da</span><span class="p">));</span>
  <span class="p">}</span>

<span class="k">public</span><span class="o">:</span>
  <span class="n">GOTPLTPass</span><span class="p">(</span><span class="k">const</span> <span class="n">ELFLinkingContext</span> <span class="o">&amp;</span><span class="n">ti</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">_file</span><span class="p">(</span><span class="n">ti</span><span class="p">),</span> <span class="n">_null</span><span class="p">(</span><span class="n">nullptr</span><span class="p">),</span> <span class="n">_PLT0</span><span class="p">(</span><span class="n">nullptr</span><span class="p">),</span> <span class="n">_got0</span><span class="p">(</span><span class="n">nullptr</span><span class="p">),</span>
        <span class="n">_got1</span><span class="p">(</span><span class="n">nullptr</span><span class="p">)</span> <span class="p">{}</span>

  <span class="c1">/// \brief Do the pass.</span>
  <span class="c1">///</span>
  <span class="c1">/// The goal here is to first process each reference individually. Each call</span>
  <span class="c1">/// to handleReference may modify the reference itself and/or create new</span>
  <span class="c1">/// atoms which must be stored in one of the maps below.</span>
  <span class="c1">///</span>
  <span class="c1">/// After all references are handled, the atoms created during that are all</span>
  <span class="c1">/// added to mf.</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">perform</span><span class="p">(</span><span class="n">MutableFile</span> <span class="o">&amp;</span><span class="n">mf</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ScopedTask</span> <span class="n">task</span><span class="p">(</span><span class="n">getDefaultDomain</span><span class="p">(),</span> <span class="s">&quot;Cpu0 GOT/PLT Pass&quot;</span><span class="p">);</span>
    <span class="c1">// Process all references.</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="n">atom</span> <span class="o">:</span> <span class="n">mf</span><span class="p">.</span><span class="n">defined</span><span class="p">())</span>
      <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="n">ref</span> <span class="o">:</span> <span class="o">*</span><span class="n">atom</span><span class="p">)</span>
        <span class="n">handleReference</span><span class="p">(</span><span class="o">*</span><span class="n">atom</span><span class="p">,</span> <span class="o">*</span><span class="n">ref</span><span class="p">);</span>

    <span class="c1">// Add all created atoms to the link.</span>
    <span class="n">uint64_t</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_PLT0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_PLT0</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">ordinal</span><span class="o">++</span><span class="p">);</span>
      <span class="n">mf</span><span class="p">.</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">_PLT0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">plt</span> <span class="o">:</span> <span class="n">_pltVector</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">plt</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">ordinal</span><span class="o">++</span><span class="p">);</span>
      <span class="n">mf</span><span class="p">.</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">plt</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_null</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">ordinal</span><span class="o">++</span><span class="p">);</span>
      <span class="n">mf</span><span class="p">.</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">_null</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_PLT0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_got0</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">ordinal</span><span class="o">++</span><span class="p">);</span>
      <span class="n">_got1</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">ordinal</span><span class="o">++</span><span class="p">);</span>
      <span class="n">mf</span><span class="p">.</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">_got0</span><span class="p">);</span>
      <span class="n">mf</span><span class="p">.</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">_got1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">got</span> <span class="o">:</span> <span class="n">_gotVector</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">got</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">ordinal</span><span class="o">++</span><span class="p">);</span>
      <span class="n">mf</span><span class="p">.</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">got</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="k">protected</span><span class="o">:</span>
  <span class="c1">/// \brief Owner of all the Atoms created by this pass.</span>
  <span class="n">ELFPassFile</span> <span class="n">_file</span><span class="p">;</span>

  <span class="c1">/// \brief Map Atoms to their GOT entries.</span>
  <span class="n">llvm</span><span class="o">::</span><span class="n">DenseMap</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Atom</span> <span class="o">*</span><span class="p">,</span> <span class="n">GOTAtom</span> <span class="o">*&gt;</span> <span class="n">_gotMap</span><span class="p">;</span>

  <span class="c1">/// \brief Map Atoms to their PLT entries.</span>
  <span class="n">llvm</span><span class="o">::</span><span class="n">DenseMap</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Atom</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLTAtom</span> <span class="o">*&gt;</span> <span class="n">_pltMap</span><span class="p">;</span>

  <span class="c1">/// \brief the list of GOT/PLT atoms</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">GOTAtom</span> <span class="o">*&gt;</span> <span class="n">_gotVector</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PLTAtom</span> <span class="o">*&gt;</span> <span class="n">_pltVector</span><span class="p">;</span>

  <span class="c1">/// \brief GOT entry that is always 0. Used for undefined weaks.</span>
  <span class="n">GOTAtom</span> <span class="o">*</span><span class="n">_null</span><span class="p">;</span>

  <span class="c1">/// \brief The got and plt entries for .PLT0. This is used to call into the</span>
  <span class="c1">/// dynamic linker for symbol resolution.</span>
  <span class="c1">/// @{</span>
  <span class="n">PLT0Atom</span> <span class="o">*</span><span class="n">_PLT0</span><span class="p">;</span>
  <span class="n">GOTAtom</span> <span class="o">*</span><span class="n">_got0</span><span class="p">;</span>
  <span class="n">GOTAtom</span> <span class="o">*</span><span class="n">_got1</span><span class="p">;</span>
  <span class="c1">/// @}</span>
<span class="p">};</span>

<span class="c1">/// This implements the static relocation model. Meaning GOT and PLT entries are</span>
<span class="c1">/// not created for references that can be directly resolved. These are</span>
<span class="c1">/// converted to a direct relocation. For entries that do require a GOT or PLT</span>
<span class="c1">/// entry, that entry is statically bound.</span>
<span class="c1">///</span>
<span class="c1">/// TLS always assumes module 1 and attempts to remove indirection.</span>
<span class="k">class</span> <span class="nc">StaticGOTPLTPass</span> <span class="n">LLVM_FINAL</span> <span class="o">:</span> <span class="k">public</span> <span class="n">GOTPLTPass</span><span class="o">&lt;</span><span class="n">StaticGOTPLTPass</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">StaticGOTPLTPass</span><span class="p">(</span><span class="k">const</span> <span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span> <span class="o">&amp;</span><span class="n">ti</span><span class="p">)</span> <span class="o">:</span> <span class="n">GOTPLTPass</span><span class="p">(</span><span class="n">ti</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">handlePLT32</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// __tls_get_addr is handled elsewhere.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;__tls_get_addr&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setKind</span><span class="p">(</span><span class="n">R_CPU0_NONE</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">error_code</span><span class="o">::</span><span class="n">success</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span>
      <span class="c1">// Static code doesn&#39;t need PLTs.</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setKind</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">);</span>
    <span class="c1">// Handle IFUNC.</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">*</span><span class="n">da</span> <span class="o">=</span>
            <span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">da</span><span class="o">-&gt;</span><span class="n">contentType</span><span class="p">()</span> <span class="o">==</span> <span class="n">DefinedAtom</span><span class="o">::</span><span class="n">typeResolver</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">handleIFUNC</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">error_code</span><span class="o">::</span><span class="n">success</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">handlePC24</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">handleIFUNC</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">DynamicGOTPLTPass</span> <span class="n">LLVM_FINAL</span> <span class="o">:</span> <span class="k">public</span> <span class="n">GOTPLTPass</span><span class="o">&lt;</span><span class="n">DynamicGOTPLTPass</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">DynamicGOTPLTPass</span><span class="p">(</span><span class="k">const</span> <span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span> <span class="o">&amp;</span><span class="n">ti</span><span class="p">)</span> <span class="o">:</span> <span class="n">GOTPLTPass</span><span class="p">(</span><span class="n">ti</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">const</span> <span class="n">PLT0Atom</span> <span class="o">*</span><span class="n">getPLT0</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_PLT0</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">_PLT0</span><span class="p">;</span>
    <span class="c1">// Fill in the null entry.</span>
    <span class="n">getNullGOT</span><span class="p">();</span>
    <span class="n">_PLT0</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0PLT0Atom</span><span class="p">(</span><span class="n">_file</span><span class="p">);</span>
    <span class="n">_got0</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got.plt&quot;</span><span class="p">);</span>
    <span class="n">_got1</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got.plt&quot;</span><span class="p">);</span>
    <span class="n">_PLT0</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">_got0</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">);</span>
    <span class="n">_PLT0</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">_got1</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="n">_got0</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got0&quot;</span><span class="p">;</span>
    <span class="n">_got1</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got1&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="k">return</span> <span class="n">_PLT0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">PLTAtom</span> <span class="o">*</span><span class="n">getPLTEntry</span><span class="p">(</span><span class="k">const</span> <span class="n">Atom</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">_pltMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">plt</span> <span class="o">!=</span> <span class="n">_pltMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
      <span class="k">return</span> <span class="n">plt</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">ga</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got.plt&quot;</span><span class="p">);</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_JUMP_SLOT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">pa</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0PLTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.plt&quot;</span><span class="p">);</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ga</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">);</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">LLD_R_CPU0_GOTRELINDEX</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">ga</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">getPLT0</span><span class="p">(),</span> <span class="o">-</span><span class="mi">4</span><span class="p">);</span>
    <span class="c1">// Set the starting address of the got entry to the second instruction in</span>
    <span class="c1">// the plt entry.</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got_&quot;</span><span class="p">;</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__plt_&quot;</span><span class="p">;</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
<span class="cp">#endif</span>
    <span class="n">_gotMap</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">ga</span><span class="p">;</span>
    <span class="n">_pltMap</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
    <span class="n">_gotVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ga</span><span class="p">);</span>
    <span class="n">_pltVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pa</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">pa</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">handlePLT32</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Turn this into a PC24 to the PLT entry.</span>
    <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setKind</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">);</span>
    <span class="c1">// Handle IFUNC.</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">*</span><span class="n">da</span> <span class="o">=</span> 
            <span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">da</span><span class="o">-&gt;</span><span class="n">contentType</span><span class="p">()</span> <span class="o">==</span> <span class="n">DefinedAtom</span><span class="o">::</span><span class="n">typeResolver</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">handleIFUNC</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">SharedLibraryAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getPLTEntry</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()));</span>
    <span class="k">return</span> <span class="n">error_code</span><span class="o">::</span><span class="n">success</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">handlePC24</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">isa</span><span class="o">&lt;</span><span class="n">SharedLibraryAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">return</span> <span class="n">handlePLT32</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">handleIFUNC</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">GOTAtom</span> <span class="o">*</span><span class="n">getSharedGOT</span><span class="p">(</span><span class="k">const</span> <span class="n">SharedLibraryAtom</span> <span class="o">*</span><span class="n">sla</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">got</span> <span class="o">=</span> <span class="n">_gotMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">sla</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">got</span> <span class="o">==</span> <span class="n">_gotMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">auto</span> <span class="n">g</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got.dyn&quot;</span><span class="p">);</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_GLOB_DAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sla</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got_&quot;</span><span class="p">;</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">sla</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
<span class="cp">#endif</span>
      <span class="n">_gotMap</span><span class="p">[</span><span class="n">sla</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
      <span class="n">_gotVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">g</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">got</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">handleGOTPCREL</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setKind</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">UndefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getNullGOT</span><span class="p">());</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">*</span><span class="n">da</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getGOT</span><span class="p">(</span><span class="n">da</span><span class="p">));</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="n">sla</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">SharedLibraryAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getSharedGOT</span><span class="p">(</span><span class="n">sla</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="p">}</span> <span class="c1">// end anon namespace</span>

<span class="kt">void</span> <span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span><span class="o">::</span><span class="n">addPasses</span><span class="p">(</span><span class="n">PassManager</span> <span class="o">&amp;</span><span class="n">pm</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">_outputFileType</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="nl">ET_EXEC:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_isStaticExecutable</span><span class="p">)</span>
      <span class="n">pm</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Pass</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">StaticGOTPLTPass</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)));</span>
    <span class="k">else</span>
      <span class="n">pm</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Pass</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">DynamicGOTPLTPass</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)));</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="nl">ET_DYN:</span>
    <span class="n">pm</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Pass</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">DynamicGOTPLTPass</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)));</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="nl">ET_REL:</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">default</span><span class="o">:</span>
    <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;Unhandled output file type&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">ELFLinkingContext</span><span class="o">::</span><span class="n">addPasses</span><span class="p">(</span><span class="n">pm</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#define LLD_CASE(name) .Case(#name, llvm::ELF::name)</span>

<span class="n">ErrorOr</span><span class="o">&lt;</span><span class="n">Reference</span><span class="o">::</span><span class="n">Kind</span><span class="o">&gt;</span>
<span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span><span class="o">::</span><span class="n">relocKindFromString</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">str</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">int32_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">llvm</span><span class="o">::</span><span class="n">StringSwitch</span><span class="o">&lt;</span><span class="n">int32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_NONE</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_32</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_HI16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_LO16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_GPREL16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_LITERAL</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_GOT16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_CALL24</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;LLD_R_CPU0_GOTRELINDEX&quot;</span><span class="p">,</span> <span class="n">LLD_R_CPU0_GOTRELINDEX</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Default</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">make_error_code</span><span class="p">(</span><span class="n">yaml_reader_error</span><span class="o">::</span><span class="n">illegal_value</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#undef LLD_CASE</span>

<span class="cp">#define LLD_CASE(name) case llvm::ELF::name: return std::string(#name);</span>

<span class="n">ErrorOr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span>
<span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span><span class="o">::</span><span class="n">stringFromRelocKind</span><span class="p">(</span><span class="n">Reference</span><span class="o">::</span><span class="n">Kind</span> <span class="n">kind</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_NONE</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_32</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_HI16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_LO16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_GPREL16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_LITERAL</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_GOT16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_CALL24</span><span class="p">)</span>
  <span class="k">case</span> <span class="nl">LLD_R_CPU0_GOTRELINDEX:</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;LLD_R_CPU0_GOTRELINDEX&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">make_error_code</span><span class="p">(</span><span class="n">yaml_reader_error</span><span class="o">::</span><span class="n">illegal_value</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">LLVMBackendTutorialExampleCode/Cpu0_lld_20130816/Cpu0/Cpu0Target.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===- lib/ReaderWriter/ELF/Cpu0/Cpu0Target.h -------------------------===//</span>
<span class="c1">//</span>
<span class="c1">//                             The LLVM Linker</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0LinkingContext.h&quot;</span>
</pre></div>
</div>
<p class="rubric">LLVMBackendTutorialExampleCode/Cpu0_lld_20130816/Cpu0/Cpu0TargetHandler.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===- lib/ReaderWriter/ELF/Cpu0/Cpu0TargetHandler.h ------------------===//</span>
<span class="c1">//</span>
<span class="c1">//                             The LLVM Linker</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef LLD_READER_WRITER_ELF_Cpu0_TARGET_HANDLER_H</span>
<span class="cp">#define LLD_READER_WRITER_ELF_Cpu0_TARGET_HANDLER_H</span>

<span class="cp">#include &quot;DefaultTargetHandler.h&quot;</span>
<span class="cp">#include &quot;Cpu0RelocationHandler.h&quot;</span>
<span class="cp">#include &quot;TargetLayout.h&quot;</span>

<span class="cp">#include &quot;lld/ReaderWriter/Simple.h&quot;</span>

<span class="k">namespace</span> <span class="n">lld</span> <span class="p">{</span>
<span class="k">namespace</span> <span class="n">elf</span> <span class="p">{</span>
<span class="k">typedef</span> <span class="n">llvm</span><span class="o">::</span><span class="n">object</span><span class="o">::</span><span class="n">ELFType</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">big</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="kc">false</span><span class="o">&gt;</span> <span class="n">Cpu0ELFType</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">Cpu0LinkingContext</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0TargetHandler</span> <span class="n">LLVM_FINAL</span>
    <span class="o">:</span> <span class="k">public</span> <span class="n">DefaultTargetHandler</span><span class="o">&lt;</span><span class="n">Cpu0ELFType</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0TargetHandler</span><span class="p">(</span><span class="n">Cpu0LinkingContext</span> <span class="o">&amp;</span><span class="n">targetInfo</span><span class="p">);</span>

  <span class="k">virtual</span> <span class="n">TargetLayout</span><span class="o">&lt;</span><span class="n">Cpu0ELFType</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">targetLayout</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">_targetLayout</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="k">const</span> <span class="n">Cpu0TargetRelocationHandler</span> <span class="o">&amp;</span><span class="n">getRelocationHandler</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">_relocationHandler</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">addFiles</span><span class="p">(</span><span class="n">InputFiles</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>
  <span class="k">class</span> <span class="nc">GOTFile</span> <span class="o">:</span> <span class="k">public</span> <span class="n">SimpleFile</span> <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="n">GOTFile</span><span class="p">(</span><span class="k">const</span> <span class="n">ELFLinkingContext</span> <span class="o">&amp;</span><span class="n">eti</span><span class="p">)</span> <span class="o">:</span> <span class="n">SimpleFile</span><span class="p">(</span><span class="n">eti</span><span class="p">,</span> <span class="s">&quot;GOTFile&quot;</span><span class="p">)</span> <span class="p">{}</span>
    <span class="n">llvm</span><span class="o">::</span><span class="n">BumpPtrAllocator</span> <span class="n">_alloc</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">_gotFile</span><span class="p">;</span>

  <span class="n">Cpu0TargetRelocationHandler</span> <span class="n">_relocationHandler</span><span class="p">;</span>
  <span class="n">TargetLayout</span><span class="o">&lt;</span><span class="n">Cpu0ELFType</span><span class="o">&gt;</span> <span class="n">_targetLayout</span><span class="p">;</span>
<span class="p">};</span>
<span class="p">}</span> <span class="c1">// end namespace elf</span>
<span class="p">}</span> <span class="c1">// end namespace lld</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">LLVMBackendTutorialExampleCode/Cpu0_lld_20130816/Cpu0/Cpu0TargetHandler.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===- lib/ReaderWriter/ELF/Cpu0/Cpu0TargetHandler.cpp ----------------===//</span>
<span class="c1">//</span>
<span class="c1">//                             The LLVM Linker</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Atoms.h&quot;</span>
<span class="cp">#include &quot;Cpu0TargetHandler.h&quot;</span>
<span class="cp">#include &quot;Cpu0LinkingContext.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">lld</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">elf</span><span class="p">;</span>

<span class="n">Cpu0TargetHandler</span><span class="o">::</span><span class="n">Cpu0TargetHandler</span><span class="p">(</span><span class="n">Cpu0LinkingContext</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">DefaultTargetHandler</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="n">_gotFile</span><span class="p">(</span><span class="n">context</span><span class="p">),</span>
      <span class="n">_relocationHandler</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="n">_targetLayout</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="p">{}</span>

<span class="kt">void</span> <span class="n">Cpu0TargetHandler</span><span class="o">::</span><span class="n">addFiles</span><span class="p">(</span><span class="n">InputFiles</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">_gotFile</span><span class="p">.</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="k">new</span> <span class="p">(</span><span class="n">_gotFile</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">GLOBAL_OFFSET_TABLEAtom</span><span class="p">(</span><span class="n">_gotFile</span><span class="p">));</span>
  <span class="n">_gotFile</span><span class="p">.</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="k">new</span> <span class="p">(</span><span class="n">_gotFile</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">TLSGETADDRAtom</span><span class="p">(</span><span class="n">_gotFile</span><span class="p">));</span>
  <span class="n">f</span><span class="p">.</span><span class="n">appendFile</span><span class="p">(</span><span class="n">_gotFile</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="elf-to-hex">
<h2>ELF to Hex<a class="headerlink" href="#elf-to-hex" title="Permalink to this headline">¶</a></h2>
<p>Update llvm-objdump driver to support ELF to Hex for Cpu0 backend as follows,</p>
<p class="rubric">LLVMBackendTutorialExampleCode/llvm-objdump/llvm-objdump.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// llvm-objdump -elf2hex code added begin:</span>
<span class="k">static</span> <span class="n">cl</span><span class="o">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span>
<span class="n">ConvertElf2Hex</span><span class="p">(</span><span class="s">&quot;elf2hex&quot;</span><span class="p">,</span> <span class="n">cl</span><span class="o">::</span><span class="n">desc</span><span class="p">(</span><span class="s">&quot;Display the hex content of verilog cpu0 needed sections&quot;</span><span class="p">));</span>

<span class="k">static</span> <span class="n">uint64_t</span> <span class="n">GetSectionHeaderStartAddress</span><span class="p">(</span><span class="k">const</span> <span class="n">ObjectFile</span> <span class="o">*</span><span class="n">o</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">sectionName</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">//  outs() &lt;&lt; &quot;Sections:\n&quot;</span>
<span class="c1">//            &quot;Idx Name          Size      Address          Type\n&quot;;</span>
  <span class="n">error_code</span> <span class="n">ec</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">section_iterator</span> <span class="n">si</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">begin_sections</span><span class="p">(),</span> <span class="n">se</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">end_sections</span><span class="p">();</span>
                                                  <span class="n">si</span> <span class="o">!=</span> <span class="n">se</span><span class="p">;</span> <span class="n">si</span><span class="p">.</span><span class="n">increment</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">StringRef</span> <span class="n">Name</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(</span><span class="n">Name</span><span class="p">)))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">uint64_t</span> <span class="n">Address</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getAddress</span><span class="p">(</span><span class="n">Address</span><span class="p">)))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">uint64_t</span> <span class="n">Size</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">Text</span><span class="p">,</span> <span class="n">Data</span><span class="p">,</span> <span class="n">BSS</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">isText</span><span class="p">(</span><span class="n">Text</span><span class="p">)))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">isData</span><span class="p">(</span><span class="n">Data</span><span class="p">)))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">isBSS</span><span class="p">(</span><span class="n">BSS</span><span class="p">)))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Name</span> <span class="o">==</span> <span class="n">sectionName</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">Address</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="o">++</span><span class="n">i</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">GetSymbolTableStartAddress</span><span class="p">(</span><span class="k">const</span> <span class="n">ObjectFile</span> <span class="o">*</span><span class="n">o</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">sectionName</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;SYMBOL TABLE:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">COFFObjectFile</span> <span class="o">*</span><span class="n">coff</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">COFFObjectFile</span><span class="o">&gt;</span><span class="p">(</span><span class="n">o</span><span class="p">))</span>
    <span class="n">PrintCOFFSymbolTable</span><span class="p">(</span><span class="n">coff</span><span class="p">);</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">error_code</span> <span class="n">ec</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">symbol_iterator</span> <span class="n">si</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">begin_symbols</span><span class="p">(),</span>
                         <span class="n">se</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">end_symbols</span><span class="p">();</span> <span class="n">si</span> <span class="o">!=</span> <span class="n">se</span><span class="p">;</span> <span class="n">si</span><span class="p">.</span><span class="n">increment</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
      <span class="n">StringRef</span> <span class="n">Name</span><span class="p">;</span>
      <span class="n">uint64_t</span> <span class="n">Address</span><span class="p">;</span>
      <span class="n">SymbolRef</span><span class="o">::</span><span class="n">Type</span> <span class="n">Type</span><span class="p">;</span>
      <span class="n">uint64_t</span> <span class="n">Size</span><span class="p">;</span>
      <span class="n">uint32_t</span> <span class="n">Flags</span><span class="p">;</span>
      <span class="n">section_iterator</span> <span class="n">Section</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">end_sections</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(</span><span class="n">Name</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getAddress</span><span class="p">(</span><span class="n">Address</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getFlags</span><span class="p">(</span><span class="n">Flags</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(</span><span class="n">Type</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getSection</span><span class="p">(</span><span class="n">Section</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>

      <span class="kt">bool</span> <span class="n">Global</span> <span class="o">=</span> <span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">SymbolRef</span><span class="o">::</span><span class="n">SF_Global</span><span class="p">;</span>
      <span class="kt">bool</span> <span class="n">Weak</span> <span class="o">=</span> <span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">SymbolRef</span><span class="o">::</span><span class="n">SF_Weak</span><span class="p">;</span>
      <span class="kt">bool</span> <span class="n">Absolute</span> <span class="o">=</span> <span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">SymbolRef</span><span class="o">::</span><span class="n">SF_Absolute</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">Address</span> <span class="o">==</span> <span class="n">UnknownAddressOrSize</span><span class="p">)</span>
        <span class="n">Address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Size</span> <span class="o">==</span> <span class="n">UnknownAddressOrSize</span><span class="p">)</span>
        <span class="n">Size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kt">char</span> <span class="n">GlobLoc</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Type</span> <span class="o">!=</span> <span class="n">SymbolRef</span><span class="o">::</span><span class="n">ST_Unknown</span><span class="p">)</span>
        <span class="n">GlobLoc</span> <span class="o">=</span> <span class="n">Global</span> <span class="o">?</span> <span class="sc">&#39;g&#39;</span> <span class="o">:</span> <span class="sc">&#39;l&#39;</span><span class="p">;</span>
      <span class="kt">char</span> <span class="n">Debug</span> <span class="o">=</span> <span class="p">(</span><span class="n">Type</span> <span class="o">==</span> <span class="n">SymbolRef</span><span class="o">::</span><span class="n">ST_Debug</span> <span class="o">||</span> <span class="n">Type</span> <span class="o">==</span> <span class="n">SymbolRef</span><span class="o">::</span><span class="n">ST_File</span><span class="p">)</span>
                   <span class="o">?</span> <span class="sc">&#39;d&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
      <span class="kt">char</span> <span class="n">FileFunc</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Type</span> <span class="o">==</span> <span class="n">SymbolRef</span><span class="o">::</span><span class="n">ST_File</span><span class="p">)</span>
        <span class="n">FileFunc</span> <span class="o">=</span> <span class="sc">&#39;f&#39;</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Type</span> <span class="o">==</span> <span class="n">SymbolRef</span><span class="o">::</span><span class="n">ST_Function</span><span class="p">)</span>
        <span class="n">FileFunc</span> <span class="o">=</span> <span class="sc">&#39;F&#39;</span><span class="p">;</span>

      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Fmt</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">getBytesInAddress</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">?</span> <span class="s">&quot;%016&quot;</span> <span class="n">PRIx64</span> <span class="o">:</span>
                                                     <span class="s">&quot;%08&quot;</span> <span class="n">PRIx64</span><span class="p">;</span>

      <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="n">Fmt</span><span class="p">,</span> <span class="n">Address</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span>
             <span class="o">&lt;&lt;</span> <span class="n">GlobLoc</span> <span class="c1">// Local -&gt; &#39;l&#39;, Global -&gt; &#39;g&#39;, Neither -&gt; &#39; &#39;</span>
             <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">Weak</span> <span class="o">?</span> <span class="sc">&#39;w&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="c1">// Weak?</span>
             <span class="o">&lt;&lt;</span> <span class="sc">&#39; &#39;</span> <span class="c1">// Constructor. Not supported yet.</span>
             <span class="o">&lt;&lt;</span> <span class="sc">&#39; &#39;</span> <span class="c1">// Warning. Not supported yet.</span>
             <span class="o">&lt;&lt;</span> <span class="sc">&#39; &#39;</span> <span class="c1">// Indirect reference to another symbol.</span>
             <span class="o">&lt;&lt;</span> <span class="n">Debug</span> <span class="c1">// Debugging (d) or dynamic (D) symbol.</span>
             <span class="o">&lt;&lt;</span> <span class="n">FileFunc</span> <span class="c1">// Name of function (F), file (f) or object (O).</span>
             <span class="o">&lt;&lt;</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Absolute</span><span class="p">)</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*ABS*&quot;</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Section</span> <span class="o">==</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">end_sections</span><span class="p">())</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*UND*&quot;</span><span class="p">;</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">MachOObjectFile</span> <span class="o">*</span><span class="n">MachO</span> <span class="o">=</span>
            <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MachOObjectFile</span><span class="o">&gt;</span><span class="p">(</span><span class="n">o</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">DataRefImpl</span> <span class="n">DR</span> <span class="o">=</span> <span class="n">Section</span><span class="o">-&gt;</span><span class="n">getRawDataRefImpl</span><span class="p">();</span>
          <span class="n">StringRef</span> <span class="n">SegmentName</span> <span class="o">=</span> <span class="n">MachO</span><span class="o">-&gt;</span><span class="n">getSectionFinalSegmentName</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
          <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">SegmentName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">StringRef</span> <span class="n">SectionName</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">Section</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(</span><span class="n">SectionName</span><span class="p">)))</span>
          <span class="n">SectionName</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">SectionName</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\t&#39;</span>
             <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;%08&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">Size</span><span class="p">)</span>
             <span class="o">&lt;&lt;</span> <span class="n">Name</span>
             <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Modified from DisassembleObject()</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">DisassembleObjectForHex</span><span class="p">(</span><span class="k">const</span> <span class="n">ObjectFile</span> <span class="o">*</span><span class="n">Obj</span><span class="cm">/*, bool InlineRelocs*/</span><span class="p">,</span> <span class="n">uint64_t</span><span class="o">&amp;</span> <span class="n">lastAddr</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="n">Target</span> <span class="o">*</span><span class="n">TheTarget</span> <span class="o">=</span> <span class="n">getTarget</span><span class="p">(</span><span class="n">Obj</span><span class="p">);</span>
  <span class="c1">// getTarget() will have already issued a diagnostic if necessary, so</span>
  <span class="c1">// just bail here if it failed.</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TheTarget</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="c1">// Package up features to be passed to target/subtarget</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">FeaturesStr</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">MAttrs</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">SubtargetFeatures</span> <span class="n">Features</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">MAttrs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="n">Features</span><span class="p">.</span><span class="n">AddFeature</span><span class="p">(</span><span class="n">MAttrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">FeaturesStr</span> <span class="o">=</span> <span class="n">Features</span><span class="p">.</span><span class="n">getString</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MCRegisterInfo</span><span class="o">&gt;</span> <span class="n">MRI</span><span class="p">(</span><span class="n">TheTarget</span><span class="o">-&gt;</span><span class="n">createMCRegInfo</span><span class="p">(</span><span class="n">TripleName</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MRI</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;error: no register info for target &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">TripleName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Set up disassembler.</span>
  <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MCAsmInfo</span><span class="o">&gt;</span> <span class="n">AsmInfo</span><span class="p">(</span>
    <span class="n">TheTarget</span><span class="o">-&gt;</span><span class="n">createMCAsmInfo</span><span class="p">(</span><span class="o">*</span><span class="n">MRI</span><span class="p">,</span> <span class="n">TripleName</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AsmInfo</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;error: no assembly info for target &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">TripleName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MCSubtargetInfo</span><span class="o">&gt;</span> <span class="n">STI</span><span class="p">(</span>
    <span class="n">TheTarget</span><span class="o">-&gt;</span><span class="n">createMCSubtargetInfo</span><span class="p">(</span><span class="n">TripleName</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">FeaturesStr</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STI</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;error: no subtarget info for target &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">TripleName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MCInstrInfo</span><span class="o">&gt;</span> <span class="n">MII</span><span class="p">(</span><span class="n">TheTarget</span><span class="o">-&gt;</span><span class="n">createMCInstrInfo</span><span class="p">());</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MII</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;error: no instruction info for target &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">TripleName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="n">MCDisassembler</span><span class="o">&gt;</span> <span class="n">DisAsm</span><span class="p">(</span><span class="n">TheTarget</span><span class="o">-&gt;</span><span class="n">createMCDisassembler</span><span class="p">(</span><span class="o">*</span><span class="n">STI</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DisAsm</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;error: no disassembler for target &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">TripleName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MCObjectFileInfo</span><span class="o">&gt;</span> <span class="n">MOFI</span><span class="p">;</span>
  <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="n">MCContext</span><span class="o">&gt;</span> <span class="n">Ctx</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Symbolize</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">MOFI</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">MCObjectFileInfo</span><span class="p">);</span>
    <span class="n">Ctx</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">MCContext</span><span class="p">(</span><span class="n">AsmInfo</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">MRI</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">MOFI</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
    <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="n">MCRelocationInfo</span><span class="o">&gt;</span> <span class="n">RelInfo</span><span class="p">(</span>
      <span class="n">TheTarget</span><span class="o">-&gt;</span><span class="n">createMCRelocationInfo</span><span class="p">(</span><span class="n">TripleName</span><span class="p">,</span> <span class="o">*</span><span class="n">Ctx</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">RelInfo</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="n">MCSymbolizer</span><span class="o">&gt;</span> <span class="n">Symzer</span><span class="p">(</span>
        <span class="n">MCObjectSymbolizer</span><span class="o">::</span><span class="n">createObjectSymbolizer</span><span class="p">(</span><span class="o">*</span><span class="n">Ctx</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">RelInfo</span><span class="p">,</span> <span class="n">Obj</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Symzer</span><span class="p">)</span>
        <span class="n">DisAsm</span><span class="o">-&gt;</span><span class="n">setSymbolizer</span><span class="p">(</span><span class="n">Symzer</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MCInstrAnalysis</span><span class="o">&gt;</span>
    <span class="n">MIA</span><span class="p">(</span><span class="n">TheTarget</span><span class="o">-&gt;</span><span class="n">createMCInstrAnalysis</span><span class="p">(</span><span class="n">MII</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>

  <span class="kt">int</span> <span class="n">AsmPrinterVariant</span> <span class="o">=</span> <span class="n">AsmInfo</span><span class="o">-&gt;</span><span class="n">getAssemblerDialect</span><span class="p">();</span>
  <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="n">MCInstPrinter</span><span class="o">&gt;</span> <span class="n">IP</span><span class="p">(</span><span class="n">TheTarget</span><span class="o">-&gt;</span><span class="n">createMCInstPrinter</span><span class="p">(</span>
      <span class="n">AsmPrinterVariant</span><span class="p">,</span> <span class="o">*</span><span class="n">AsmInfo</span><span class="p">,</span> <span class="o">*</span><span class="n">MII</span><span class="p">,</span> <span class="o">*</span><span class="n">MRI</span><span class="p">,</span> <span class="o">*</span><span class="n">STI</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IP</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;error: no instruction printer for target &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">TripleName</span>
      <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">CFG</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="n">MCObjectDisassembler</span><span class="o">&gt;</span> <span class="n">OD</span><span class="p">(</span>
      <span class="k">new</span> <span class="n">MCObjectDisassembler</span><span class="p">(</span><span class="o">*</span><span class="n">Obj</span><span class="p">,</span> <span class="o">*</span><span class="n">DisAsm</span><span class="p">,</span> <span class="o">*</span><span class="n">MIA</span><span class="p">));</span>
    <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="n">MCModule</span><span class="o">&gt;</span> <span class="n">Mod</span><span class="p">(</span><span class="n">OD</span><span class="o">-&gt;</span><span class="n">buildModule</span><span class="p">(</span><span class="cm">/* withCFG */</span> <span class="kc">true</span><span class="p">));</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">MCModule</span><span class="o">::</span><span class="n">const_atom_iterator</span> <span class="n">AI</span> <span class="o">=</span> <span class="n">Mod</span><span class="o">-&gt;</span><span class="n">atom_begin</span><span class="p">(),</span>
                                       <span class="n">AE</span> <span class="o">=</span> <span class="n">Mod</span><span class="o">-&gt;</span><span class="n">atom_end</span><span class="p">();</span>
                                       <span class="n">AI</span> <span class="o">!=</span> <span class="n">AE</span><span class="p">;</span> <span class="o">++</span><span class="n">AI</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Atom &quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">AI</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">MCTextAtom</span> <span class="o">*</span><span class="n">TA</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">MCTextAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">AI</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">MCTextAtom</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">II</span> <span class="o">=</span> <span class="n">TA</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span> <span class="n">IE</span> <span class="o">=</span> <span class="n">TA</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">();</span>
             <span class="n">II</span> <span class="o">!=</span> <span class="n">IE</span><span class="p">;</span>
             <span class="o">++</span><span class="n">II</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">IP</span><span class="o">-&gt;</span><span class="n">printInst</span><span class="p">(</span><span class="o">&amp;</span><span class="n">II</span><span class="o">-&gt;</span><span class="n">Inst</span><span class="p">,</span> <span class="n">outs</span><span class="p">(),</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
          <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">MCModule</span><span class="o">::</span><span class="n">const_func_iterator</span> <span class="n">FI</span> <span class="o">=</span> <span class="n">Mod</span><span class="o">-&gt;</span><span class="n">func_begin</span><span class="p">(),</span>
                                       <span class="n">FE</span> <span class="o">=</span> <span class="n">Mod</span><span class="o">-&gt;</span><span class="n">func_end</span><span class="p">();</span>
                                       <span class="n">FI</span> <span class="o">!=</span> <span class="n">FE</span><span class="p">;</span> <span class="o">++</span><span class="n">FI</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">static</span> <span class="kt">int</span> <span class="n">filenum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">emitDOTFile</span><span class="p">((</span><span class="n">Twine</span><span class="p">((</span><span class="o">*</span><span class="n">FI</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">())</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span>
                   <span class="n">utostr</span><span class="p">(</span><span class="n">filenum</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.dot&quot;</span><span class="p">).</span><span class="n">str</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span>
                    <span class="o">**</span><span class="n">FI</span><span class="p">,</span> <span class="n">IP</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
      <span class="o">++</span><span class="n">filenum</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>


  <span class="n">error_code</span> <span class="n">ec</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">section_iterator</span> <span class="n">i</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">-&gt;</span><span class="n">begin_sections</span><span class="p">(),</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">-&gt;</span><span class="n">end_sections</span><span class="p">();</span>
                        <span class="n">i</span> <span class="o">!=</span> <span class="n">e</span><span class="p">;</span> <span class="n">i</span><span class="p">.</span><span class="n">increment</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">text</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">isText</span><span class="p">(</span><span class="n">text</span><span class="p">)))</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">text</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

    <span class="n">uint64_t</span> <span class="n">SectionAddr</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">getAddress</span><span class="p">(</span><span class="n">SectionAddr</span><span class="p">)))</span> <span class="k">break</span><span class="p">;</span>

    <span class="c1">// Make a list of all the symbols in this section.</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">uint64_t</span><span class="p">,</span> <span class="n">StringRef</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">Symbols</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">symbol_iterator</span> <span class="n">si</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">-&gt;</span><span class="n">begin_symbols</span><span class="p">(),</span>
                         <span class="n">se</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">-&gt;</span><span class="n">end_symbols</span><span class="p">();</span>
                         <span class="n">si</span> <span class="o">!=</span> <span class="n">se</span><span class="p">;</span> <span class="n">si</span><span class="p">.</span><span class="n">increment</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="p">{</span>
      <span class="kt">bool</span> <span class="n">contains</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">containsSymbol</span><span class="p">(</span><span class="o">*</span><span class="n">si</span><span class="p">,</span> <span class="n">contains</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">contains</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">uint64_t</span> <span class="n">Address</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getAddress</span><span class="p">(</span><span class="n">Address</span><span class="p">)))</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Address</span> <span class="o">==</span> <span class="n">UnknownAddressOrSize</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="n">Address</span> <span class="o">-=</span> <span class="n">SectionAddr</span><span class="p">;</span>

        <span class="n">StringRef</span> <span class="n">Name</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(</span><span class="n">Name</span><span class="p">)))</span> <span class="k">break</span><span class="p">;</span>
        <span class="n">Symbols</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">Name</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Sort the symbols by address, just in case they didn&#39;t come in that way.</span>
    <span class="n">array_pod_sort</span><span class="p">(</span><span class="n">Symbols</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">Symbols</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>

    <span class="c1">// Make a list of all the relocations for this section.</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">RelocationRef</span><span class="o">&gt;</span> <span class="n">Rels</span><span class="p">;</span>
<span class="cm">/*    if (InlineRelocs) {</span>
<span class="cm">      for (relocation_iterator ri = i-&gt;begin_relocations(),</span>
<span class="cm">                               re = i-&gt;end_relocations();</span>
<span class="cm">                               ri != re; ri.increment(ec)) {</span>
<span class="cm">        if (error(ec)) break;</span>
<span class="cm">        Rels.push_back(*ri);</span>
<span class="cm">      }</span>
<span class="cm">    }*/</span>

    <span class="c1">// Sort relocations by address.</span>
    <span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="n">Rels</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">Rels</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">RelocAddressLess</span><span class="p">);</span>

    <span class="n">StringRef</span> <span class="n">SegmentName</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">MachOObjectFile</span> <span class="o">*</span><span class="n">MachO</span> <span class="o">=</span>
        <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MachOObjectFile</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Obj</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">DataRefImpl</span> <span class="n">DR</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">getRawDataRefImpl</span><span class="p">();</span>
      <span class="n">SegmentName</span> <span class="o">=</span> <span class="n">MachO</span><span class="o">-&gt;</span><span class="n">getSectionFinalSegmentName</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">StringRef</span> <span class="n">name</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span> <span class="k">break</span><span class="p">;</span>
    <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/*&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Disassembly of section &quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SegmentName</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
      <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">SegmentName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
    <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;:&#39;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*/&quot;</span><span class="p">;</span>

    <span class="c1">// If the section has no symbols just insert a dummy one and disassemble</span>
    <span class="c1">// the whole section.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Symbols</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
      <span class="n">Symbols</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>


    <span class="n">SmallString</span><span class="o">&lt;</span><span class="mi">40</span><span class="o">&gt;</span> <span class="n">Comments</span><span class="p">;</span>
    <span class="n">raw_svector_ostream</span> <span class="n">CommentStream</span><span class="p">(</span><span class="n">Comments</span><span class="p">);</span>

    <span class="n">StringRef</span> <span class="n">Bytes</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">getContents</span><span class="p">(</span><span class="n">Bytes</span><span class="p">)))</span> <span class="k">break</span><span class="p">;</span>
    <span class="n">StringRefMemoryObject</span> <span class="n">memoryObject</span><span class="p">(</span><span class="n">Bytes</span><span class="p">,</span> <span class="n">SectionAddr</span><span class="p">);</span>
    <span class="n">uint64_t</span> <span class="n">Size</span><span class="p">;</span>
    <span class="n">uint64_t</span> <span class="n">Index</span><span class="p">;</span>
    <span class="n">uint64_t</span> <span class="n">SectSize</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">(</span><span class="n">SectSize</span><span class="p">)))</span> <span class="k">break</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">RelocationRef</span><span class="o">&gt;::</span><span class="n">const_iterator</span> <span class="n">rel_cur</span> <span class="o">=</span> <span class="n">Rels</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">RelocationRef</span><span class="o">&gt;::</span><span class="n">const_iterator</span> <span class="n">rel_end</span> <span class="o">=</span> <span class="n">Rels</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
    <span class="c1">// Disassemble symbol by symbol.</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">si</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">se</span> <span class="o">=</span> <span class="n">Symbols</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">si</span> <span class="o">!=</span> <span class="n">se</span><span class="p">;</span> <span class="o">++</span><span class="n">si</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">uint64_t</span> <span class="n">Start</span> <span class="o">=</span> <span class="n">Symbols</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">first</span><span class="p">;</span>
      <span class="n">uint64_t</span> <span class="n">End</span><span class="p">;</span>
      <span class="c1">// The end is either the size of the section or the beginning of the next</span>
      <span class="c1">// symbol.</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">si</span> <span class="o">==</span> <span class="n">se</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">End</span> <span class="o">=</span> <span class="n">SectSize</span><span class="p">;</span>
      <span class="c1">// Make sure this symbol takes up space.</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Symbols</span><span class="p">[</span><span class="n">si</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">first</span> <span class="o">!=</span> <span class="n">Start</span><span class="p">)</span>
        <span class="n">End</span> <span class="o">=</span> <span class="n">Symbols</span><span class="p">[</span><span class="n">si</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">first</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="c1">// This symbol has the same address as the next symbol. Skip it.</span>
        <span class="k">continue</span><span class="p">;</span>

      <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/*&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Symbols</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">second</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:*/</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cp">#ifndef NDEBUG</span>
        <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">DebugOut</span> <span class="o">=</span> <span class="n">DebugFlag</span> <span class="o">?</span> <span class="n">dbgs</span><span class="p">()</span> <span class="o">:</span> <span class="n">nulls</span><span class="p">();</span>
<span class="cp">#else</span>
        <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">DebugOut</span> <span class="o">=</span> <span class="n">nulls</span><span class="p">();</span>
<span class="cp">#endif</span>

      <span class="k">for</span> <span class="p">(</span><span class="n">Index</span> <span class="o">=</span> <span class="n">Start</span><span class="p">;</span> <span class="n">Index</span> <span class="o">&lt;</span> <span class="n">End</span><span class="p">;</span> <span class="n">Index</span> <span class="o">+=</span> <span class="n">Size</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">MCInst</span> <span class="n">Inst</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">DisAsm</span><span class="o">-&gt;</span><span class="n">getInstruction</span><span class="p">(</span><span class="n">Inst</span><span class="p">,</span> <span class="n">Size</span><span class="p">,</span> <span class="n">memoryObject</span><span class="p">,</span>
                                   <span class="n">SectionAddr</span> <span class="o">+</span> <span class="n">Index</span><span class="p">,</span>
                                   <span class="n">DebugOut</span><span class="p">,</span> <span class="n">CommentStream</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;/*%8&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;:*/&quot;</span><span class="p">,</span> <span class="cm">/*SectionAddr + */</span><span class="n">Index</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NoShowRawInsn</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>
            <span class="n">DumpBytes</span><span class="p">(</span><span class="n">StringRef</span><span class="p">(</span><span class="n">Bytes</span><span class="p">.</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">Index</span><span class="p">,</span> <span class="n">Size</span><span class="p">));</span>
          <span class="p">}</span>
          <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/*&quot;</span><span class="p">;</span>
          <span class="n">IP</span><span class="o">-&gt;</span><span class="n">printInst</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Inst</span><span class="p">,</span> <span class="n">outs</span><span class="p">(),</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
          <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">CommentStream</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
          <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*/&quot;</span><span class="p">;</span>
          <span class="n">Comments</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
          <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">ToolName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: warning: invalid instruction encoding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">Size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">Size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// skip illegible bytes</span>
        <span class="p">}</span>

        <span class="c1">// Print relocation for instruction.</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">rel_cur</span> <span class="o">!=</span> <span class="n">rel_end</span><span class="p">)</span> <span class="p">{</span>
          <span class="kt">bool</span> <span class="n">hidden</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="n">uint64_t</span> <span class="n">addr</span><span class="p">;</span>
          <span class="n">SmallString</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span> <span class="n">name</span><span class="p">;</span>
          <span class="n">SmallString</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">&gt;</span> <span class="n">val</span><span class="p">;</span>

          <span class="c1">// If this relocation is hidden, skip it.</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">rel_cur</span><span class="o">-&gt;</span><span class="n">getHidden</span><span class="p">(</span><span class="n">hidden</span><span class="p">)))</span> <span class="k">goto</span> <span class="n">skip_print_rel</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">hidden</span><span class="p">)</span> <span class="k">goto</span> <span class="n">skip_print_rel</span><span class="p">;</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">rel_cur</span><span class="o">-&gt;</span><span class="n">getOffset</span><span class="p">(</span><span class="n">addr</span><span class="p">)))</span> <span class="k">goto</span> <span class="n">skip_print_rel</span><span class="p">;</span>
          <span class="c1">// Stop when rel_cur&#39;s address is past the current instruction.</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">Index</span> <span class="o">+</span> <span class="n">Size</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">rel_cur</span><span class="o">-&gt;</span><span class="n">getTypeName</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span> <span class="k">goto</span> <span class="n">skip_print_rel</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">rel_cur</span><span class="o">-&gt;</span><span class="n">getValueString</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span> <span class="k">goto</span> <span class="n">skip_print_rel</span><span class="p">;</span>

          <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">/*%8&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;: &quot;</span><span class="p">,</span> <span class="n">SectionAddr</span> <span class="o">+</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">name</span>
                 <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*/</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

        <span class="nl">skip_print_rel:</span>
          <span class="o">++</span><span class="n">rel_cur</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">lastAddr</span> <span class="o">=</span> <span class="n">Index</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Modified from PrintSectionContents()</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">PrintDataSections</span><span class="p">(</span><span class="k">const</span> <span class="n">ObjectFile</span> <span class="o">*</span><span class="n">o</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">lastAddr</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">error_code</span> <span class="n">ec</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">section_iterator</span> <span class="n">si</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">begin_sections</span><span class="p">(),</span>
                        <span class="n">se</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">end_sections</span><span class="p">();</span>
                        <span class="n">si</span> <span class="o">!=</span> <span class="n">se</span><span class="p">;</span> <span class="n">si</span><span class="p">.</span><span class="n">increment</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">StringRef</span> <span class="n">Name</span><span class="p">;</span>
    <span class="n">StringRef</span> <span class="n">Contents</span><span class="p">;</span>
    <span class="n">uint64_t</span> <span class="n">BaseAddr</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">BSS</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(</span><span class="n">Name</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getContents</span><span class="p">(</span><span class="n">Contents</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getAddress</span><span class="p">(</span><span class="n">BaseAddr</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">isBSS</span><span class="p">(</span><span class="n">BSS</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">Name</span> <span class="o">==</span> <span class="s">&quot;.rodata&quot;</span> <span class="o">||</span> <span class="n">Name</span> <span class="o">==</span> <span class="s">&quot;.data&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Contents</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// Fill /*address*/ 00 00 00 00 between lastAddr and BaseAddr</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="n">lastAddr</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">BaseAddr</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;/*%04&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; */&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;%02&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;%02&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> \
        <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;%02&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;%02&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/*Contents of section &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Name</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:*/</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
      <span class="c1">// Dump out the content as hex and printable ascii characters.</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">Contents</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;/*%04&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; */&quot;</span><span class="p">,</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="n">addr</span><span class="p">);</span>
        <span class="c1">// Dump line of hex.</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
            <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">hexdigit</span><span class="p">((</span><span class="n">Contents</span><span class="p">[</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
                   <span class="o">&lt;&lt;</span> <span class="n">hexdigit</span><span class="p">(</span><span class="n">Contents</span><span class="p">[</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
          <span class="k">else</span>
            <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;  &quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// save lastAddr</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">BaseAddr</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span> 
          <span class="n">lastAddr</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="n">end</span><span class="p">;</span>
        <span class="k">else</span>
          <span class="n">lastAddr</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
        <span class="c1">// Print ascii.</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/*&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;  &quot;</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">isprint</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Contents</span><span class="p">[</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">))</span>
            <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">Contents</span><span class="p">[</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
          <span class="k">else</span>
            <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;.&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*/&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">Elf2Hex</span><span class="p">(</span><span class="k">const</span> <span class="n">ObjectFile</span> <span class="o">*</span><span class="n">o</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">uint64_t</span> <span class="n">startAddr</span> <span class="o">=</span> <span class="n">GetSectionHeaderStartAddress</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="s">&quot;_start&quot;</span><span class="p">);</span>
<span class="c1">//  outs() &lt;&lt; format(&quot;_start address:%08&quot; PRIx64 &quot;\n&quot;, startAddr);</span>
  <span class="n">uint64_t</span> <span class="n">lastAddr</span><span class="p">;</span>
  <span class="n">DisassembleObjectForHex</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">lastAddr</span><span class="p">);</span>
<span class="c1">//  outs() &lt;&lt; format(&quot;lastAddr:%08&quot; PRIx64 &quot;\n&quot;, lastAddr);</span>
  <span class="n">PrintDataSections</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">lastAddr</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// llvm-objdump -elf2hex code added end:</span>
<span class="c1">// Code added fo cpu0 -elf2hex end:</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">DumpObject</span><span class="p">(</span><span class="k">const</span> <span class="n">ObjectFile</span> <span class="o">*</span><span class="n">o</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ConvertElf2Hex</span><span class="p">)</span>
    <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/*&quot;</span><span class="p">;</span>
  <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">getFileName</span><span class="p">()</span>
         <span class="o">&lt;&lt;</span> <span class="s">&quot;:</span><span class="se">\t</span><span class="s">file format &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">getFileFormatName</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ConvertElf2Hex</span><span class="p">)</span>
    <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*/&quot;</span><span class="p">;</span>
  <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Disassemble</span><span class="p">)</span>
    <span class="n">DisassembleObject</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">Relocations</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Relocations</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Disassemble</span><span class="p">)</span>
    <span class="n">PrintRelocations</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SectionHeaders</span><span class="p">)</span>
    <span class="n">PrintSectionHeaders</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SectionContents</span><span class="p">)</span>
    <span class="n">PrintSectionContents</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ConvertElf2Hex</span><span class="p">)</span>
    <span class="n">Elf2Hex</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SymbolTable</span><span class="p">)</span>
    <span class="n">PrintSymbolTable</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">UnwindInfo</span><span class="p">)</span>
    <span class="n">PrintUnwindInfo</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">PrivateHeaders</span> <span class="o">&amp;&amp;</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">isELF</span><span class="p">())</span>
    <span class="n">printELFFileHeader</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">/// @brief Dump each object file in \a a;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">DumpArchive</span><span class="p">(</span><span class="k">const</span> <span class="n">Archive</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">Archive</span><span class="o">::</span><span class="n">child_iterator</span> <span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">begin_children</span><span class="p">(),</span>
                               <span class="n">e</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">end_children</span><span class="p">();</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">e</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="n">Binary</span><span class="o">&gt;</span> <span class="n">child</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error_code</span> <span class="n">ec</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">getAsBinary</span><span class="p">(</span><span class="n">child</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// Ignore non-object files.</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ec</span> <span class="o">!=</span> <span class="n">object_error</span><span class="o">::</span><span class="n">invalid_file_type</span><span class="p">)</span>
        <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">ToolName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: &#39;&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">getFileName</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;&#39;: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ec</span><span class="p">.</span><span class="n">message</span><span class="p">()</span>
               <span class="o">&lt;&lt;</span> <span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ObjectFile</span> <span class="o">*</span><span class="n">o</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ObjectFile</span><span class="o">&gt;</span><span class="p">(</span><span class="n">child</span><span class="p">.</span><span class="n">get</span><span class="p">()))</span>
      <span class="n">DumpObject</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">ToolName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: &#39;&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">getFileName</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;&#39;: &quot;</span>
              <span class="o">&lt;&lt;</span> <span class="s">&quot;Unrecognized file type.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">/// @brief Open file and figure out how to dump it.</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">DumpInput</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// If file isn&#39;t stdin, check that it exists.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">!=</span> <span class="s">&quot;-&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sys</span><span class="o">::</span><span class="n">fs</span><span class="o">::</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">ToolName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: &#39;&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">file</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;&#39;: &quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;No such file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">MachOOpt</span> <span class="o">&amp;&amp;</span> <span class="n">Disassemble</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">DisassembleInputMachO</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Attempt to open the binary.</span>
  <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="n">Binary</span><span class="o">&gt;</span> <span class="n">binary</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">error_code</span> <span class="n">ec</span> <span class="o">=</span> <span class="n">createBinary</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">binary</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">ToolName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: &#39;&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">file</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;&#39;: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ec</span><span class="p">.</span><span class="n">message</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Archive</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Archive</span><span class="o">&gt;</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">get</span><span class="p">()))</span>
    <span class="n">DumpArchive</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ObjectFile</span> <span class="o">*</span><span class="n">o</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ObjectFile</span><span class="o">&gt;</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">get</span><span class="p">()))</span>
    <span class="n">DumpObject</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">ToolName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: &#39;&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">file</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;&#39;: &quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Unrecognized file type.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Print a stack trace if we signal out.</span>
  <span class="n">sys</span><span class="o">::</span><span class="n">PrintStackTraceOnErrorSignal</span><span class="p">();</span>
  <span class="n">PrettyStackTraceProgram</span> <span class="n">X</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
  <span class="n">llvm_shutdown_obj</span> <span class="n">Y</span><span class="p">;</span>  <span class="c1">// Call llvm_shutdown() on exit.</span>

  <span class="c1">// Initialize targets and assembly printers/parsers.</span>
  <span class="n">llvm</span><span class="o">::</span><span class="n">InitializeAllTargetInfos</span><span class="p">();</span>
  <span class="n">llvm</span><span class="o">::</span><span class="n">InitializeAllTargetMCs</span><span class="p">();</span>
  <span class="n">llvm</span><span class="o">::</span><span class="n">InitializeAllAsmParsers</span><span class="p">();</span>
  <span class="n">llvm</span><span class="o">::</span><span class="n">InitializeAllDisassemblers</span><span class="p">();</span>

  <span class="c1">// Register the target printer for --version.</span>
  <span class="n">cl</span><span class="o">::</span><span class="n">AddExtraVersionPrinter</span><span class="p">(</span><span class="n">TargetRegistry</span><span class="o">::</span><span class="n">printRegisteredTargetsForVersion</span><span class="p">);</span>

  <span class="n">cl</span><span class="o">::</span><span class="n">ParseCommandLineOptions</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&quot;llvm object file dumper</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="n">TripleName</span> <span class="o">=</span> <span class="n">Triple</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">TripleName</span><span class="p">);</span>

  <span class="n">ToolName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

  <span class="c1">// Defaults to a.out if no filenames specified.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">InputFilenames</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">InputFilenames</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="s">&quot;a.out&quot;</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Disassemble</span>
      <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Relocations</span>
      <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">SectionHeaders</span>
      <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">SectionContents</span>
      <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ConvertElf2Hex</span>
      <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">SymbolTable</span>
      <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">UnwindInfo</span>
      <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">PrivateHeaders</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cl</span><span class="o">::</span><span class="n">PrintHelpMessage</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">InputFilenames</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">InputFilenames</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
                <span class="n">DumpInput</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="n">DumpObject</span><span class="p">(</span><span class="k">const</span> <span class="n">ObjectFile</span> <span class="o">*</span><span class="n">o</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ConvertElf2Hex</span><span class="p">)</span>
    <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/*&quot;</span><span class="p">;</span>
  <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">getFileName</span><span class="p">()</span>
         <span class="o">&lt;&lt;</span> <span class="s">&quot;:</span><span class="se">\t</span><span class="s">file format &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">getFileFormatName</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ConvertElf2Hex</span><span class="p">)</span>
    <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*/&quot;</span><span class="p">;</span>
  <span class="p">...</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ConvertElf2Hex</span><span class="p">)</span>
    <span class="n">Elf2Hex</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
  <span class="p">...</span>
<span class="p">}</span>
<span class="p">...</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Disassemble</span>
      <span class="p">...</span>
      <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ConvertElf2Hex</span>
      <span class="p">...)</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="run">
<h2>Run<a class="headerlink" href="#run" title="Permalink to this headline">¶</a></h2>
<p>File printf-stdarg.c came from internet download which is GPL2 license. GPL2
is more restricted than LLVM license. File printf-stdarg-2.c is modified from
printf-stdarg.c of printf() function supplied and add some test function for
/demo/verification/debugpurpose on Cpu0 backend.
File printf-stdarg-1.c is file for testing the printf()
function implemented on PC OS platform. Let&#8217;s run printf-stdarg-2.c on Cpu0 and
compare with the result of printf() function which implemented by PC OS as follows,</p>
<p class="rubric">LLVMBackendTutorialExampleCode/InputFiles/printf-stdarg-1.c</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">  Copyright 2001, 2002 Georges Menie (www.menie.org)</span>
<span class="cm">  stdarg version contributed by Christian Ettinger</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU Lesser General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU Lesser General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU Lesser General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">  putchar is the only external dependency for this file,</span>
<span class="cm">  if you have a working putchar, leave it commented out.</span>
<span class="cm">  If not, uncomment the define below and</span>
<span class="cm">  replace outbyte(c) by your own function call.</span>

<span class="cm">#define putchar(c) outbyte(c)</span>
<span class="cm">*/</span>

<span class="c1">// gcc printf-stdarg-1.c</span>
<span class="c1">// ./a.out</span>

<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="cp">#define TEST_PRINTF</span>

<span class="cp">#ifdef TEST_PRINTF</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="s">&quot;Hello world!&quot;</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bs</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">mi</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

  <span class="n">mi</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bs</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;printf test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s is null pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d = 5</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d = - max int</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mi</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;char %c = &#39;a&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;hex %x = ff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;hex %02x = 00</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;signed %d = unsigned %u = hex %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d %s(s)%&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d %s(s) with %%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;justif: </span><span class="se">\&quot;</span><span class="s">%-10s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;left&quot;</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;justif: </span><span class="se">\&quot;</span><span class="s">%10s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;right&quot;</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; 3: %04d zero padded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; 3: %-4d left justif.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; 3: %4d right justif.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;-3: %04d zero padded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;-3: %-4d left justif.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;-3: %4d right justif.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * if you compile this file with</span>
<span class="cm"> *   gcc -Wall $(YOUR_C_OPTIONS) -DTEST_PRINTF -c printf.c</span>
<span class="cm"> * you will get a normal warning:</span>
<span class="cm"> *   printf.c:214: warning: spurious trailing `%&#39; in format</span>
<span class="cm"> * this line is testing an invalid % at the end of the format string.</span>
<span class="cm"> *</span>
<span class="cm"> * this should display (on 32bit int machine) :</span>
<span class="cm"> *</span>
<span class="cm"> * Hello world!</span>
<span class="cm"> * printf test</span>
<span class="cm"> * (null) is null pointer</span>
<span class="cm"> * 5 = 5</span>
<span class="cm"> * -2147483647 = - max int</span>
<span class="cm"> * char a = &#39;a&#39;</span>
<span class="cm"> * hex ff = ff</span>
<span class="cm"> * hex 00 = 00</span>
<span class="cm"> * signed -3 = unsigned 4294967293 = hex fffffffd</span>
<span class="cm"> * 0 message(s)</span>
<span class="cm"> * 0 message(s) with %</span>
<span class="cm"> * justif: &quot;left      &quot;</span>
<span class="cm"> * justif: &quot;     right&quot;</span>
<span class="cm"> *  3: 0003 zero padded</span>
<span class="cm"> *  3: 3    left justif.</span>
<span class="cm"> *  3:    3 right justif.</span>
<span class="cm"> * -3: -003 zero padded</span>
<span class="cm"> * -3: -3   left justif.</span>
<span class="cm"> * -3:   -3 right justif.</span>
<span class="cm"> */</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">LLVMBackendTutorialExampleCode/InputFiles/printf-stdarg-2.c</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">  Copyright 2001, 2002 Georges Menie (www.menie.org)</span>
<span class="cm">  stdarg version contributed by Christian Ettinger</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU Lesser General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU Lesser General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU Lesser General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">  putchar is the only external dependency for this file,</span>
<span class="cm">  if you have a working putchar, leave it commented out.</span>
<span class="cm">  If not, uncomment the define below and</span>
<span class="cm">  replace outbyte(c) by your own function call.</span>

<span class="cm">#define putchar(c) outbyte(c)</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;stdarg.h&gt;</span>
<span class="cp">#include &quot;print.h&quot;</span>

<span class="cp">#define TEST_PRINTF</span>

<span class="cp">#include &quot;boot.cpp&quot;</span>

<span class="k">struct</span> <span class="n">Time</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">hour</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">minute</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">second</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">Date</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">year</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">month</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">day</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">hour</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">minute</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">second</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">test_global</span><span class="p">();</span>
<span class="kt">int</span> <span class="n">printf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...);</span>
<span class="kt">int</span> <span class="n">sprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...);</span>
<span class="k">struct</span> <span class="n">Date</span> <span class="n">copyDate</span><span class="p">(</span><span class="k">struct</span> <span class="n">Date</span> <span class="n">date</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">Time</span> <span class="n">copyTime</span><span class="p">(</span><span class="k">struct</span> <span class="n">Time</span> <span class="n">time</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">gI</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">Date</span> <span class="n">gDate</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">};</span>

<span class="cp">#ifdef TEST_PRINTF</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="s">&quot;Hello world!&quot;</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bs</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">mi</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">Time</span> <span class="n">time1</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">};</span>
  <span class="k">struct</span> <span class="n">Time</span> <span class="n">time2</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">Date</span> <span class="n">date</span><span class="p">;</span>

  <span class="n">a</span> <span class="o">=</span> <span class="n">test_global</span><span class="p">();</span>  <span class="c1">// gI = 100</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;global variable gI = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;time1 = %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">time1</span><span class="p">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">time1</span><span class="p">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">time1</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
  <span class="n">date</span> <span class="o">=</span> <span class="n">copyDate</span><span class="p">(</span><span class="n">gDate</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;date = %d %d %d %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">date</span><span class="p">.</span><span class="n">year</span><span class="p">,</span> <span class="n">date</span><span class="p">.</span><span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="p">.</span><span class="n">day</span><span class="p">,</span> <span class="n">date</span><span class="p">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">date</span><span class="p">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">date</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
  <span class="n">time2</span> <span class="o">=</span> <span class="n">copyTime</span><span class="p">(</span><span class="n">time1</span><span class="p">);</span> <span class="c1">// test return V0, V1, A0</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;time2 = %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">time2</span><span class="p">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">time2</span><span class="p">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">time2</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>

  <span class="n">mi</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bs</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;printf test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s is null pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d = 5</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d = - max int</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mi</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;char %c = &#39;a&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;hex %x = ff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;hex %02x = 00</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;signed %d = unsigned %u = hex %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d %s(s)%&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d %s(s) with %%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;justif: </span><span class="se">\&quot;</span><span class="s">%-10s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;left&quot;</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;justif: </span><span class="se">\&quot;</span><span class="s">%10s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;right&quot;</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; 3: %04d zero padded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; 3: %-4d left justif.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; 3: %4d right justif.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;-3: %04d zero padded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;-3: %-4d left justif.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;-3: %4d right justif.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * if you compile this file with</span>
<span class="cm"> *   gcc -Wall $(YOUR_C_OPTIONS) -DTEST_PRINTF -c printf.c</span>
<span class="cm"> * you will get a normal warning:</span>
<span class="cm"> *   printf.c:214: warning: spurious trailing `%&#39; in format</span>
<span class="cm"> * this line is testing an invalid % at the end of the format string.</span>
<span class="cm"> *</span>
<span class="cm"> * this should display (on 32bit int machine) :</span>
<span class="cm"> *</span>
<span class="cm"> * Hello world!</span>
<span class="cm"> * printf test</span>
<span class="cm"> * (null) is null pointer</span>
<span class="cm"> * 5 = 5</span>
<span class="cm"> * -2147483647 = - max int</span>
<span class="cm"> * char a = &#39;a&#39;</span>
<span class="cm"> * hex ff = ff</span>
<span class="cm"> * hex 00 = 00</span>
<span class="cm"> * signed -3 = unsigned 4294967293 = hex fffffffd</span>
<span class="cm"> * 0 message(s)</span>
<span class="cm"> * 0 message(s) with %</span>
<span class="cm"> * justif: &quot;left      &quot;</span>
<span class="cm"> * justif: &quot;     right&quot;</span>
<span class="cm"> *  3: 0003 zero padded</span>
<span class="cm"> *  3: 3    left justif.</span>
<span class="cm"> *  3:    3 right justif.</span>
<span class="cm"> * -3: -003 zero padded</span>
<span class="cm"> * -3: -3   left justif.</span>
<span class="cm"> * -3:   -3 right justif.</span>
<span class="cm"> */</span>

<span class="cp">#endif</span>

<span class="c1">// For memory IO</span>
<span class="kt">void</span> <span class="n">putchar</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">OUT_MEM</span><span class="p">;</span>
  <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">printchar</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">**</span><span class="n">str</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
    <span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="n">putchar</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define PAD_RIGHT 1</span>
<span class="cp">#define PAD_ZERO 2</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">prints</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">out</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pad</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">register</span> <span class="kt">int</span> <span class="n">pc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">padchar</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">register</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">register</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">string</span><span class="p">;</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span> <span class="o">++</span><span class="n">ptr</span><span class="p">)</span> <span class="o">++</span><span class="n">len</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">width</span><span class="p">)</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">else</span> <span class="n">width</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pad</span> <span class="o">&amp;</span> <span class="n">PAD_ZERO</span><span class="p">)</span> <span class="n">padchar</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pad</span> <span class="o">&amp;</span> <span class="n">PAD_RIGHT</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// pad left</span>
    <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">width</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printchar</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">padchar</span><span class="p">);</span>
      <span class="o">++</span><span class="n">pc</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">*</span><span class="n">string</span> <span class="p">;</span> <span class="o">++</span><span class="n">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printchar</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">*</span><span class="n">string</span><span class="p">);</span>
    <span class="o">++</span><span class="n">pc</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">width</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printchar</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">padchar</span><span class="p">);</span>
    <span class="o">++</span><span class="n">pc</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">pc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* the following should be enough for 32 bit int */</span>
<span class="cp">#define PRINT_BUF_LEN 12</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">printi</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">out</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pad</span><span class="p">,</span> <span class="kt">int</span> <span class="n">letbase</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">print_buf</span><span class="p">[</span><span class="n">PRINT_BUF_LEN</span><span class="p">];</span>
  <span class="k">register</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
  <span class="k">register</span> <span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="n">neg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">u</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">print_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
    <span class="n">print_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">prints</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">print_buf</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">sg</span> <span class="o">&amp;&amp;</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">neg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">u</span> <span class="o">=</span> <span class="o">-</span><span class="n">i</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">s</span> <span class="o">=</span> <span class="n">print_buf</span> <span class="o">+</span> <span class="n">PRINT_BUF_LEN</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">u</span> <span class="o">%</span> <span class="n">b</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="p">)</span>
      <span class="n">t</span> <span class="o">+=</span> <span class="n">letbase</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>
    <span class="o">*--</span><span class="n">s</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
    <span class="n">u</span> <span class="o">/=</span> <span class="n">b</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">neg</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">width</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pad</span> <span class="o">&amp;</span> <span class="n">PAD_ZERO</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">printchar</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="sc">&#39;-&#39;</span><span class="p">);</span>
      <span class="o">++</span><span class="n">pc</span><span class="p">;</span>
      <span class="o">--</span><span class="n">width</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="o">*--</span><span class="n">s</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">pc</span> <span class="o">+</span> <span class="n">prints</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">print</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">out</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="n">va_list</span> <span class="n">args</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="k">register</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">;</span>
  <span class="k">register</span> <span class="kt">int</span> <span class="n">pc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">scr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

  <span class="k">for</span> <span class="p">(;</span> <span class="o">*</span><span class="n">format</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">++</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;%&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">++</span><span class="n">format</span><span class="p">;</span>
      <span class="n">width</span> <span class="o">=</span> <span class="n">pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;%&#39;</span><span class="p">)</span> <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">++</span><span class="n">format</span><span class="p">;</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="n">PAD_RIGHT</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">++</span><span class="n">format</span><span class="p">;</span>
        <span class="n">pad</span> <span class="o">|=</span> <span class="n">PAD_ZERO</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">*</span><span class="n">format</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">format</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">;</span> <span class="o">++</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">width</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
        <span class="n">width</span> <span class="o">+=</span> <span class="o">*</span><span class="n">format</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;s&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">register</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="p">);</span>
        <span class="n">pc</span> <span class="o">+=</span> <span class="n">prints</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">s</span><span class="o">?</span><span class="nl">s:</span><span class="s">&quot;(null)&quot;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;d&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">pc</span> <span class="o">+=</span> <span class="n">printi</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">va_arg</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;x&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">pc</span> <span class="o">+=</span> <span class="n">printi</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">va_arg</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="p">),</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;X&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">pc</span> <span class="o">+=</span> <span class="n">printi</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">va_arg</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="p">),</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;u&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">pc</span> <span class="o">+=</span> <span class="n">printi</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">va_arg</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;c&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* char are converted to int then pushed on the stack */</span>
        <span class="n">scr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="p">);</span>
        <span class="n">scr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
        <span class="n">pc</span> <span class="o">+=</span> <span class="n">prints</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">scr</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
    <span class="nl">out:</span>
      <span class="n">printchar</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">*</span><span class="n">format</span><span class="p">);</span>
      <span class="o">++</span><span class="n">pc</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">**</span><span class="n">out</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
  <span class="n">va_end</span><span class="p">(</span> <span class="n">args</span> <span class="p">);</span>
  <span class="k">return</span> <span class="n">pc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">printf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
  <span class="n">va_list</span> <span class="n">args</span><span class="p">;</span>
        
  <span class="n">va_start</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="n">format</span> <span class="p">);</span>
  <span class="k">return</span> <span class="n">print</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">args</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">sprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
  <span class="n">va_list</span> <span class="n">args</span><span class="p">;</span>
        
  <span class="n">va_start</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="n">format</span> <span class="p">);</span>
  <span class="k">return</span> <span class="n">print</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">args</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">test_global</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">gI</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">Date</span> <span class="n">copyDate</span><span class="p">(</span><span class="k">struct</span> <span class="n">Date</span> <span class="n">date</span><span class="p">)</span>
<span class="p">{</span> 
  <span class="k">return</span> <span class="n">date</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">Time</span> <span class="n">copyTime</span><span class="p">(</span><span class="k">struct</span> <span class="n">Time</span> <span class="n">time</span><span class="p">)</span>
<span class="p">{</span> 
  <span class="k">return</span> <span class="n">time</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>Gamma@localhost InputFiles<span class="o">]</span><span class="nv">$ </span>/usr/local/llvm/release/cmake_debug_build/bin/
clang -target mips-unknown-linux-gnu -c <span class="nb">printf</span>-stdarg-2.c -emit-llvm -o
<span class="nb">printf</span>-stdarg-2.bc
<span class="nb">printf</span>-stdarg-2.c:75:19: warning: incomplete format specifier <span class="o">[</span>-Wformat<span class="o">]</span>
  <span class="nb">printf</span><span class="o">(</span><span class="s2">&quot;%d %s(s)%&quot;</span>, 0, <span class="s2">&quot;message&quot;</span><span class="o">)</span>;
                  ^
1 warning generated.
<span class="o">[</span>Gamma@localhost InputFiles<span class="o">]</span><span class="nv">$ </span>/home/Gamma/test/lld/cmake_debug_build/bin/llc
-march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>static -filetype<span class="o">=</span>obj <span class="nb">printf</span>-stdarg-2.bc -o
<span class="nb">printf</span>-stdarg-2.cpu0.o
<span class="o">[</span>Gamma@localhost InputFiles<span class="o">]</span><span class="nv">$ </span>/home/Gamma/test/lld/cmake_debug_build/bin/lld
-flavor gnu -target cpu0-unknown-linux-gnu <span class="nb">printf</span>-stdarg-2.cpu0.o -o a.out
<span class="o">[</span>Gamma@localhost InputFiles<span class="o">]</span><span class="nv">$ </span>/home/Gamma/test/lld/cmake_debug_build/bin/
llvm-objdump -elf2hex a.out &gt; ../cpu0_verilog/redesign/cpu0s.hex
<span class="o">[</span>Gamma@localhost InputFiles<span class="o">]</span><span class="nv">$ </span><span class="nb">cd</span> ../cpu0_verilog/redesign/
<span class="o">[</span>Gamma@localhost redesign<span class="o">]</span><span class="nv">$ </span>iverilog -o cpu0s cpu0s.v
<span class="o">[</span>Gamma@localhost redesign<span class="o">]</span><span class="nv">$ </span>ls
cpu0s  cpu0s.hex  cpu0s.v
<span class="o">[</span>Gamma@localhost redesign<span class="o">]</span><span class="nv">$ </span>./cpu0s
WARNING: cpu0s.v:317: <span class="nv">$readmemh</span><span class="o">(</span>cpu0s.hex<span class="o">)</span>: Not enough words in the file <span class="k">for</span>
the requested range <span class="o">[</span>0:65535<span class="o">]</span>.
taskInterrupt<span class="o">(</span>001<span class="o">)</span>
global variable <span class="nv">gI</span> <span class="o">=</span> 100
<span class="nv">time1</span> <span class="o">=</span> 1 10 12
<span class="nv">date</span> <span class="o">=</span> 2012 10 12 1 2 3
<span class="nv">time2</span> <span class="o">=</span> 1 10 12
Hello world!
<span class="nb">printf test</span>
<span class="o">(</span>null<span class="o">)</span> is null pointer
<span class="nv">5</span> <span class="o">=</span> 5
-2147483647 <span class="o">=</span> - max int
char <span class="nv">a</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
hex <span class="nv">ff</span> <span class="o">=</span> ff
hex <span class="nv">00</span> <span class="o">=</span> 00
signed -3 <span class="o">=</span> unsigned <span class="nv">4294967293</span> <span class="o">=</span> hex fffffffd
0 message<span class="o">(</span>s<span class="o">)</span>
0 message<span class="o">(</span>s<span class="o">)</span> with %
justif: <span class="s2">&quot;left      &quot;</span>
justif: <span class="s2">&quot;     right&quot;</span>
 3: 0003 zero padded
 3: 3    left justif.
 3:    3 right justif.
-3: -003 zero padded

<span class="o">[</span>Gamma@localhost InputFiles<span class="o">]</span><span class="nv">$ </span>gcc <span class="nb">printf</span>-stdarg-1.c
/usr/lib/gcc/x86_64-redhat-linux/4.7.2/../../../../lib64/crt1.o: In <span class="k">function</span>
<span class="sb">`</span>_start<span class="s1">&#39;:</span>
<span class="s1">(.text+0x20): undefined reference to `main&#39;</span>
collect2: error: ld returned 1 <span class="nb">exit </span>status
<span class="o">[</span>Gamma@localhost InputFiles<span class="o">]</span><span class="nv">$ </span>gcc <span class="nb">printf</span>-stdarg-1.c
<span class="o">[</span>Gamma@localhost InputFiles<span class="o">]</span><span class="nv">$ </span>./a.out
Hello world!
<span class="nb">printf test</span>
<span class="o">(</span>null<span class="o">)</span> is null pointer
<span class="nv">5</span> <span class="o">=</span> 5
-2147483647 <span class="o">=</span> - max int
char <span class="nv">a</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
hex <span class="nv">ff</span> <span class="o">=</span> ff
hex <span class="nv">00</span> <span class="o">=</span> 00
signed -3 <span class="o">=</span> unsigned <span class="nv">4294967293</span> <span class="o">=</span> hex fffffffd
0 message<span class="o">(</span>s<span class="o">)</span>
0 message<span class="o">(</span>s<span class="o">)</span> with %
justif: <span class="s2">&quot;left      &quot;</span>
justif: <span class="s2">&quot;     right&quot;</span>
 3: 0003 zero padded
 3: 3    left justif.
 3:    3 right justif.
-3: -003 zero padded
-3: -3   left justif.
-3:   -3 right justif.
</pre></div>
</div>
<p>They are same after the &#8220;Hello world!&#8221; of printf() function support.</p>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>Thanks the llvm open source project.
To write a linker and ELF to Hex tools for the new CPU architecture is easy and
reliable.
Combine with the llvm compiler backend of support new architecture Cpu0 and
Verilog language program in the previouse Chapters, we design a software
toolchain to compile C/C++ code, link and run it on Verilog Cpu0 simulated
machine of PC without any real hardware to investment.
If you like to pay money to buy the FPGA development hardware, we believe the
code can run on FPGA CPU without problem even though we didn&#8217;t do it.
System program toolchain can be designed just like we show you at this point.
School knowledge of system program, compiler, linker, loader, computer
architecture and CPU design can be translate into a real work and see how it be
run. Now, these school books knowledge is not limited on paper.
We program it, design it and run it on real world.</p>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="http://lld.llvm.org/">http://lld.llvm.org/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="http://lld.llvm.org/getting_started.html#on-unix-like-systems">http://lld.llvm.org/getting_started.html#on-unix-like-systems</a></td></tr>
</tbody>
</table>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="optimize.html">Backend Optimization</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="install.html">Appendix A: Getting Started: Installing LLVM and the Cpu0 example code</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2012, LLVM.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>