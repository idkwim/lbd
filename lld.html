

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>LLD for Cpu0 &mdash; Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '3.3.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/theme_extras.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="top" title="Tutorial: Creating an LLVM Backend for the Cpu0 Architecture" href="index.html" />
    <link rel="next" title="Appendix A: Getting Started: Installing LLVM and the Cpu0 example code" href="install.html" />
    <link rel="prev" title="Backend Optimization" href="optimize.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="index.html">
          <span>Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</span></a></h1>
        <h2 class="heading"><span>LLD for Cpu0</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="optimize.html">Backend Optimization</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="install.html">Appendix A: Getting Started: Installing LLVM and the Cpu0 example code</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="lld-for-cpu0">
<span id="sec-lld"></span><h1>LLD for Cpu0<a class="headerlink" href="#lld-for-cpu0" title="Permalink to this headline">¶</a></h1>
<p>This chapter add Cpu0 backend in lld. With this lld Cpu0 for ELF linker support,
the program with global variables can be allocated in ELF file format layout.
Meaning the relocation records of global variable can be solved. In addition,
llvm-objdump driver is modified for support generate Hex file from ELF.
With these two tools supported, the program with global variables exist in
section.data and .rodata can be accessed and transfered to Hex file which feed
to Verilog Cpu0 machine and run on your PC/Laptop.</p>
<p>LLD web site <a class="footnote-reference" href="#id4" id="id1">[1]</a>. LLD install requirement on Linux <a class="footnote-reference" href="#id5" id="id2">[2]</a>.
In spite of the requirement, we
only can build with gcc4.7 above (clang will fail) on Linux.
If you run with Virtual Machine (VM), please keep your phisical memory size
setting over 1GB to avoid link error with insufficient memory.</p>
<div class="section" id="install-lld">
<h2>Install lld<a class="headerlink" href="#install-lld" title="Permalink to this headline">¶</a></h2>
<p>LLD project is underdevelopment and can be compiled with c++11 standard (C++
2011 year announced standard). Currently, we only know how to build lld with
llvm on Linux platform or Linux VM. Please let us know if you know how to build
it on iMac with Xcode. So, if you got iMac only, please install VM (such as
Virtual Box). We porting lld Cpu0 at 2013/10/30, so please checkout the
commit id 99a43d3b8f5cf86b333055a56220c6965fd9ece4(llvm) and
5d1737ac704352357fd28cfe3b2daf9aa308fb86(lld) which commited at 2013/10/30 as
follows,</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>Gamma@localhost <span class="nb">test</span><span class="o">]</span><span class="nv">$ </span>mkdir lld
<span class="o">[</span>Gamma@localhost <span class="nb">test</span><span class="o">]</span><span class="nv">$ </span><span class="nb">cd </span>lld
<span class="o">[</span>Gamma@localhost lld<span class="o">]</span><span class="nv">$ </span>git clone http://llvm.org/git/llvm.git src
Cloning into <span class="s1">&#39;src&#39;</span>...
remote: Counting objects: 780029, <span class="k">done</span>.
remote: Compressing objects: 100% <span class="o">(</span>153947/153947<span class="o">)</span>, <span class="k">done</span>.
remote: Total 780029 <span class="o">(</span>delta 637206<span class="o">)</span>, reused 764781 <span class="o">(</span>delta 622170<span class="o">)</span>
Receiving objects: 100% <span class="o">(</span>780029/780029<span class="o">)</span>, 125.74 MiB | 243 KiB/s, <span class="k">done</span>.
Resolving deltas: 100% <span class="o">(</span>637206/637206<span class="o">)</span>, <span class="k">done</span>.
<span class="o">[</span>Gamma@localhost lld<span class="o">]</span><span class="nv">$ </span><span class="nb">cd </span>src/

<span class="o">[</span>Gamma@localhost src<span class="o">]</span><span class="nv">$ </span>git checkout 99a43d3b8f5cf86b333055a56220c6965fd9ece4
Note: checking out <span class="s1">&#39;99a43d3b8f5cf86b333055a56220c6965fd9ece4&#39;</span>.

You are in <span class="s1">&#39;detached HEAD&#39;</span> state. You can look around, make experimental
changes and commit them, and you can discard any commits you make in this
state without impacting any branches by performing another checkout.

If you want to create a new branch to retain commits you create, you may
<span class="k">do </span>so <span class="o">(</span>now or later<span class="o">)</span> by using -b with the checkout <span class="nb">command </span>again. Example:

  git checkout -b new_branch_name

HEAD is now at da44b4f... CMake: polish the Windows packaging rules

<span class="o">[</span>Gamma@localhost src<span class="o">]</span><span class="nv">$ </span><span class="nb">cd </span>tools/
<span class="o">[</span>Gamma@localhost tools<span class="o">]</span><span class="nv">$ </span>git clone http://llvm.org/git/lld.git lld
...
Resolving deltas: 100% <span class="o">(</span>6422/6422<span class="o">)</span>, <span class="k">done</span>.
<span class="o">[</span>Gamma@localhost tools<span class="o">]</span><span class="nv">$ </span><span class="nb">cd </span>lld/
<span class="o">[</span>Gamma@localhost lld<span class="o">]</span><span class="nv">$ </span>git checkout 5d1737ac704352357fd28cfe3b2daf9aa308fb86
Note: checking out <span class="s1">&#39;5d1737ac704352357fd28cfe3b2daf9aa308fb86&#39;</span>.

You are in <span class="s1">&#39;detached HEAD&#39;</span> state. You can look around, make experimental
changes and commit them, and you can discard any commits you make in this
state without impacting any branches by performing another checkout.

If you want to create a new branch to retain commits you create, you may
<span class="k">do </span>so <span class="o">(</span>now or later<span class="o">)</span> by using -b with the checkout <span class="nb">command </span>again. Example:

  git checkout -b new_branch_name

HEAD is now at 014d684... <span class="o">[</span>PECOFF<span class="o">]</span> Handle <span class="s2">&quot;--&quot;</span> option explicitly
</pre></div>
</div>
<p>Next, update llvm 2013/10/30 source code to support Cpu0 as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>Gamma@localhost src<span class="o">]</span><span class="nv">$ </span><span class="nb">pwd</span>
/home/Gamma/test/lld/src
<span class="o">[</span>Gamma@localhost src<span class="o">]</span><span class="nv">$ </span>cp -rf ~/test/lbd/docs/BackendTutorial/
lbdex/3.4_1030_src_files_modify/modify/src/* .
<span class="o">[</span>Gamma@localhost src<span class="o">]</span><span class="nv">$ </span>grep -R <span class="s2">&quot;cpu0&quot;</span> include/
include/llvm/ADT/Triple.h:#undef cpu0
include/llvm/ADT/Triple.h:    cpu0,    // For Tutorial Backend Cpu0
include/llvm/ADT/Triple.h:    cpu0el,
include/llvm/Object/ELFObjectFile.h:           Triple::cpu0el : Triple::cpu0;
include/llvm/Support/ELF.h:  <span class="nv">EF_CPU0_ARCH_32R2</span> <span class="o">=</span> 0x70000000, // cpu032r2
include/llvm/Support/ELF.h:  <span class="nv">EF_CPU0_ARCH_64R2</span> <span class="o">=</span> 0x80000000, // cpu064r2
<span class="o">[</span>Gamma@localhost src<span class="o">]</span><span class="nv">$ </span><span class="nb">cd </span>lib/Target/
<span class="o">[</span>Gamma@localhost Target<span class="o">]</span><span class="nv">$ </span>ls
AArch64         MSP430                   TargetJITInfo.cpp
ARM             NVPTX                    TargetLibraryInfo.cpp
CMakeLists.txt  PowerPC                  TargetLoweringObjectFile.cpp
CppBackend      R600                     TargetMachineC.cpp
Hexagon         README.txt               TargetMachine.cpp
LLVMBuild.txt   Sparc                    TargetSubtargetInfo.cpp
Makefile        SystemZ                  X86
Mangler.cpp     Target.cpp               XCore
Mips            TargetIntrinsicInfo.cpp
<span class="o">[</span>Gamma@localhost Target<span class="o">]</span><span class="nv">$ </span>mkdir Cpu0
<span class="o">[</span>Gamma@localhost Target<span class="o">]</span><span class="nv">$ </span><span class="nb">cd </span>Cpu0/
<span class="o">[</span>Gamma@localhost Cpu0<span class="o">]</span><span class="nv">$ </span>cp -rf ~/test/lbd/docs/BackendTutorial/
lbdex/3.4_0830_Chapter12_2/* .
<span class="o">[</span>Gamma@localhost Cpu0<span class="o">]</span><span class="nv">$ </span>ls
AsmParser                 Cpu0InstrInfo.h           Cpu0SelectionDAGInfo.h
CMakeLists.txt            Cpu0InstrInfo.td          Cpu0Subtarget.cpp
Cpu0AnalyzeImmediate.cpp  Cpu0ISelDAGToDAG.cpp      Cpu0Subtarget.h
Cpu0AnalyzeImmediate.h    Cpu0ISelLowering.cpp      Cpu0TargetMachine.cpp
Cpu0AsmPrinter.cpp        Cpu0ISelLowering.h        Cpu0TargetMachine.h
Cpu0AsmPrinter.h          Cpu0MachineFunction.cpp   Cpu0TargetObjectFile.cpp
Cpu0CallingConv.td        Cpu0MachineFunction.h     Cpu0TargetObjectFile.h
Cpu0DelUselessJMP.cpp     Cpu0MCInstLower.cpp       Cpu0.td
Cpu0EmitGPRestore.cpp     Cpu0MCInstLower.h         Disassembler
Cpu0FrameLowering.cpp     Cpu0RegisterInfo.cpp      InstPrinter
Cpu0FrameLowering.h       Cpu0RegisterInfo.h        LLVMBuild.txt
Cpu0.h                    Cpu0RegisterInfo.td       MCTargetDesc
Cpu0InstrFormats.td       Cpu0Schedule.td           TargetInfo
Cpu0InstrInfo.cpp         Cpu0SelectionDAGInfo.cpp
</pre></div>
</div>
<p>Next, copy lld Cpu0 architecture ELF support as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>Gamma@localhost Cpu0<span class="o">]</span><span class="nv">$ </span><span class="nb">cd</span> ../../../tools/lld/lib/ReaderWriter/ELF/
<span class="o">[</span>Gamma@localhost ELF<span class="o">]</span><span class="nv">$ </span><span class="nb">pwd</span>
/home/Gamma/test/lld/src/tools/lld/lib/ReaderWriter/ELF
<span class="o">[</span>Gamma@localhost ELF<span class="o">]</span><span class="nv">$ </span>cp -rf ~/test/lbd/docs/BackendTutorial/
lbdex/Cpu0_lld_1030/Cpu0 .
<span class="o">[</span>Gamma@localhost ELF<span class="o">]</span><span class="nv">$ </span>cp -f ~/test/lbd/docs/BackendTutorial/
lbdex/Cpu0_lld_1030/CMakeLists.txt .
<span class="o">[</span>Gamma@localhost ELF<span class="o">]</span><span class="nv">$ </span>cp -f ~/test/lbd/docs/BackendTutorial/
lbdex/Cpu0_lld_1030/ELFLinkingContext.cpp .
<span class="o">[</span>Gamma@localhost ELF<span class="o">]</span><span class="nv">$ </span>cp -f ~/test/lbd/docs/BackendTutorial/
lbdex/Cpu0_lld_1030/Targets.h .
<span class="o">[</span>Gamma@localhost ELF<span class="o">]</span><span class="nv">$ </span>cp -f ~/test/lbd/docs/BackendTutorial/
lbdex/Cpu0_lld_1030/Resolver.cpp ../../Core/.
</pre></div>
</div>
<p>Finally, update llvm-objdump to support convert ELF file to Hex file as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>Gamma@localhost ELF<span class="o">]</span><span class="nv">$ </span><span class="nb">cd</span> ../../../../llvm-objdump/
<span class="o">[</span>Gamma@localhost llvm-objdump<span class="o">]</span><span class="nv">$ </span><span class="nb">pwd</span>
/home/Gamma/test/lld/src/tools/llvm-objdump
<span class="o">[</span>Gamma@localhost llvm-objdump<span class="o">]</span><span class="nv">$ </span>cp -rf ~/test/lbd/docs/BackendTutorial/
lbdex/llvm-objdump/* .
</pre></div>
</div>
<p>Now, build llvm/lld with Cpu0 support as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>Gamma@localhost cmake_debug_build<span class="o">]</span><span class="nv">$ </span>cmake -DCMAKE_CXX_COMPILER<span class="o">=</span>g++ -
<span class="nv">DCMAKE_C_COMPILER</span><span class="o">=</span>gcc -DCMAKE_CXX_FLAGS<span class="o">=</span>-std<span class="o">=</span>c++11 -DCMAKE_BUILD_TYPE<span class="o">=</span>Debug
-G <span class="s2">&quot;Unix Makefiles&quot;</span> ../src
-- The C compiler identification is GNU 4.7.2
-- The CXX compiler identification is GNU 4.7.2
...
-- Targeting Cpu0
...
-- Configuring <span class="k">done</span>
-- Generating <span class="k">done</span>
-- Build files have been written to: /home/Gamma/test/lld/cmake_debug_build
</pre></div>
</div>
</div>
<div class="section" id="cpu0-lld-souce-code">
<h2>Cpu0 lld souce code<a class="headerlink" href="#cpu0-lld-souce-code" title="Permalink to this headline">¶</a></h2>
<p>The code added on lld to support Cpu0 ELF as follows,</p>
<p class="rubric">lbdex/Cpu0_lld_1030/CMakeLists.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">target_link_libraries</span><span class="p">(</span><span class="n">lldELF</span>
  <span class="p">...</span>
  <span class="n">lldCpu0ELFTarget</span>
  <span class="p">)</span>
</pre></div>
</div>
<p class="rubric">lbdex/Cpu0_lld_1030/ELFLinkingContext.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">uint16_t</span> <span class="n">ELFLinkingContext</span><span class="o">::</span><span class="n">getOutputMachine</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">getTriple</span><span class="p">().</span><span class="n">getArch</span><span class="p">())</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span><span class="o">::</span><span class="nl">cpu0:</span>
    <span class="k">return</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="n">EM_CPU0</span><span class="p">;</span>
  <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/Cpu0_lld_1030/Targets.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;Cpu0/Cpu0Target.h&quot;</span>
</pre></div>
</div>
<p class="rubric">lbdex/Cpu0_lld_1030/Resolver.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">bool</span> <span class="n">Resolver</span><span class="o">::</span><span class="n">checkUndefines</span><span class="p">(</span><span class="kt">bool</span> <span class="n">final</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">_context</span><span class="p">.</span><span class="n">printRemainingUndefines</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">undefAtom</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;_gp_disp&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// cschen debug</span>
          <span class="n">foundUndefines</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="p">...</span>
      <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/Cpu0_lld_1030/Cpu0/CMakeLists.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">add_lld_library</span><span class="p">(</span><span class="n">lldCpu0ELFTarget</span>
  <span class="n">Cpu0LinkingContext</span><span class="p">.</span><span class="n">cpp</span>
  <span class="n">Cpu0TargetHandler</span><span class="p">.</span><span class="n">cpp</span>
  <span class="n">Cpu0RelocationHandler</span><span class="p">.</span><span class="n">cpp</span>
  <span class="n">Cpu0RelocationPass</span><span class="p">.</span><span class="n">cpp</span>
  <span class="p">)</span>

<span class="n">target_link_libraries</span><span class="p">(</span><span class="n">lldCpu0ELFTarget</span>
  <span class="n">lldCore</span>
  <span class="p">)</span>
</pre></div>
</div>
<p class="rubric">lbdex/Cpu0_lld_1030/Cpu0/Cpu0LinkingContext.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">//===- lib/ReaderWriter/ELF/Cpu0/Cpu0LinkingContext.h ---------------------===//</span>
<span class="cp">//</span>
<span class="cp">//                             The LLVM Linker</span>
<span class="cp">//</span>
<span class="cp">// This file is distributed under the University of Illinois Open Source</span>
<span class="cp">// License. See LICENSE.TXT for details.</span>
<span class="cp">//</span>
<span class="cp">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef LLD_READER_WRITER_ELF_CPU0_LINKER_CONTEXT_H</span>
<span class="cp">#define LLD_READER_WRITER_ELF_CPU0_LINKER_CONTEXT_H</span>

<span class="cp">#include &quot;Cpu0TargetHandler.h&quot;</span>

<span class="cp">#include &quot;lld/ReaderWriter/ELFLinkingContext.h&quot;</span>

<span class="cp">#include &quot;llvm/Object/ELF.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/ELF.h&quot;</span>

<span class="k">namespace</span> <span class="n">lld</span> <span class="p">{</span>
<span class="k">namespace</span> <span class="n">elf</span> <span class="p">{</span>
<span class="c1">/// \brief cpu0 internal references.</span>
<span class="k">enum</span> <span class="p">{</span>
  <span class="c1">/// \brief The 32 bit index of the relocation in the got this reference refers</span>
  <span class="c1">/// to.</span>
  <span class="n">LLD_R_CPU0_GOTRELINDEX</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Cpu0LinkingContext</span> <span class="n">LLVM_FINAL</span> <span class="o">:</span> <span class="k">public</span> <span class="n">ELFLinkingContext</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0LinkingContext</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span> <span class="n">triple</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">ELFLinkingContext</span><span class="p">(</span><span class="n">triple</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">TargetHandlerBase</span><span class="o">&gt;</span><span class="p">(</span>
                                  <span class="k">new</span> <span class="n">Cpu0TargetHandler</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)))</span> <span class="p">{}</span>

  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">isLittleEndian</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">addPasses</span><span class="p">(</span><span class="n">PassManager</span> <span class="o">&amp;</span><span class="p">);</span>

  <span class="c1">// Cpu0 run begin from address 0 while X86 from 0x400000</span>
  <span class="k">virtual</span> <span class="n">uint64_t</span> <span class="n">getBaseAddress</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_baseAddress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">return</span> <span class="mh">0x000000</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">_baseAddress</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">isDynamicRelocation</span><span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">&amp;</span><span class="p">,</span>
                                   <span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">kind</span><span class="p">()){</span>
    <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="nl">R_CPU0_GLOB_DAT:</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">isPLTRelocation</span><span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">&amp;</span><span class="p">,</span>
                               <span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">kind</span><span class="p">()){</span>
    <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="nl">R_CPU0_JUMP_SLOT:</span>
    <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="nl">R_CPU0_RELGOT:</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">/// \brief Cpu0 has two relative relocations</span>
  <span class="c1">/// a) for supporting IFUNC - R_CPU0_RELGOT</span>
  <span class="c1">/// b) for supporting relative relocs - R_CPU0_RELATIVE</span>
  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">isRelativeReloc</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">kind</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="nl">R_CPU0_RELGOT:</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">/// \brief Create Internal files for Init/Fini</span>
  <span class="kt">bool</span> <span class="n">createInternalFiles</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

  <span class="k">virtual</span> <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="n">Reference</span><span class="o">::</span><span class="n">Kind</span><span class="o">&gt;</span> <span class="n">relocKindFromString</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">str</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">stringFromRelocKind</span><span class="p">(</span><span class="n">Reference</span><span class="o">::</span><span class="n">Kind</span> <span class="n">kind</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

  <span class="kt">bool</span> <span class="n">isStaticExecutable</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_isStaticExecutable</span><span class="p">;</span> <span class="p">}</span>

<span class="p">};</span>
<span class="p">}</span> <span class="c1">// end namespace elf</span>
<span class="p">}</span> <span class="c1">// end namespace lld</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/Cpu0_lld_1030/Cpu0/Cpu0LinkingContext.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">//===- lib/ReaderWriter/ELF/Cpu0/Cpu0LinkingContext.cpp -------------------===//</span>
<span class="cp">//</span>
<span class="cp">//                             The LLVM Linker</span>
<span class="cp">//</span>
<span class="cp">// This file is distributed under the University of Illinois Open Source</span>
<span class="cp">// License. See LICENSE.TXT for details.</span>
<span class="cp">//</span>
<span class="cp">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0LinkingContext.h&quot;</span>

<span class="cp">#include &quot;lld/Core/File.h&quot;</span>
<span class="cp">#include &quot;lld/Core/Instrumentation.h&quot;</span>

<span class="cp">#include &quot;llvm/ADT/ArrayRef.h&quot;</span>
<span class="cp">#include &quot;llvm/ADT/StringSwitch.h&quot;</span>

<span class="cp">#include &quot;Atoms.h&quot;</span>
<span class="cp">#include &quot;Cpu0RelocationPass.h&quot;</span>


<span class="k">using</span> <span class="k">namespace</span> <span class="n">lld</span><span class="p">;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">lld</span><span class="o">::</span><span class="n">elf</span><span class="p">;</span>

<span class="k">namespace</span> <span class="p">{</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="p">;</span>
<span class="k">const</span> <span class="n">uint8_t</span> <span class="n">cpu0InitFiniAtomContent</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

<span class="c1">// Cpu0_64InitFini Atom</span>
<span class="k">class</span> <span class="nc">Cpu0InitAtom</span> <span class="o">:</span> <span class="k">public</span> <span class="n">InitFiniAtom</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0InitAtom</span><span class="p">(</span><span class="k">const</span> <span class="n">File</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">function</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">InitFiniAtom</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;.init_array&quot;</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__init_fn_&quot;</span><span class="p">;</span>
    <span class="n">_name</span> <span class="o">+=</span> <span class="n">function</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>
  <span class="k">virtual</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span> <span class="n">rawContent</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cpu0InitFiniAtomContent</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">virtual</span> <span class="n">Alignment</span> <span class="n">alignment</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Alignment</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Cpu0FiniAtom</span> <span class="o">:</span> <span class="k">public</span> <span class="n">InitFiniAtom</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0FiniAtom</span><span class="p">(</span><span class="k">const</span> <span class="n">File</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">function</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">InitFiniAtom</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;.fini_array&quot;</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__fini_fn_&quot;</span><span class="p">;</span>
    <span class="n">_name</span> <span class="o">+=</span> <span class="n">function</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>
  <span class="k">virtual</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span> <span class="n">rawContent</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cpu0InitFiniAtomContent</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="n">Alignment</span> <span class="n">alignment</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Alignment</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Cpu0InitFiniFile</span> <span class="o">:</span> <span class="k">public</span> <span class="n">SimpleFile</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0InitFiniFile</span><span class="p">(</span><span class="k">const</span> <span class="n">ELFLinkingContext</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">SimpleFile</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s">&quot;command line option -init/-fini&quot;</span><span class="p">),</span> <span class="n">_ordinal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>

  <span class="kt">void</span> <span class="n">addInitFunction</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Atom</span> <span class="o">*</span><span class="n">initFunctionAtom</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_allocator</span><span class="p">)</span> <span class="n">SimpleUndefinedAtom</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
    <span class="n">Cpu0InitAtom</span> <span class="o">*</span><span class="n">initAtom</span> <span class="o">=</span>
           <span class="p">(</span><span class="k">new</span> <span class="p">(</span><span class="n">_allocator</span><span class="p">)</span> <span class="n">Cpu0InitAtom</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
    <span class="n">initAtom</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="n">R_CPU0_32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">initFunctionAtom</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">initAtom</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">_ordinal</span><span class="o">++</span><span class="p">);</span>
    <span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">initFunctionAtom</span><span class="p">);</span>
    <span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">initAtom</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">addFiniFunction</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Atom</span> <span class="o">*</span><span class="n">finiFunctionAtom</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_allocator</span><span class="p">)</span> <span class="n">SimpleUndefinedAtom</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
    <span class="n">Cpu0FiniAtom</span> <span class="o">*</span><span class="n">finiAtom</span> <span class="o">=</span>
           <span class="p">(</span><span class="k">new</span> <span class="p">(</span><span class="n">_allocator</span><span class="p">)</span> <span class="n">Cpu0FiniAtom</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
    <span class="n">finiAtom</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="n">R_CPU0_32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">finiFunctionAtom</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">finiAtom</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">_ordinal</span><span class="o">++</span><span class="p">);</span>
    <span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">finiFunctionAtom</span><span class="p">);</span>
    <span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">finiAtom</span><span class="p">);</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="n">llvm</span><span class="o">::</span><span class="n">BumpPtrAllocator</span> <span class="n">_allocator</span><span class="p">;</span>
  <span class="n">uint64_t</span> <span class="n">_ordinal</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">}</span> <span class="c1">// end anon namespace</span>

<span class="kt">void</span> <span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span><span class="o">::</span><span class="n">addPasses</span><span class="p">(</span><span class="n">PassManager</span> <span class="o">&amp;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">pass</span> <span class="o">=</span> <span class="n">createCpu0RelocationPass</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">pass</span><span class="p">)</span>
    <span class="n">pm</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">pass</span><span class="p">));</span>
  <span class="n">ELFLinkingContext</span><span class="o">::</span><span class="n">addPasses</span><span class="p">(</span><span class="n">pm</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span><span class="o">::</span><span class="n">createInternalFiles</span><span class="p">(</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">ELFLinkingContext</span><span class="o">::</span><span class="n">createInternalFiles</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Cpu0InitFiniFile</span><span class="o">&gt;</span> <span class="n">initFiniFile</span><span class="p">(</span>
      <span class="k">new</span> <span class="n">Cpu0InitFiniFile</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">));</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">ai</span> <span class="o">:</span> <span class="n">initFunctions</span><span class="p">())</span>
    <span class="n">initFiniFile</span><span class="o">-&gt;</span><span class="n">addInitFunction</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">ai:</span><span class="n">finiFunctions</span><span class="p">())</span>
    <span class="n">initFiniFile</span><span class="o">-&gt;</span><span class="n">addFiniFunction</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
  <span class="n">result</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">initFiniFile</span><span class="p">));</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define LLD_CASE(name) .Case(#name, llvm::ELF::name)</span>

<span class="n">ErrorOr</span><span class="o">&lt;</span><span class="n">Reference</span><span class="o">::</span><span class="n">Kind</span><span class="o">&gt;</span>
<span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span><span class="o">::</span><span class="n">relocKindFromString</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">str</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">int32_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">llvm</span><span class="o">::</span><span class="n">StringSwitch</span><span class="o">&lt;</span><span class="n">int32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_NONE</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_24</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_32</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_HI16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_LO16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_GPREL16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_LITERAL</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_GOT16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_CALL16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_JUMP_SLOT</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;LLD_R_CPU0_GOTRELINDEX&quot;</span><span class="p">,</span> <span class="n">LLD_R_CPU0_GOTRELINDEX</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Default</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">make_error_code</span><span class="p">(</span><span class="n">YamlReaderError</span><span class="o">::</span><span class="n">illegal_value</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#undef LLD_CASE</span>

<span class="cp">#define LLD_CASE(name) case llvm::ELF::name: return std::string(#name);</span>

<span class="n">ErrorOr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span>
<span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span><span class="o">::</span><span class="n">stringFromRelocKind</span><span class="p">(</span><span class="n">Reference</span><span class="o">::</span><span class="n">Kind</span> <span class="n">kind</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_NONE</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_24</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_32</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_HI16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_LO16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_GPREL16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_LITERAL</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_GOT16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_CALL16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_JUMP_SLOT</span><span class="p">)</span>
  <span class="k">case</span> <span class="nl">LLD_R_CPU0_GOTRELINDEX:</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;LLD_R_CPU0_GOTRELINDEX&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">make_error_code</span><span class="p">(</span><span class="n">YamlReaderError</span><span class="o">::</span><span class="n">illegal_value</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/Cpu0_lld_1030/Cpu0/Cpu0RelocationHandler.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">//===- lib/ReaderWriter/ELF/Cpu0/Cpu0RelocationHandler.h</span>
<span class="cp">//------------------===//</span>
<span class="cp">//</span>
<span class="cp">//                             The LLVM Linker</span>
<span class="cp">//</span>
<span class="cp">// This file is distributed under the University of Illinois Open Source</span>
<span class="cp">// License. See LICENSE.TXT for details.</span>
<span class="cp">//</span>
<span class="cp">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef Cpu0_RELOCATION_HANDLER_H</span>
<span class="cp">#define Cpu0_RELOCATION_HANDLER_H</span>

<span class="cp">#include &quot;Cpu0TargetHandler.h&quot;</span>

<span class="k">namespace</span> <span class="n">lld</span> <span class="p">{</span>
<span class="k">namespace</span> <span class="n">elf</span> <span class="p">{</span>
<span class="k">typedef</span> <span class="n">llvm</span><span class="o">::</span><span class="n">object</span><span class="o">::</span><span class="n">ELFType</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">big</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="kc">false</span><span class="o">&gt;</span> <span class="n">Cpu0ELFType</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">Cpu0LinkingContext</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0TargetRelocationHandler</span> <span class="n">LLVM_FINAL</span>
    <span class="o">:</span> <span class="k">public</span> <span class="n">TargetRelocationHandler</span><span class="o">&lt;</span><span class="n">Cpu0ELFType</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0TargetRelocationHandler</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0LinkingContext</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">_tlsSize</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">virtual</span> <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">applyRelocation</span><span class="p">(</span><span class="n">ELFWriter</span> <span class="o">&amp;</span><span class="p">,</span> <span class="n">llvm</span><span class="o">::</span><span class="n">FileOutputBuffer</span> <span class="o">&amp;</span><span class="p">,</span>
                                        <span class="k">const</span> <span class="n">lld</span><span class="o">::</span><span class="n">AtomLayout</span> <span class="o">&amp;</span><span class="p">,</span>
                                        <span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

  <span class="k">virtual</span> <span class="n">int64_t</span> <span class="n">relocAddend</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
  <span class="c1">// Cached size of the TLS segment.</span>
  <span class="k">mutable</span> <span class="n">uint64_t</span> <span class="n">_tlsSize</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">Cpu0LinkingContext</span> <span class="o">&amp;</span><span class="n">_context</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">}</span> <span class="c1">// end namespace elf</span>
<span class="p">}</span> <span class="c1">// end namespace lld</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/Cpu0_lld_1030/Cpu0/Cpu0RelocationHandler.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">//===- lib/ReaderWriter/ELF/Cpu0/Cpu0RelocationHandler.cpp ------------===//</span>
<span class="cp">//</span>
<span class="cp">//                             The LLVM Linker</span>
<span class="cp">//</span>
<span class="cp">// This file is distributed under the University of Illinois Open Source</span>
<span class="cp">// License. See LICENSE.TXT for details.</span>
<span class="cp">//</span>
<span class="cp">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0TargetHandler.h&quot;</span>
<span class="cp">#include &quot;Cpu0LinkingContext.h&quot;</span>
<span class="cp">#include &quot;llvm/Object/ObjectFile.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/raw_ostream.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/system_error.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">lld</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">elf</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">object</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">bool</span> <span class="n">error</span><span class="p">(</span><span class="n">error_code</span> <span class="n">ec</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ec</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Cpu0RelocationHandler.cpp : error reading file: &quot;</span> 
         <span class="o">&lt;&lt;</span> <span class="n">ec</span><span class="p">.</span><span class="n">message</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="n">outs</span><span class="p">().</span><span class="n">flush</span><span class="p">();</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">namespace</span> <span class="p">{</span>
<span class="c1">/// \brief R_CPU0_HI16 - word64: (S + A) &gt;&gt; 16</span>
<span class="kt">void</span> <span class="n">relocHI16</span><span class="p">(</span><span class="n">uint8_t</span> <span class="o">*</span><span class="n">location</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">P</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">S</span><span class="p">,</span> <span class="n">int64_t</span> <span class="n">A</span><span class="p">)</span> <span class="p">{</span>
 <span class="c1">// Don&#39;t know why A, ref.addend(), = 9</span>
  <span class="n">uint32_t</span> <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint32_t</span><span class="p">)(</span><span class="n">S</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
  <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">=</span>
      <span class="n">result</span> <span class="o">|</span>
      <span class="p">(</span><span class="n">uint32_t</span><span class="p">)</span> <span class="o">*</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">location</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">relocLO16</span><span class="p">(</span><span class="n">uint8_t</span> <span class="o">*</span><span class="n">location</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">P</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">S</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">A</span><span class="p">)</span> <span class="p">{</span>
 <span class="c1">// Don&#39;t know why A, ref.addend(), = 9</span>
  <span class="n">uint32_t</span> <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint32_t</span><span class="p">)(</span><span class="n">S</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">);</span>
  <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">=</span>
      <span class="n">result</span> <span class="o">|</span>
      <span class="p">(</span><span class="n">uint32_t</span><span class="p">)</span> <span class="o">*</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">location</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">/// \brief R_CPU0_GOT16 - word32: S</span>
<span class="kt">void</span> <span class="n">relocGOT16</span><span class="p">(</span><span class="n">uint8_t</span> <span class="o">*</span><span class="n">location</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">P</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">S</span><span class="p">,</span> <span class="n">int64_t</span> <span class="n">A</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">uint32_t</span> <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint32_t</span><span class="p">)(</span><span class="n">S</span><span class="p">);</span>
  <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">=</span>
      <span class="n">result</span> <span class="o">|</span>
      <span class="p">(</span><span class="n">uint32_t</span><span class="p">)</span> <span class="o">*</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">location</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">/// \brief R_CPU0_PC24 - word32: S + A - P</span>
<span class="kt">void</span> <span class="n">relocPC24</span><span class="p">(</span><span class="n">uint8_t</span> <span class="o">*</span><span class="n">location</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">P</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">S</span><span class="p">,</span> <span class="n">int64_t</span> <span class="n">A</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">uint32_t</span> <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint32_t</span><span class="p">)(</span><span class="n">S</span>  <span class="o">-</span> <span class="n">P</span><span class="p">);</span>
  <span class="n">uint32_t</span> <span class="n">machinecode</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint32_t</span><span class="p">)</span> <span class="o">*</span> 
                         <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">location</span><span class="p">);</span>
  <span class="n">uint32_t</span> <span class="n">opcode</span> <span class="o">=</span> <span class="p">(</span><span class="n">machinecode</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">);</span>
  <span class="n">uint32_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">machinecode</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">);</span>
  <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">=</span>
      <span class="p">(((</span><span class="n">result</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">)</span> <span class="o">|</span> <span class="n">opcode</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">/// \brief R_CPU0_32 - word24:  S</span>
<span class="kt">void</span> <span class="n">reloc24</span><span class="p">(</span><span class="n">uint8_t</span> <span class="o">*</span><span class="n">location</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">P</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">S</span><span class="p">,</span> <span class="n">int64_t</span> <span class="n">A</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">int32_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint32_t</span><span class="p">)(</span><span class="n">S</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">);</span>
  <span class="n">uint32_t</span> <span class="n">machinecode</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint32_t</span><span class="p">)</span> <span class="o">*</span> 
                         <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">location</span><span class="p">);</span>
  <span class="n">uint32_t</span> <span class="n">opcode</span> <span class="o">=</span> <span class="p">(</span><span class="n">machinecode</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">);</span>
  <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">=</span>
      <span class="p">(</span><span class="n">opcode</span> <span class="o">|</span> <span class="n">addr</span><span class="p">);</span>
  <span class="c1">// TODO: Make sure that the result zero extends to the 64bit value.</span>
<span class="p">}</span>

<span class="c1">/// \brief R_CPU0_32 - word32:  S</span>
<span class="kt">void</span> <span class="n">reloc32</span><span class="p">(</span><span class="n">uint8_t</span> <span class="o">*</span><span class="n">location</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">P</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">S</span><span class="p">,</span> <span class="n">int64_t</span> <span class="n">A</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">int32_t</span> <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint32_t</span><span class="p">)(</span><span class="n">S</span><span class="p">);</span>
  <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">=</span>
      <span class="n">result</span> <span class="o">|</span>
      <span class="p">(</span><span class="n">uint32_t</span><span class="p">)</span> <span class="o">*</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">location</span><span class="p">);</span>
  <span class="c1">// TODO: Make sure that the result zero extends to the 64bit value.</span>
<span class="p">}</span>
<span class="p">}</span> <span class="c1">// end anon namespace</span>

<span class="n">int64_t</span> <span class="n">Cpu0TargetRelocationHandler</span><span class="o">::</span><span class="n">relocAddend</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">kind</span><span class="p">())</span> <span class="p">{</span>
  <span class="k">case</span> <span class="nl">R_CPU0_PC24:</span>
    <span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
  <span class="k">default</span><span class="o">:</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef DLINKER</span>
<span class="k">class</span> <span class="nc">Cpu0SoPlt</span> <span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
  <span class="n">uint32_t</span> <span class="n">funAddr</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">funAddrSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">public</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">createFunAddr</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0LinkingContext</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">,</span> 
                     <span class="n">llvm</span><span class="o">::</span><span class="n">FileOutputBuffer</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
  <span class="c1">// Return function index, 1: 1st function appear on section .text of .so.</span>
  <span class="c1">//   2: 2nd function ...</span>
  <span class="c1">// For example: 3 functions _Z2laii, _Z3fooii and _Z3barv. 1: is _Z2laii </span>
  <span class="c1">//   2 is _Z3fooii, 3: is _Z3barv.</span>
  <span class="kt">int</span> <span class="n">getDynFunIndexByTargetAddr</span><span class="p">(</span><span class="n">uint64_t</span> <span class="n">fAddr</span><span class="p">);</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">Cpu0SoPlt</span><span class="o">::</span><span class="n">createFunAddr</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0LinkingContext</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">,</span> 
                   <span class="n">llvm</span><span class="o">::</span><span class="n">FileOutputBuffer</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">dynsymSection</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">getTargetHandler</span><span class="o">&lt;</span><span class="n">Cpu0ELFType</span><span class="o">&gt;</span><span class="p">().</span><span class="n">targetLayout</span><span class="p">().</span>
                       <span class="n">findOutputSection</span><span class="p">(</span><span class="s">&quot;.dynsym&quot;</span><span class="p">);</span>
  <span class="n">uint64_t</span> <span class="n">dynsymFileOffset</span><span class="p">,</span> <span class="n">dynsymSize</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">dynsymSection</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dynsymFileOffset</span> <span class="o">=</span> <span class="n">dynsymSection</span><span class="o">-&gt;</span><span class="n">fileOffset</span><span class="p">();</span>
    <span class="n">dynsymSize</span> <span class="o">=</span> <span class="n">dynsymSection</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">();</span>
    <span class="n">uint8_t</span> <span class="o">*</span><span class="n">atomContent</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="n">getBufferStart</span><span class="p">()</span> <span class="o">+</span> <span class="n">dynsymFileOffset</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">uint64_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dynsymSize</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">funAddr</span><span class="p">[</span><span class="n">funAddrSize</span><span class="p">]</span> <span class="o">=</span> 
        <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">ubig32_t</span><span class="o">*&gt;</span><span class="p">((</span><span class="n">uint32_t</span><span class="o">*</span><span class="p">)</span>
        <span class="p">(</span><span class="n">atomContent</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
      <span class="n">funAddrSize</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">Cpu0SoPlt</span><span class="o">::</span><span class="n">getDynFunIndexByTargetAddr</span><span class="p">(</span><span class="n">uint64_t</span> <span class="n">fAddr</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">funAddrSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Below statement fix the issue that both __tls_get_addr and first </span>
    <span class="c1">// function has the same file offset 0 issue.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">funAddrSize</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">funAddr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">funAddr</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
      <span class="k">continue</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fAddr</span> <span class="o">==</span> <span class="n">funAddr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">Cpu0SoPlt</span> <span class="n">cpu0SoPlt</span><span class="p">;</span>
<span class="cp">#endif </span><span class="c1">// DLINKER</span>

<span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">Cpu0TargetRelocationHandler</span><span class="o">::</span><span class="n">applyRelocation</span><span class="p">(</span>
    <span class="n">ELFWriter</span> <span class="o">&amp;</span><span class="n">writer</span><span class="p">,</span> <span class="n">llvm</span><span class="o">::</span><span class="n">FileOutputBuffer</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="n">lld</span><span class="o">::</span><span class="n">AtomLayout</span> <span class="o">&amp;</span><span class="n">atom</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#ifdef DLINKER</span>
  <span class="k">static</span> <span class="kt">bool</span> <span class="n">firstTime</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">soName</span><span class="p">(</span><span class="s">&quot;libfoobar.cpu0.so&quot;</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">firstTime</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_context</span><span class="p">.</span><span class="n">getOutputELFType</span><span class="p">()</span> <span class="o">==</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="n">ET_DYN</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cpu0SoPlt</span><span class="p">.</span><span class="n">createFunAddr</span><span class="p">(</span><span class="n">_context</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_context</span><span class="p">.</span><span class="n">getOutputELFType</span><span class="p">()</span> <span class="o">==</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="n">ET_EXEC</span> <span class="o">&amp;&amp;</span> 
             <span class="o">!</span><span class="n">_context</span><span class="p">.</span><span class="n">isStaticExecutable</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">cpu0SoPlt</span><span class="p">.</span><span class="n">createFunAddr</span><span class="p">(</span><span class="n">_context</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">firstTime</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="cp">#endif </span><span class="c1">// DLINKER</span>
  <span class="n">uint8_t</span> <span class="o">*</span><span class="n">atomContent</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="n">getBufferStart</span><span class="p">()</span> <span class="o">+</span> <span class="n">atom</span><span class="p">.</span><span class="n">_fileOffset</span><span class="p">;</span>
  <span class="n">uint8_t</span> <span class="o">*</span><span class="n">location</span> <span class="o">=</span> <span class="n">atomContent</span> <span class="o">+</span> <span class="n">ref</span><span class="p">.</span><span class="n">offsetInAtom</span><span class="p">();</span>
  <span class="n">uint64_t</span> <span class="n">targetVAddress</span> <span class="o">=</span> <span class="n">writer</span><span class="p">.</span><span class="n">addressOfAtom</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">());</span>
  <span class="n">uint64_t</span> <span class="n">relocVAddress</span> <span class="o">=</span> <span class="n">atom</span><span class="p">.</span><span class="n">_virtualAddr</span> <span class="o">+</span> <span class="n">ref</span><span class="p">.</span><span class="n">offsetInAtom</span><span class="p">();</span>
<span class="cp">#if 1 </span><span class="c1">// For case R_CPU0_GOT16:</span>
<span class="c1">//  auto gotAtomIter = _context.getTargetHandler&lt;Cpu0ELFType&gt;().targetLayout().</span>
<span class="c1">//                     findAbsoluteAtom(&quot;_GLOBAL_OFFSET_TABLE_&quot;);</span>
<span class="c1">//  uint64_t globalOffsetTableAddress = writer.addressOfAtom(*gotAtomIter);</span>
<span class="c1">// .got.plt start from _GLOBAL_OFFSET_TABLE_</span>
  <span class="k">auto</span> <span class="n">gotpltSection</span> <span class="o">=</span> <span class="n">_context</span><span class="p">.</span><span class="n">getTargetHandler</span><span class="o">&lt;</span><span class="n">Cpu0ELFType</span><span class="o">&gt;</span><span class="p">().</span><span class="n">targetLayout</span><span class="p">().</span>
                       <span class="n">findOutputSection</span><span class="p">(</span><span class="s">&quot;.got.plt&quot;</span><span class="p">);</span>
  <span class="n">uint64_t</span> <span class="n">gotPltFileOffset</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">gotpltSection</span><span class="p">)</span>
    <span class="n">gotPltFileOffset</span> <span class="o">=</span> <span class="n">gotpltSection</span><span class="o">-&gt;</span><span class="n">fileOffset</span><span class="p">();</span>
  <span class="k">else</span>
    <span class="n">gotPltFileOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

  <span class="k">switch</span> <span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">kind</span><span class="p">())</span> <span class="p">{</span>
  <span class="k">case</span> <span class="nl">R_CPU0_NONE:</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">R_CPU0_HI16:</span>
    <span class="n">relocHI16</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">relocVAddress</span><span class="p">,</span> <span class="n">targetVAddress</span><span class="p">,</span> <span class="n">ref</span><span class="p">.</span><span class="n">addend</span><span class="p">());</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">R_CPU0_LO16:</span>
    <span class="n">relocLO16</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">relocVAddress</span><span class="p">,</span> <span class="n">targetVAddress</span><span class="p">,</span> <span class="n">ref</span><span class="p">.</span><span class="n">addend</span><span class="p">());</span>
    <span class="k">break</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"> // Not support yet</span>
<span class="c">  case R_CPU0_GOT16:</span>
<span class="cp">#if 1</span>
<span class="c">    idx = cpu0SoPlt.getDynFunIndexByTargetAddr(targetVAddress);</span>
<span class="c">    relocGOT16(location, relocVAddress, idx, ref.addend());</span>
<span class="c">#else</span>
<span class="c">    relocGOT16(location, relocVAddress, (targetVAddress - gotPltFileOffset), </span>
<span class="c">               ref.addend());</span>
<span class="cp">#endif</span>
<span class="c">    break;</span>
<span class="cp">#endif</span>
  <span class="k">case</span> <span class="nl">R_CPU0_PC24:</span>
    <span class="n">relocPC24</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">relocVAddress</span><span class="p">,</span> <span class="n">targetVAddress</span><span class="p">,</span> <span class="n">ref</span><span class="p">.</span><span class="n">addend</span><span class="p">());</span>
    <span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef DLINKER</span>
  <span class="k">case</span> <span class="nl">R_CPU0_CALL16:</span>
  <span class="c1">// offset at _GLOBAL_OFFSET_TABLE_ and $gp point to _GLOBAL_OFFSET_TABLE_.</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">cpu0SoPlt</span><span class="p">.</span><span class="n">getDynFunIndexByTargetAddr</span><span class="p">(</span><span class="n">targetVAddress</span><span class="p">);</span>
    <span class="n">reloc32</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">relocVAddress</span><span class="p">,</span> <span class="n">idx</span><span class="o">*</span><span class="mh">0x04</span><span class="o">+</span><span class="mi">16</span><span class="p">,</span> <span class="n">ref</span><span class="p">.</span><span class="n">addend</span><span class="p">());</span>
    <span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="c1">// DLINKER</span>
  <span class="k">case</span> <span class="nl">R_CPU0_24:</span>
    <span class="n">reloc24</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">relocVAddress</span><span class="p">,</span> <span class="n">targetVAddress</span><span class="p">,</span> <span class="n">ref</span><span class="p">.</span><span class="n">addend</span><span class="p">());</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">R_CPU0_32:</span>
    <span class="n">reloc32</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">relocVAddress</span><span class="p">,</span> <span class="n">targetVAddress</span><span class="p">,</span> <span class="n">ref</span><span class="p">.</span><span class="n">addend</span><span class="p">());</span>
    <span class="k">break</span><span class="p">;</span>

  <span class="c1">// Runtime only relocations. Ignore here.</span>
  <span class="k">case</span> <span class="nl">R_CPU0_JUMP_SLOT:</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">lld</span><span class="o">::</span><span class="n">Reference</span><span class="o">::</span><span class="nl">kindLayoutAfter:</span>
  <span class="k">case</span> <span class="n">lld</span><span class="o">::</span><span class="n">Reference</span><span class="o">::</span><span class="nl">kindLayoutBefore:</span>
  <span class="k">case</span> <span class="n">lld</span><span class="o">::</span><span class="n">Reference</span><span class="o">::</span><span class="nl">kindInGroup:</span>
    <span class="k">break</span><span class="p">;</span>

  <span class="k">default</span><span class="o">:</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">str</span><span class="p">;</span>
    <span class="n">llvm</span><span class="o">::</span><span class="n">raw_string_ostream</span> <span class="n">s</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">name</span> <span class="o">=</span> <span class="n">_context</span><span class="p">.</span><span class="n">stringFromRelocKind</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">kind</span><span class="p">());</span>
    <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Unhandled relocation: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">atom</span><span class="p">.</span><span class="n">_atom</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">().</span><span class="n">path</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:&quot;</span>
      <span class="o">&lt;&lt;</span> <span class="n">atom</span><span class="p">.</span><span class="n">_atom</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;@&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ref</span><span class="p">.</span><span class="n">offsetInAtom</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span>
      <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">name</span> <span class="o">?</span> <span class="o">*</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;&lt;unknown&gt;&quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; (&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ref</span><span class="p">.</span><span class="n">kind</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;)&quot;</span><span class="p">;</span>
    <span class="n">s</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>
    <span class="n">llvm_unreachable</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">error_code</span><span class="o">::</span><span class="n">success</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/Cpu0_lld_1030/Cpu0/Cpu0RelocationPass.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">//===- lib/ReaderWriter/ELF/Cpu0/Cpu0RelocationPass.h -----------------===//</span>
<span class="cp">//</span>
<span class="cp">//                             The LLVM Linker</span>
<span class="cp">//</span>
<span class="cp">// This file is distributed under the University of Illinois Open Source</span>
<span class="cp">// License. See LICENSE.TXT for details.</span>
<span class="cp">//</span>
<span class="cp">//===----------------------------------------------------------------------===//</span>
<span class="cp">///</span>
<span class="cp">/// \file</span>
<span class="cp">/// \brief Declares the relocation processing pass for cpu0. This includes</span>
<span class="cp">///   GOT and PLT entries, TLS, COPY, and ifunc.</span>
<span class="cp">///</span>
<span class="cp">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef LLD_READER_WRITER_ELF_CPU0_RELOCATION_PASS_H</span>
<span class="cp">#define LLD_READER_WRITER_ELF_CPU0_RELOCATION_PASS_H</span>

<span class="cp">#include &lt;memory&gt;</span>

<span class="k">namespace</span> <span class="n">lld</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">Pass</span><span class="p">;</span>
<span class="k">namespace</span> <span class="n">elf</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">Cpu0LinkingContext</span><span class="p">;</span>

<span class="c1">/// \brief Create cpu0 relocation pass for the given linking context.</span>
<span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Pass</span><span class="o">&gt;</span>
<span class="n">createCpu0RelocationPass</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0LinkingContext</span> <span class="o">&amp;</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/Cpu0_lld_1030/Cpu0/Cpu0RelocationPass.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">//===- lib/ReaderWriter/ELF/Cpu0/Cpu0RelocationPass.cpp ---------------===//</span>
<span class="cp">//</span>
<span class="cp">//                             The LLVM Linker</span>
<span class="cp">//</span>
<span class="cp">// This file is distributed under the University of Illinois Open Source</span>
<span class="cp">// License. See LICENSE.TXT for details.</span>
<span class="cp">//</span>
<span class="cp">//===----------------------------------------------------------------------===//</span>
<span class="cp">///</span>
<span class="cp">/// \file</span>
<span class="cp">/// \brief Defines the relocation processing pass for Cpu0. This includes</span>
<span class="cp">///   GOT and PLT entries, TLS, and ifunc.</span>
<span class="cp">///</span>
<span class="cp">/// This also includes aditional behaivor that gnu-ld and gold implement but</span>
<span class="cp">/// which is not specified anywhere.</span>
<span class="cp">///</span>
<span class="cp">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0RelocationPass.h&quot;</span>

<span class="cp">#include &quot;lld/ReaderWriter/Simple.h&quot;</span>

<span class="cp">#include &quot;llvm/ADT/DenseMap.h&quot;</span>

<span class="cp">#include &quot;Atoms.h&quot;</span>
<span class="cp">#include &quot;Cpu0LinkingContext.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">lld</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">lld</span><span class="o">::</span><span class="n">elf</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="p">;</span>

<span class="k">namespace</span> <span class="p">{</span>

<span class="c1">// .plt value (entry 0)</span>
<span class="k">const</span> <span class="n">uint8_t</span> <span class="n">cpu0BootAtomContent</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="c1">// jmp _start</span>
  <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="c1">// jmp 4</span>
  <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="c1">// jmp 4</span>
  <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xfc</span> <span class="c1">// jmp -4</span>
<span class="p">};</span>

<span class="cp">#ifdef DLINKER</span>
<span class="c1">// .got values</span>
<span class="k">const</span> <span class="n">uint8_t</span> <span class="n">cpu0GotAtomContent</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

<span class="c1">// .plt value (entry 0)</span>
<span class="k">const</span> <span class="n">uint8_t</span> <span class="n">cpu0Plt0AtomContent</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="c1">// st $lr, $zero, reloc-index ($gp)</span>
  <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="c1">// st $fp, $zero, reloc-index ($gp)</span>
  <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="c1">// st $sp, $zero, reloc-index ($gp)</span>
  <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xfc</span>  <span class="c1">// jmp dynamic_linker</span>
<span class="p">};</span>

<span class="c1">// .plt values (other entries)</span>
<span class="k">const</span> <span class="n">uint8_t</span> <span class="n">cpu0PltAtomContent</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// addiu $t9, $zero, reloc-index (=.dynsym_index)</span>
  <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// st $t9, $zero, reloc-index ($gp)</span>
  <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="c1">// ld $t9, 0x10($gp) (0x10($gp) point to plt0</span>
  <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>  <span class="c1">// ret $t9 // jump to Cpu0.Stub</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="c1">// DLINKER</span>

<span class="c1">/// boot record</span>
<span class="k">class</span> <span class="nc">Cpu0BootAtom</span> <span class="o">:</span> <span class="k">public</span> <span class="n">PLT0Atom</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0BootAtom</span><span class="p">(</span><span class="k">const</span> <span class="n">File</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">)</span> <span class="o">:</span> <span class="n">PLT0Atom</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;.PLT0&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>
  <span class="k">virtual</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span> <span class="n">rawContent</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cpu0BootAtomContent</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#ifdef DLINKER</span>
<span class="c1">/// \brief Atoms that are used by Cpu0 dynamic linking</span>
<span class="k">class</span> <span class="nc">Cpu0GOTAtom</span> <span class="o">:</span> <span class="k">public</span> <span class="n">GOTAtom</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="k">const</span> <span class="n">File</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">secName</span><span class="p">)</span> <span class="o">:</span> <span class="n">GOTAtom</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">secName</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">virtual</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span> <span class="n">rawContent</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cpu0GotAtomContent</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Cpu0PLT0Atom</span> <span class="o">:</span> <span class="k">public</span> <span class="n">PLT0Atom</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0PLT0Atom</span><span class="p">(</span><span class="k">const</span> <span class="n">File</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">)</span> <span class="o">:</span> <span class="n">PLT0Atom</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;.PLT0&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>
  <span class="k">virtual</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span> <span class="n">rawContent</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cpu0Plt0AtomContent</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Cpu0PLTAtom</span> <span class="o">:</span> <span class="k">public</span> <span class="n">PLTAtom</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0PLTAtom</span><span class="p">(</span><span class="k">const</span> <span class="n">File</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">secName</span><span class="p">)</span> <span class="o">:</span> <span class="n">PLTAtom</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">secName</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">virtual</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span> <span class="n">rawContent</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cpu0PltAtomContent</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="c1">// DLINKER</span>

<span class="k">class</span> <span class="nc">ELFPassFile</span> <span class="o">:</span> <span class="k">public</span> <span class="n">SimpleFile</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">ELFPassFile</span><span class="p">(</span><span class="k">const</span> <span class="n">ELFLinkingContext</span> <span class="o">&amp;</span><span class="n">eti</span><span class="p">)</span> <span class="o">:</span> <span class="n">SimpleFile</span><span class="p">(</span><span class="n">eti</span><span class="p">,</span> <span class="s">&quot;ELFPassFile&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">setOrdinal</span><span class="p">(</span><span class="n">eti</span><span class="p">.</span><span class="n">getNextOrdinalAndIncrement</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">llvm</span><span class="o">::</span><span class="n">BumpPtrAllocator</span> <span class="n">_alloc</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">/// \brief CRTP base for handling relocations.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Derived</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">RelocationPass</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Pass</span> <span class="p">{</span>
  <span class="c1">/// \brief Handle a specific reference.</span>
  <span class="kt">void</span> <span class="n">handleReference</span><span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">&amp;</span><span class="n">atom</span><span class="p">,</span> <span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">kind</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">R_CPU0_CALL16:</span>
      <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Derived</span> <span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">handlePLT32</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nl">R_CPU0_PC24:</span>
      <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Derived</span> <span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">handlePlain</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="k">protected</span><span class="o">:</span>
<span class="cp">#ifdef DLINKER</span>
  <span class="c1">/// \brief get the PLT entry for a given IFUNC Atom.</span>
  <span class="c1">///</span>
  <span class="c1">/// If the entry does not exist. Both the GOT and PLT entry is created.</span>
  <span class="k">const</span> <span class="n">PLTAtom</span> <span class="o">*</span><span class="n">getIFUNCPLTEntry</span><span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">*</span><span class="n">da</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">_pltMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">da</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">plt</span> <span class="o">!=</span> <span class="n">_pltMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
      <span class="k">return</span> <span class="n">plt</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">ga</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got.plt&quot;</span><span class="p">);</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_RELGOT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">pa</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0PLTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.plt&quot;</span><span class="p">);</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ga</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got_ifunc_&quot;</span><span class="p">;</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">da</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__plt_ifunc_&quot;</span><span class="p">;</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">da</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
<span class="cp">#endif</span>
    <span class="n">_gotMap</span><span class="p">[</span><span class="n">da</span><span class="p">]</span> <span class="o">=</span> <span class="n">ga</span><span class="p">;</span>
    <span class="n">_pltMap</span><span class="p">[</span><span class="n">da</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
    <span class="n">_gotVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ga</span><span class="p">);</span>
    <span class="n">_pltVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pa</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">pa</span><span class="p">;</span>
  <span class="p">}</span>
<span class="cp">#endif </span><span class="c1">// DLINKER</span>

  <span class="c1">/// \brief Redirect the call to the PLT stub for the target IFUNC.</span>
  <span class="c1">///</span>
  <span class="c1">/// This create a PLT and GOT entry for the IFUNC if one does not exist. The</span>
  <span class="c1">/// GOT entry and a IRELATIVE relocation to the original target resolver.</span>
  <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">handleIFUNC</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">target</span> <span class="o">=</span> <span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">());</span>
<span class="cp">#ifdef DLINKER</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">&amp;&amp;</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">contentType</span><span class="p">()</span> <span class="o">==</span> <span class="n">DefinedAtom</span><span class="o">::</span><span class="n">typeResolver</span><span class="p">)</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getIFUNCPLTEntry</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
<span class="cp">#endif </span><span class="c1">// DLINKER</span>
    <span class="k">return</span> <span class="n">error_code</span><span class="o">::</span><span class="n">success</span><span class="p">();</span>
  <span class="p">}</span>

<span class="cp">#ifdef DLINKER</span>
  <span class="c1">/// \brief Create a GOT entry for the TP offset of a TLS atom.</span>
  <span class="k">const</span> <span class="n">GOTAtom</span> <span class="o">*</span><span class="n">getGOTTPOFF</span><span class="p">(</span><span class="k">const</span> <span class="n">Atom</span> <span class="o">*</span><span class="n">atom</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">got</span> <span class="o">=</span> <span class="n">_gotMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">atom</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">got</span> <span class="o">==</span> <span class="n">_gotMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">auto</span> <span class="n">g</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got&quot;</span><span class="p">);</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_TLS_TPREL32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got_tls_&quot;</span><span class="p">;</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">atom</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
<span class="cp">#endif</span>
      <span class="n">_gotMap</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
      <span class="n">_gotVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">g</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">got</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">/// \brief Create a GOT entry containing 0.</span>
  <span class="k">const</span> <span class="n">GOTAtom</span> <span class="o">*</span><span class="n">getNullGOT</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_null</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got.plt&quot;</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
      <span class="n">_null</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got_null&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">GOTAtom</span> <span class="o">*</span><span class="n">getGOT</span><span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">*</span><span class="n">da</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">got</span> <span class="o">=</span> <span class="n">_gotMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">da</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">got</span> <span class="o">==</span> <span class="n">_gotMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">auto</span> <span class="n">g</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got&quot;</span><span class="p">);</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got_&quot;</span><span class="p">;</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">da</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
<span class="cp">#endif</span>
      <span class="n">_gotMap</span><span class="p">[</span><span class="n">da</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
      <span class="n">_gotVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">g</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">got</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
  <span class="p">}</span>
<span class="cp">#endif </span><span class="c1">// DLINKER</span>

<span class="k">public</span><span class="o">:</span>
  <span class="n">RelocationPass</span><span class="p">(</span><span class="k">const</span> <span class="n">ELFLinkingContext</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">_file</span><span class="p">(</span><span class="n">ctx</span><span class="p">),</span> <span class="n">_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">),</span> <span class="n">_null</span><span class="p">(</span><span class="n">nullptr</span><span class="p">),</span> <span class="n">_PLT0</span><span class="p">(</span><span class="n">nullptr</span><span class="p">),</span> <span class="n">_got0</span><span class="p">(</span><span class="n">nullptr</span><span class="p">),</span> 
        <span class="n">_boot</span><span class="p">(</span><span class="k">new</span> <span class="n">Cpu0BootAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">))</span> <span class="p">{}</span>

  <span class="c1">/// \brief Do the pass.</span>
  <span class="c1">///</span>
  <span class="c1">/// The goal here is to first process each reference individually. Each call</span>
  <span class="c1">/// to handleReference may modify the reference itself and/or create new</span>
  <span class="c1">/// atoms which must be stored in one of the maps below.</span>
  <span class="c1">///</span>
  <span class="c1">/// After all references are handled, the atoms created during that are all</span>
  <span class="c1">/// added to mf.</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">perform</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">MutableFile</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">mf</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ScopedTask</span> <span class="n">task</span><span class="p">(</span><span class="n">getDefaultDomain</span><span class="p">(),</span> <span class="s">&quot;Cpu0 GOT/PLT Pass&quot;</span><span class="p">);</span>
    <span class="c1">// Process all references.</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="n">atom</span> <span class="o">:</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">defined</span><span class="p">())</span>
      <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="n">ref</span> <span class="o">:</span> <span class="o">*</span><span class="n">atom</span><span class="p">)</span>
        <span class="n">handleReference</span><span class="p">(</span><span class="o">*</span><span class="n">atom</span><span class="p">,</span> <span class="o">*</span><span class="n">ref</span><span class="p">);</span>

    <span class="c1">// Add all created atoms to the link.</span>
    <span class="n">uint64_t</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_ctx</span><span class="p">.</span><span class="n">getOutputELFType</span><span class="p">()</span> <span class="o">==</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="n">ET_EXEC</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">MutableFile</span><span class="o">::</span><span class="n">DefinedAtomRange</span> <span class="n">atomRange</span> <span class="o">=</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">definedAtoms</span><span class="p">();</span>
      <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">atomRange</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
      <span class="kt">bool</span> <span class="n">find</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">it</span> <span class="o">=</span> <span class="n">atomRange</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">it</span> <span class="o">&lt;</span> <span class="n">atomRange</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="n">it</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">it</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;_Z5startv&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">find</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">find</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;not found _Z5startv</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">_boot</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">it</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span>
      <span class="n">_boot</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">ordinal</span><span class="o">++</span><span class="p">);</span>
      <span class="n">mf</span><span class="o">-&gt;</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">_boot</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#ifdef DLINKER</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_PLT0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">MutableFile</span><span class="o">::</span><span class="n">DefinedAtomRange</span> <span class="n">atomRange</span> <span class="o">=</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">definedAtoms</span><span class="p">();</span>
      <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">atomRange</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
      <span class="kt">bool</span> <span class="n">find</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">it</span> <span class="o">=</span> <span class="n">atomRange</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">it</span> <span class="o">&lt;</span> <span class="n">atomRange</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="n">it</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">it</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;_Z14dynamic_linkerv&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">find</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">find</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;Cannot find _Z14dynamic_linkerv()&quot;</span><span class="p">);</span>
      <span class="n">_PLT0</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="o">*</span><span class="n">it</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span>
      <span class="n">_PLT0</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">ordinal</span><span class="o">++</span><span class="p">);</span>
      <span class="n">mf</span><span class="o">-&gt;</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">_PLT0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">plt</span> <span class="o">:</span> <span class="n">_pltVector</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">plt</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">ordinal</span><span class="o">++</span><span class="p">);</span>
      <span class="n">mf</span><span class="o">-&gt;</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">plt</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_null</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">ordinal</span><span class="o">++</span><span class="p">);</span>
      <span class="n">mf</span><span class="o">-&gt;</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">_null</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_PLT0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_got0</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">ordinal</span><span class="o">++</span><span class="p">);</span>
      <span class="n">mf</span><span class="o">-&gt;</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">_got0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">got</span> <span class="o">:</span> <span class="n">_gotVector</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">got</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">ordinal</span><span class="o">++</span><span class="p">);</span>
      <span class="n">mf</span><span class="o">-&gt;</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">got</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif </span><span class="c1">// DLINKER</span>
  <span class="p">}</span>

<span class="k">protected</span><span class="o">:</span>
  <span class="c1">/// \brief Owner of all the Atoms created by this pass.</span>
  <span class="n">ELFPassFile</span> <span class="n">_file</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">ELFLinkingContext</span> <span class="o">&amp;</span><span class="n">_ctx</span><span class="p">;</span>

  <span class="c1">/// \brief Map Atoms to their GOT entries.</span>
  <span class="n">llvm</span><span class="o">::</span><span class="n">DenseMap</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Atom</span> <span class="o">*</span><span class="p">,</span> <span class="n">GOTAtom</span> <span class="o">*&gt;</span> <span class="n">_gotMap</span><span class="p">;</span>

  <span class="c1">/// \brief Map Atoms to their PLT entries.</span>
  <span class="n">llvm</span><span class="o">::</span><span class="n">DenseMap</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Atom</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLTAtom</span> <span class="o">*&gt;</span> <span class="n">_pltMap</span><span class="p">;</span>
  <span class="c1">/// \brief the list of GOT/PLT atoms</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">GOTAtom</span> <span class="o">*&gt;</span> <span class="n">_gotVector</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PLTAtom</span> <span class="o">*&gt;</span> <span class="n">_pltVector</span><span class="p">;</span>
  <span class="n">PLT0Atom</span> <span class="o">*</span><span class="n">_boot</span><span class="p">;</span>

  <span class="c1">/// \brief GOT entry that is always 0. Used for undefined weaks.</span>
  <span class="n">GOTAtom</span> <span class="o">*</span><span class="n">_null</span><span class="p">;</span>

  <span class="c1">/// \brief The got and plt entries for .PLT0. This is used to call into the</span>
  <span class="c1">/// dynamic linker for symbol resolution.</span>
  <span class="c1">/// @{</span>
  <span class="n">PLT0Atom</span> <span class="o">*</span><span class="n">_PLT0</span><span class="p">;</span>
  <span class="n">GOTAtom</span> <span class="o">*</span><span class="n">_got0</span><span class="p">;</span>
  <span class="c1">/// @}</span>
<span class="p">};</span>

<span class="c1">/// This implements the static relocation model. Meaning GOT and PLT entries are</span>
<span class="c1">/// not created for references that can be directly resolved. These are</span>
<span class="c1">/// converted to a direct relocation. For entries that do require a GOT or PLT</span>
<span class="c1">/// entry, that entry is statically bound.</span>
<span class="c1">///</span>
<span class="c1">/// TLS always assumes module 1 and attempts to remove indirection.</span>
<span class="k">class</span> <span class="nc">StaticRelocationPass</span> <span class="n">LLVM_FINAL</span>
    <span class="o">:</span> <span class="k">public</span> <span class="n">RelocationPass</span><span class="o">&lt;</span><span class="n">StaticRelocationPass</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">StaticRelocationPass</span><span class="p">(</span><span class="k">const</span> <span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">RelocationPass</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">handlePlain</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">handleIFUNC</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span> <span class="p">}</span>

  <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">handlePLT32</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// __tls_get_addr is handled elsewhere.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;__tls_get_addr&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setKind</span><span class="p">(</span><span class="n">R_CPU0_NONE</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">error_code</span><span class="o">::</span><span class="n">success</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span>
      <span class="c1">// Static code doesn&#39;t need PLTs.</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setKind</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">);</span>
    <span class="c1">// Handle IFUNC.</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">*</span><span class="n">da</span> <span class="o">=</span>
            <span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">da</span><span class="o">-&gt;</span><span class="n">contentType</span><span class="p">()</span> <span class="o">==</span> <span class="n">DefinedAtom</span><span class="o">::</span><span class="n">typeResolver</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">handleIFUNC</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">error_code</span><span class="o">::</span><span class="n">success</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">handleGOT</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">UndefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getNullGOT</span><span class="p">());</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">*</span><span class="n">da</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getGOT</span><span class="p">(</span><span class="n">da</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">error_code</span><span class="o">::</span><span class="n">success</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#ifdef DLINKER</span>
<span class="k">class</span> <span class="nc">DynamicRelocationPass</span> <span class="n">LLVM_FINAL</span>
    <span class="o">:</span> <span class="k">public</span> <span class="n">RelocationPass</span><span class="o">&lt;</span><span class="n">DynamicRelocationPass</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">DynamicRelocationPass</span><span class="p">(</span><span class="k">const</span> <span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">RelocationPass</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">const</span> <span class="n">PLT0Atom</span> <span class="o">*</span><span class="n">getPLT0</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_PLT0</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">_PLT0</span><span class="p">;</span>
    <span class="c1">// Fill in the null entry.</span>
    <span class="n">getNullGOT</span><span class="p">();</span>
    <span class="n">_PLT0</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0PLT0Atom</span><span class="p">(</span><span class="n">_file</span><span class="p">);</span>
    <span class="n">_got0</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got.plt&quot;</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="n">_got0</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got0&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="k">return</span> <span class="n">_PLT0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">PLTAtom</span> <span class="o">*</span><span class="n">getPLTEntry</span><span class="p">(</span><span class="k">const</span> <span class="n">Atom</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">_pltMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">plt</span> <span class="o">!=</span> <span class="n">_pltMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
      <span class="k">return</span> <span class="n">plt</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">ga</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got.plt&quot;</span><span class="p">);</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_JUMP_SLOT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">pa</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0PLTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.plt&quot;</span><span class="p">);</span>
    <span class="n">getPLT0</span><span class="p">();</span>  <span class="c1">// add _PLT0 and _got0</span>
    <span class="c1">// Set the starting address of the got entry to the second instruction in</span>
    <span class="c1">// the plt entry.</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got_&quot;</span><span class="p">;</span>
    <span class="n">ga</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__plt_&quot;</span><span class="p">;</span>
    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
<span class="cp">#endif</span>
    <span class="n">_gotMap</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">ga</span><span class="p">;</span>
    <span class="n">_pltMap</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
    <span class="n">_gotVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ga</span><span class="p">);</span>
    <span class="n">_pltVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pa</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">pa</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">handlePlain</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">())</span>
      <span class="k">return</span> <span class="n">error_code</span><span class="o">::</span><span class="n">success</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">sla</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">SharedLibraryAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">sla</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="n">SharedLibraryAtom</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">Code</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getPLTEntry</span><span class="p">(</span><span class="n">sla</span><span class="p">));</span>
        <span class="c1">// When caller of execution file call shared library function</span>
        <span class="c1">// Turn this into a PC24 to the PLT entry.</span>
        <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setKind</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span>
      <span class="k">return</span> <span class="n">handleIFUNC</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">error_code</span><span class="o">::</span><span class="n">success</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">handlePLT32</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Handle IFUNC.</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">*</span><span class="n">da</span> <span class="o">=</span>
            <span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">da</span><span class="o">-&gt;</span><span class="n">contentType</span><span class="p">()</span> <span class="o">==</span> <span class="n">DefinedAtom</span><span class="o">::</span><span class="n">typeResolver</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">handleIFUNC</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">SharedLibraryAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span> <span class="p">{</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getPLTEntry</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()));</span>
<span class="cp">      // Turn this into a PC24 to the PLT entry.</span>
<span class="cp">    #if 1</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setKind</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">);</span>
<span class="cp">    #endif</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">error_code</span><span class="o">::</span><span class="n">success</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">GOTAtom</span> <span class="o">*</span><span class="n">getSharedGOT</span><span class="p">(</span><span class="k">const</span> <span class="n">SharedLibraryAtom</span> <span class="o">*</span><span class="n">sla</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">got</span> <span class="o">=</span> <span class="n">_gotMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">sla</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">got</span> <span class="o">==</span> <span class="n">_gotMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">auto</span> <span class="n">g</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_file</span><span class="p">.</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">Cpu0GOTAtom</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s">&quot;.got.dyn&quot;</span><span class="p">);</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">R_CPU0_GLOB_DAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sla</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifndef NDEBUG</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__got_&quot;</span><span class="p">;</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">_name</span> <span class="o">+=</span> <span class="n">sla</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
<span class="cp">#endif</span>
      <span class="n">_gotMap</span><span class="p">[</span><span class="n">sla</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
      <span class="n">_gotVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">g</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">got</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">handleGOT</span><span class="p">(</span><span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">UndefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getNullGOT</span><span class="p">());</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">DefinedAtom</span> <span class="o">*</span><span class="n">da</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DefinedAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getGOT</span><span class="p">(</span><span class="n">da</span><span class="p">));</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="n">sla</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">SharedLibraryAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">target</span><span class="p">()))</span>
      <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Reference</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">ref</span><span class="p">).</span><span class="n">setTarget</span><span class="p">(</span><span class="n">getSharedGOT</span><span class="p">(</span><span class="n">sla</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">error_code</span><span class="o">::</span><span class="n">success</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="c1">// DLINKER</span>
<span class="p">}</span> <span class="c1">// end anon namespace</span>

<span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Pass</span><span class="o">&gt;</span>
<span class="n">lld</span><span class="o">::</span><span class="n">elf</span><span class="o">::</span><span class="n">createCpu0RelocationPass</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0LinkingContext</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">getOutputELFType</span><span class="p">())</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="nl">ET_EXEC:</span>
<span class="cp">#ifdef DLINKER</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">isDynamic</span><span class="p">())</span>
      <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Pass</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">DynamicRelocationPass</span><span class="p">(</span><span class="n">ctx</span><span class="p">));</span>
    <span class="k">else</span>
<span class="cp">#endif </span><span class="c1">// DLINKER</span>
      <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Pass</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">StaticRelocationPass</span><span class="p">(</span><span class="n">ctx</span><span class="p">));</span>
<span class="cp">#ifdef DLINKER</span>
  <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="nl">ET_DYN:</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Pass</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">DynamicRelocationPass</span><span class="p">(</span><span class="n">ctx</span><span class="p">));</span>
<span class="cp">#endif </span><span class="c1">// DLINKER</span>
  <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="nl">ET_REL:</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Pass</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="k">default</span><span class="o">:</span>
    <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;Unhandled output file type&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/Cpu0_lld_1030/Cpu0/Cpu0LinkingContext.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">//===- lib/ReaderWriter/ELF/Cpu0/Cpu0LinkingContext.cpp -------------------===//</span>
<span class="cp">//</span>
<span class="cp">//                             The LLVM Linker</span>
<span class="cp">//</span>
<span class="cp">// This file is distributed under the University of Illinois Open Source</span>
<span class="cp">// License. See LICENSE.TXT for details.</span>
<span class="cp">//</span>
<span class="cp">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0LinkingContext.h&quot;</span>

<span class="cp">#include &quot;lld/Core/File.h&quot;</span>
<span class="cp">#include &quot;lld/Core/Instrumentation.h&quot;</span>

<span class="cp">#include &quot;llvm/ADT/ArrayRef.h&quot;</span>
<span class="cp">#include &quot;llvm/ADT/StringSwitch.h&quot;</span>

<span class="cp">#include &quot;Atoms.h&quot;</span>
<span class="cp">#include &quot;Cpu0RelocationPass.h&quot;</span>


<span class="k">using</span> <span class="k">namespace</span> <span class="n">lld</span><span class="p">;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">lld</span><span class="o">::</span><span class="n">elf</span><span class="p">;</span>

<span class="k">namespace</span> <span class="p">{</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="p">;</span>
<span class="k">const</span> <span class="n">uint8_t</span> <span class="n">cpu0InitFiniAtomContent</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

<span class="c1">// Cpu0_64InitFini Atom</span>
<span class="k">class</span> <span class="nc">Cpu0InitAtom</span> <span class="o">:</span> <span class="k">public</span> <span class="n">InitFiniAtom</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0InitAtom</span><span class="p">(</span><span class="k">const</span> <span class="n">File</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">function</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">InitFiniAtom</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;.init_array&quot;</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__init_fn_&quot;</span><span class="p">;</span>
    <span class="n">_name</span> <span class="o">+=</span> <span class="n">function</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>
  <span class="k">virtual</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span> <span class="n">rawContent</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cpu0InitFiniAtomContent</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">virtual</span> <span class="n">Alignment</span> <span class="n">alignment</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Alignment</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Cpu0FiniAtom</span> <span class="o">:</span> <span class="k">public</span> <span class="n">InitFiniAtom</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0FiniAtom</span><span class="p">(</span><span class="k">const</span> <span class="n">File</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">function</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">InitFiniAtom</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;.fini_array&quot;</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s">&quot;__fini_fn_&quot;</span><span class="p">;</span>
    <span class="n">_name</span> <span class="o">+=</span> <span class="n">function</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>
  <span class="k">virtual</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span> <span class="n">rawContent</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cpu0InitFiniAtomContent</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="n">Alignment</span> <span class="n">alignment</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Alignment</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Cpu0InitFiniFile</span> <span class="o">:</span> <span class="k">public</span> <span class="n">SimpleFile</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0InitFiniFile</span><span class="p">(</span><span class="k">const</span> <span class="n">ELFLinkingContext</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">SimpleFile</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s">&quot;command line option -init/-fini&quot;</span><span class="p">),</span> <span class="n">_ordinal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>

  <span class="kt">void</span> <span class="n">addInitFunction</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Atom</span> <span class="o">*</span><span class="n">initFunctionAtom</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_allocator</span><span class="p">)</span> <span class="n">SimpleUndefinedAtom</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
    <span class="n">Cpu0InitAtom</span> <span class="o">*</span><span class="n">initAtom</span> <span class="o">=</span>
           <span class="p">(</span><span class="k">new</span> <span class="p">(</span><span class="n">_allocator</span><span class="p">)</span> <span class="n">Cpu0InitAtom</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
    <span class="n">initAtom</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="n">R_CPU0_32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">initFunctionAtom</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">initAtom</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">_ordinal</span><span class="o">++</span><span class="p">);</span>
    <span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">initFunctionAtom</span><span class="p">);</span>
    <span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">initAtom</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">addFiniFunction</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Atom</span> <span class="o">*</span><span class="n">finiFunctionAtom</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">_allocator</span><span class="p">)</span> <span class="n">SimpleUndefinedAtom</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
    <span class="n">Cpu0FiniAtom</span> <span class="o">*</span><span class="n">finiAtom</span> <span class="o">=</span>
           <span class="p">(</span><span class="k">new</span> <span class="p">(</span><span class="n">_allocator</span><span class="p">)</span> <span class="n">Cpu0FiniAtom</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
    <span class="n">finiAtom</span><span class="o">-&gt;</span><span class="n">addReference</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="n">R_CPU0_32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">finiFunctionAtom</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">finiAtom</span><span class="o">-&gt;</span><span class="n">setOrdinal</span><span class="p">(</span><span class="n">_ordinal</span><span class="o">++</span><span class="p">);</span>
    <span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">finiFunctionAtom</span><span class="p">);</span>
    <span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="n">finiAtom</span><span class="p">);</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="n">llvm</span><span class="o">::</span><span class="n">BumpPtrAllocator</span> <span class="n">_allocator</span><span class="p">;</span>
  <span class="n">uint64_t</span> <span class="n">_ordinal</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">}</span> <span class="c1">// end anon namespace</span>

<span class="kt">void</span> <span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span><span class="o">::</span><span class="n">addPasses</span><span class="p">(</span><span class="n">PassManager</span> <span class="o">&amp;</span><span class="n">pm</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">pass</span> <span class="o">=</span> <span class="n">createCpu0RelocationPass</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">pass</span><span class="p">)</span>
    <span class="n">pm</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">pass</span><span class="p">));</span>
  <span class="n">ELFLinkingContext</span><span class="o">::</span><span class="n">addPasses</span><span class="p">(</span><span class="n">pm</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span><span class="o">::</span><span class="n">createInternalFiles</span><span class="p">(</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">ELFLinkingContext</span><span class="o">::</span><span class="n">createInternalFiles</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Cpu0InitFiniFile</span><span class="o">&gt;</span> <span class="n">initFiniFile</span><span class="p">(</span>
      <span class="k">new</span> <span class="n">Cpu0InitFiniFile</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">));</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">ai</span> <span class="o">:</span> <span class="n">initFunctions</span><span class="p">())</span>
    <span class="n">initFiniFile</span><span class="o">-&gt;</span><span class="n">addInitFunction</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">ai:</span><span class="n">finiFunctions</span><span class="p">())</span>
    <span class="n">initFiniFile</span><span class="o">-&gt;</span><span class="n">addFiniFunction</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
  <span class="n">result</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">initFiniFile</span><span class="p">));</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define LLD_CASE(name) .Case(#name, llvm::ELF::name)</span>

<span class="n">ErrorOr</span><span class="o">&lt;</span><span class="n">Reference</span><span class="o">::</span><span class="n">Kind</span><span class="o">&gt;</span>
<span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span><span class="o">::</span><span class="n">relocKindFromString</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">str</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">int32_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">llvm</span><span class="o">::</span><span class="n">StringSwitch</span><span class="o">&lt;</span><span class="n">int32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_NONE</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_24</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_32</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_HI16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_LO16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_GPREL16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_LITERAL</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_GOT16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_CALL16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_JUMP_SLOT</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;LLD_R_CPU0_GOTRELINDEX&quot;</span><span class="p">,</span> <span class="n">LLD_R_CPU0_GOTRELINDEX</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Default</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">make_error_code</span><span class="p">(</span><span class="n">YamlReaderError</span><span class="o">::</span><span class="n">illegal_value</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#undef LLD_CASE</span>

<span class="cp">#define LLD_CASE(name) case llvm::ELF::name: return std::string(#name);</span>

<span class="n">ErrorOr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span>
<span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span><span class="o">::</span><span class="n">stringFromRelocKind</span><span class="p">(</span><span class="n">Reference</span><span class="o">::</span><span class="n">Kind</span> <span class="n">kind</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_NONE</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_24</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_32</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_HI16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_LO16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_GPREL16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_LITERAL</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_GOT16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_CALL16</span><span class="p">)</span>
  <span class="n">LLD_CASE</span><span class="p">(</span><span class="n">R_CPU0_JUMP_SLOT</span><span class="p">)</span>
  <span class="k">case</span> <span class="nl">LLD_R_CPU0_GOTRELINDEX:</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;LLD_R_CPU0_GOTRELINDEX&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">make_error_code</span><span class="p">(</span><span class="n">YamlReaderError</span><span class="o">::</span><span class="n">illegal_value</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/Cpu0_lld_1030/Cpu0/Cpu0Target.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">//===- lib/ReaderWriter/ELF/Cpu0/Cpu0Target.h -------------------------===//</span>
<span class="cp">//</span>
<span class="cp">//                             The LLVM Linker</span>
<span class="cp">//</span>
<span class="cp">// This file is distributed under the University of Illinois Open Source</span>
<span class="cp">// License. See LICENSE.TXT for details.</span>
<span class="cp">//</span>
<span class="cp">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0LinkingContext.h&quot;</span>
</pre></div>
</div>
<p class="rubric">lbdex/Cpu0_lld_1030/Cpu0/Cpu0TargetHandler.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">//===- lib/ReaderWriter/ELF/Cpu0/Cpu0TargetHandler.h ------------------===//</span>
<span class="cp">//</span>
<span class="cp">//                             The LLVM Linker</span>
<span class="cp">//</span>
<span class="cp">// This file is distributed under the University of Illinois Open Source</span>
<span class="cp">// License. See LICENSE.TXT for details.</span>
<span class="cp">//</span>
<span class="cp">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef LLD_READER_WRITER_ELF_Cpu0_TARGET_HANDLER_H</span>
<span class="cp">#define LLD_READER_WRITER_ELF_Cpu0_TARGET_HANDLER_H</span>

<span class="cp">#include &quot;DefaultTargetHandler.h&quot;</span>
<span class="cp">#include &quot;File.h&quot;</span>
<span class="cp">#include &quot;Cpu0RelocationHandler.h&quot;</span>
<span class="cp">#include &quot;TargetLayout.h&quot;</span>

<span class="cp">#include &quot;lld/ReaderWriter/Simple.h&quot;</span>

<span class="cp">#include &quot;lld/Core/Atom.h&quot;</span>

<span class="cp">#define DLINKER</span>

<span class="k">namespace</span> <span class="n">lld</span> <span class="p">{</span>
<span class="k">namespace</span> <span class="n">elf</span> <span class="p">{</span>
<span class="k">typedef</span> <span class="n">llvm</span><span class="o">::</span><span class="n">object</span><span class="o">::</span><span class="n">ELFType</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">support</span><span class="o">::</span><span class="n">big</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="kc">false</span><span class="o">&gt;</span> <span class="n">Cpu0ELFType</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">Cpu0LinkingContext</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0TargetHandler</span> <span class="n">LLVM_FINAL</span>
    <span class="o">:</span> <span class="k">public</span> <span class="n">DefaultTargetHandler</span><span class="o">&lt;</span><span class="n">Cpu0ELFType</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0TargetHandler</span><span class="p">(</span><span class="n">Cpu0LinkingContext</span> <span class="o">&amp;</span><span class="n">targetInfo</span><span class="p">);</span>

  <span class="k">virtual</span> <span class="n">TargetLayout</span><span class="o">&lt;</span><span class="n">Cpu0ELFType</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">targetLayout</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">_targetLayout</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="k">const</span> <span class="n">Cpu0TargetRelocationHandler</span> <span class="o">&amp;</span><span class="n">getRelocationHandler</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">_relocationHandler</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">createImplicitFiles</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&amp;</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>
  <span class="k">class</span> <span class="nc">GOTFile</span> <span class="o">:</span> <span class="k">public</span> <span class="n">SimpleFile</span> <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="n">GOTFile</span><span class="p">(</span><span class="k">const</span> <span class="n">ELFLinkingContext</span> <span class="o">&amp;</span><span class="n">eti</span><span class="p">)</span> <span class="o">:</span> <span class="n">SimpleFile</span><span class="p">(</span><span class="n">eti</span><span class="p">,</span> <span class="s">&quot;GOTFile&quot;</span><span class="p">)</span> <span class="p">{}</span>
    <span class="n">llvm</span><span class="o">::</span><span class="n">BumpPtrAllocator</span> <span class="n">_alloc</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">GOTFile</span><span class="o">&gt;</span> <span class="n">_gotFile</span><span class="p">;</span>

  <span class="n">Cpu0TargetRelocationHandler</span> <span class="n">_relocationHandler</span><span class="p">;</span>
  <span class="n">TargetLayout</span><span class="o">&lt;</span><span class="n">Cpu0ELFType</span><span class="o">&gt;</span> <span class="n">_targetLayout</span><span class="p">;</span>
<span class="p">};</span>
<span class="p">}</span> <span class="c1">// end namespace elf</span>
<span class="p">}</span> <span class="c1">// end namespace lld</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/Cpu0_lld_1030/Cpu0/Cpu0TargetHandler.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">//===- lib/ReaderWriter/ELF/Cpu0/Cpu0TargetHandler.cpp ----------------===//</span>
<span class="cp">//</span>
<span class="cp">//                             The LLVM Linker</span>
<span class="cp">//</span>
<span class="cp">// This file is distributed under the University of Illinois Open Source</span>
<span class="cp">// License. See LICENSE.TXT for details.</span>
<span class="cp">//</span>
<span class="cp">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Atoms.h&quot;</span>
<span class="cp">#include &quot;Cpu0TargetHandler.h&quot;</span>
<span class="cp">#include &quot;Cpu0LinkingContext.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">lld</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">elf</span><span class="p">;</span>

<span class="n">uint64_t</span> <span class="n">textSectionAddr</span><span class="p">;</span>

<span class="n">Cpu0TargetHandler</span><span class="o">::</span><span class="n">Cpu0TargetHandler</span><span class="p">(</span><span class="n">Cpu0LinkingContext</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">DefaultTargetHandler</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="n">_gotFile</span><span class="p">(</span><span class="k">new</span> <span class="n">GOTFile</span><span class="p">(</span><span class="n">context</span><span class="p">)),</span>
      <span class="n">_relocationHandler</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="n">_targetLayout</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="p">{}</span>

<span class="kt">bool</span> <span class="n">Cpu0TargetHandler</span><span class="o">::</span><span class="n">createImplicitFiles</span><span class="p">(</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">_gotFile</span><span class="o">-&gt;</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="k">new</span> <span class="p">(</span><span class="n">_gotFile</span><span class="o">-&gt;</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">GLOBAL_OFFSET_TABLEAtom</span><span class="p">(</span><span class="o">*</span><span class="n">_gotFile</span><span class="p">));</span>
  <span class="n">_gotFile</span><span class="o">-&gt;</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="k">new</span> <span class="p">(</span><span class="n">_gotFile</span><span class="o">-&gt;</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">TLSGETADDRAtom</span><span class="p">(</span><span class="o">*</span><span class="n">_gotFile</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">_context</span><span class="p">.</span><span class="n">isDynamic</span><span class="p">())</span>
    <span class="n">_gotFile</span><span class="o">-&gt;</span><span class="n">addAtom</span><span class="p">(</span><span class="o">*</span><span class="k">new</span> <span class="p">(</span><span class="n">_gotFile</span><span class="o">-&gt;</span><span class="n">_alloc</span><span class="p">)</span> <span class="n">DYNAMICAtom</span><span class="p">(</span><span class="o">*</span><span class="n">_gotFile</span><span class="p">));</span>
  <span class="n">result</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">_gotFile</span><span class="p">));</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Above code in Cpu0 lld support both the static and dynamic link.
The &#8220;#ifdef DLINKER&#8221; is for dynamic link support. There are only just over 1
thousand of code in it. Half of the code size is for the dynamic linker.</p>
</div>
<div class="section" id="elf-to-hex">
<h2>ELF to Hex<a class="headerlink" href="#elf-to-hex" title="Permalink to this headline">¶</a></h2>
<p>Add elf2hex.h and update llvm-objdump driver to support ELF to Hex for Cpu0
backend as follows,</p>
<p class="rubric">lbdex/llvm-objdump/elf2hex.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">//===---------------------------- elf2hex.cpp -----------------------------===//</span>
<span class="cp">//</span>
<span class="cp">//                     The LLVM Compiler Infrastructure</span>
<span class="cp">//</span>
<span class="cp">// This file is distributed under the University of Illinois Open Source</span>
<span class="cp">// License. See LICENSE.TXT for details.</span>
<span class="cp">//</span>
<span class="cp">//===----------------------------------------------------------------------===//</span>
<span class="cp">//</span>
<span class="cp">// This program is a utility that works with llvm-objdump.</span>
<span class="cp">//</span>
<span class="cp">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="k">static</span> <span class="n">cl</span><span class="o">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span>
<span class="n">ConvertElf2Hex</span><span class="p">(</span><span class="s">&quot;elf2hex&quot;</span><span class="p">,</span> 
<span class="n">cl</span><span class="o">::</span><span class="n">desc</span><span class="p">(</span><span class="s">&quot;Display the hex content of verilog cpu0 needed sections&quot;</span><span class="p">));</span>

<span class="k">static</span> <span class="n">cl</span><span class="o">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span>
<span class="n">DumpSo</span><span class="p">(</span><span class="s">&quot;cpu0dumpso&quot;</span><span class="p">,</span> 
<span class="n">cl</span><span class="o">::</span><span class="n">desc</span><span class="p">(</span><span class="s">&quot;Dump shared library .so&quot;</span><span class="p">));</span>

<span class="k">static</span> <span class="n">cl</span><span class="o">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span>
<span class="n">LinkSo</span><span class="p">(</span><span class="s">&quot;cpu0linkso&quot;</span><span class="p">,</span> 
<span class="n">cl</span><span class="o">::</span><span class="n">desc</span><span class="p">(</span><span class="s">&quot;Link shared library .so&quot;</span><span class="p">));</span>

<span class="c1">// Modified from PrintSectionHeaders()</span>
<span class="k">static</span> <span class="n">uint64_t</span> <span class="n">GetSectionHeaderStartAddress</span><span class="p">(</span><span class="k">const</span> <span class="n">ObjectFile</span> <span class="o">*</span><span class="n">o</span><span class="p">,</span> 
  <span class="n">StringRef</span> <span class="n">sectionName</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">//  outs() &lt;&lt; &quot;Sections:\n&quot;</span>
<span class="c1">//            &quot;Idx Name          Size      Address          Type\n&quot;;</span>
  <span class="n">error_code</span> <span class="n">ec</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">section_iterator</span> <span class="n">si</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">begin_sections</span><span class="p">(),</span> <span class="n">se</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">end_sections</span><span class="p">();</span>
                                                  <span class="n">si</span> <span class="o">!=</span> <span class="n">se</span><span class="p">;</span> <span class="n">si</span><span class="p">.</span><span class="n">increment</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">StringRef</span> <span class="n">Name</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(</span><span class="n">Name</span><span class="p">)))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">uint64_t</span> <span class="n">Address</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getAddress</span><span class="p">(</span><span class="n">Address</span><span class="p">)))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">uint64_t</span> <span class="n">Size</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">Text</span><span class="p">,</span> <span class="n">Data</span><span class="p">,</span> <span class="n">BSS</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">isText</span><span class="p">(</span><span class="n">Text</span><span class="p">)))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">isData</span><span class="p">(</span><span class="n">Data</span><span class="p">)))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">isBSS</span><span class="p">(</span><span class="n">BSS</span><span class="p">)))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Name</span> <span class="o">==</span> <span class="n">sectionName</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">Address</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="o">++</span><span class="n">i</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Modified from PrintSymbolTable()</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">GetSymbolTableStartAddress</span><span class="p">(</span><span class="k">const</span> <span class="n">ObjectFile</span> <span class="o">*</span><span class="n">o</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">sectionName</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;SYMBOL TABLE:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">COFFObjectFile</span> <span class="o">*</span><span class="n">coff</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">COFFObjectFile</span><span class="o">&gt;</span><span class="p">(</span><span class="n">o</span><span class="p">))</span>
    <span class="n">PrintCOFFSymbolTable</span><span class="p">(</span><span class="n">coff</span><span class="p">);</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">error_code</span> <span class="n">ec</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">symbol_iterator</span> <span class="n">si</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">begin_symbols</span><span class="p">(),</span>
                         <span class="n">se</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">end_symbols</span><span class="p">();</span> <span class="n">si</span> <span class="o">!=</span> <span class="n">se</span><span class="p">;</span> <span class="n">si</span><span class="p">.</span><span class="n">increment</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
      <span class="n">StringRef</span> <span class="n">Name</span><span class="p">;</span>
      <span class="n">uint64_t</span> <span class="n">Address</span><span class="p">;</span>
      <span class="n">SymbolRef</span><span class="o">::</span><span class="n">Type</span> <span class="n">Type</span><span class="p">;</span>
      <span class="n">uint64_t</span> <span class="n">Size</span><span class="p">;</span>
      <span class="n">uint32_t</span> <span class="n">Flags</span><span class="p">;</span>
      <span class="n">section_iterator</span> <span class="n">Section</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">end_sections</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(</span><span class="n">Name</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getAddress</span><span class="p">(</span><span class="n">Address</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getFlags</span><span class="p">(</span><span class="n">Flags</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(</span><span class="n">Type</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getSection</span><span class="p">(</span><span class="n">Section</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>

      <span class="kt">bool</span> <span class="n">Global</span> <span class="o">=</span> <span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">SymbolRef</span><span class="o">::</span><span class="n">SF_Global</span><span class="p">;</span>
      <span class="kt">bool</span> <span class="n">Weak</span> <span class="o">=</span> <span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">SymbolRef</span><span class="o">::</span><span class="n">SF_Weak</span><span class="p">;</span>
      <span class="kt">bool</span> <span class="n">Absolute</span> <span class="o">=</span> <span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">SymbolRef</span><span class="o">::</span><span class="n">SF_Absolute</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">Address</span> <span class="o">==</span> <span class="n">UnknownAddressOrSize</span><span class="p">)</span>
        <span class="n">Address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Size</span> <span class="o">==</span> <span class="n">UnknownAddressOrSize</span><span class="p">)</span>
        <span class="n">Size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kt">char</span> <span class="n">GlobLoc</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Type</span> <span class="o">!=</span> <span class="n">SymbolRef</span><span class="o">::</span><span class="n">ST_Unknown</span><span class="p">)</span>
        <span class="n">GlobLoc</span> <span class="o">=</span> <span class="n">Global</span> <span class="o">?</span> <span class="sc">&#39;g&#39;</span> <span class="o">:</span> <span class="sc">&#39;l&#39;</span><span class="p">;</span>
      <span class="kt">char</span> <span class="n">Debug</span> <span class="o">=</span> <span class="p">(</span><span class="n">Type</span> <span class="o">==</span> <span class="n">SymbolRef</span><span class="o">::</span><span class="n">ST_Debug</span> <span class="o">||</span> <span class="n">Type</span> <span class="o">==</span> <span class="n">SymbolRef</span><span class="o">::</span><span class="n">ST_File</span><span class="p">)</span>
                   <span class="o">?</span> <span class="sc">&#39;d&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
      <span class="kt">char</span> <span class="n">FileFunc</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Type</span> <span class="o">==</span> <span class="n">SymbolRef</span><span class="o">::</span><span class="n">ST_File</span><span class="p">)</span>
        <span class="n">FileFunc</span> <span class="o">=</span> <span class="sc">&#39;f&#39;</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Type</span> <span class="o">==</span> <span class="n">SymbolRef</span><span class="o">::</span><span class="n">ST_Function</span><span class="p">)</span>
        <span class="n">FileFunc</span> <span class="o">=</span> <span class="sc">&#39;F&#39;</span><span class="p">;</span>

      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Fmt</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">getBytesInAddress</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">?</span> <span class="s">&quot;%016&quot;</span> <span class="n">PRIx64</span> <span class="o">:</span>
                                                     <span class="s">&quot;%08&quot;</span> <span class="n">PRIx64</span><span class="p">;</span>

      <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="n">Fmt</span><span class="p">,</span> <span class="n">Address</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span>
             <span class="o">&lt;&lt;</span> <span class="n">GlobLoc</span> <span class="c1">// Local -&gt; &#39;l&#39;, Global -&gt; &#39;g&#39;, Neither -&gt; &#39; &#39;</span>
             <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">Weak</span> <span class="o">?</span> <span class="sc">&#39;w&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="c1">// Weak?</span>
             <span class="o">&lt;&lt;</span> <span class="sc">&#39; &#39;</span> <span class="c1">// Constructor. Not supported yet.</span>
             <span class="o">&lt;&lt;</span> <span class="sc">&#39; &#39;</span> <span class="c1">// Warning. Not supported yet.</span>
             <span class="o">&lt;&lt;</span> <span class="sc">&#39; &#39;</span> <span class="c1">// Indirect reference to another symbol.</span>
             <span class="o">&lt;&lt;</span> <span class="n">Debug</span> <span class="c1">// Debugging (d) or dynamic (D) symbol.</span>
             <span class="o">&lt;&lt;</span> <span class="n">FileFunc</span> <span class="c1">// Name of function (F), file (f) or object (O).</span>
             <span class="o">&lt;&lt;</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Absolute</span><span class="p">)</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*ABS*&quot;</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Section</span> <span class="o">==</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">end_sections</span><span class="p">())</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*UND*&quot;</span><span class="p">;</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">MachOObjectFile</span> <span class="o">*</span><span class="n">MachO</span> <span class="o">=</span>
            <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MachOObjectFile</span><span class="o">&gt;</span><span class="p">(</span><span class="n">o</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">DataRefImpl</span> <span class="n">DR</span> <span class="o">=</span> <span class="n">Section</span><span class="o">-&gt;</span><span class="n">getRawDataRefImpl</span><span class="p">();</span>
          <span class="n">StringRef</span> <span class="n">SegmentName</span> <span class="o">=</span> <span class="n">MachO</span><span class="o">-&gt;</span><span class="n">getSectionFinalSegmentName</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
          <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">SegmentName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">StringRef</span> <span class="n">SectionName</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">Section</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(</span><span class="n">SectionName</span><span class="p">)))</span>
          <span class="n">SectionName</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">SectionName</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\t&#39;</span>
             <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;%08&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">Size</span><span class="p">)</span>
             <span class="o">&lt;&lt;</span> <span class="n">Name</span>
             <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Cpu0DynFunIndex</span> <span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
  <span class="kt">char</span> <span class="n">soStrtab</span><span class="p">[</span><span class="mi">20</span><span class="p">][</span><span class="mi">100</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">soStrtabSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="kt">char</span> <span class="n">exePltName</span><span class="p">[</span><span class="mi">20</span><span class="p">][</span><span class="mi">100</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">exePltNameSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="kt">int</span> <span class="n">findPltName</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pltName</span><span class="p">);</span>
<span class="k">public</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">createPltName</span><span class="p">(</span><span class="k">const</span> <span class="n">ObjectFile</span> <span class="o">*</span><span class="n">o</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">createStrtab</span><span class="p">();</span>
  <span class="n">uint16_t</span> <span class="n">correctDynFunIndex</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pltName</span><span class="p">);</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">Cpu0DynFunIndex</span><span class="o">::</span><span class="n">findPltName</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pltName</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">exePltNameSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">pltName</span><span class="p">,</span> <span class="n">exePltName</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0DynFunIndex</span><span class="o">::</span><span class="n">createPltName</span><span class="p">(</span><span class="k">const</span> <span class="n">ObjectFile</span> <span class="o">*</span><span class="n">o</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">error_code</span> <span class="n">ec</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">Error</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">section_iterator</span> <span class="n">si</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">begin_sections</span><span class="p">(),</span>
                        <span class="n">se</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">end_sections</span><span class="p">();</span>
                        <span class="n">si</span> <span class="o">!=</span> <span class="n">se</span><span class="p">;</span> <span class="n">si</span><span class="p">.</span><span class="n">increment</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">StringRef</span> <span class="n">Name</span><span class="p">;</span>
    <span class="n">StringRef</span> <span class="n">Contents</span><span class="p">;</span>
    <span class="n">uint64_t</span> <span class="n">BaseAddr</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">BSS</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(</span><span class="n">Name</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getContents</span><span class="p">(</span><span class="n">Contents</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getAddress</span><span class="p">(</span><span class="n">BaseAddr</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">isBSS</span><span class="p">(</span><span class="n">BSS</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">Name</span> <span class="o">==</span> <span class="s">&quot;.strtab&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">num_dyn_entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">FILE</span> <span class="o">*</span><span class="n">fd_num_dyn_entry</span><span class="p">;</span>
      <span class="n">fd_num_dyn_entry</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&quot;num_dyn_entry&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">fd_num_dyn_entry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fscanf</span><span class="p">(</span><span class="n">fd_num_dyn_entry</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_dyn_entry</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">fclose</span><span class="p">(</span><span class="n">fd_num_dyn_entry</span><span class="p">);</span>

      <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">2</span><span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="s">&quot;.PLT0&quot;</span><span class="p">),</span> <span class="n">end</span> <span class="o">=</span> <span class="n">Contents</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> 
           <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Contents</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;__plt_&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="s">&quot;__plt_&quot;</span><span class="p">)</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">exePltName</span><span class="p">[</span><span class="n">exePltNameSize</span><span class="p">],</span> <span class="n">Contents</span><span class="p">.</span><span class="n">data</span><span class="p">()</span><span class="o">+</span><span class="n">addr</span><span class="p">);</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">exePltName</span><span class="p">[</span><span class="n">exePltNameSize</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">exePltNameSize</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0DynFunIndex</span><span class="o">::</span><span class="n">createStrtab</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">FILE</span> <span class="o">*</span><span class="n">fd_dynstrAscii</span><span class="p">;</span>

  <span class="n">fd_dynstrAscii</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&quot;dynstrAscii&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fd_dynstrAscii</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">fd_dynstrAscii</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">fd_dynstrAscii</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;fd_dynstr == NULL&quot;</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="c1">// function                  result on EOF or error                    </span>
  <span class="c1">// --------                  ----------------------</span>
  <span class="c1">// fgets()                   NULL</span>
  <span class="c1">// fscanf()                  number of succesful conversions</span>
  <span class="c1">//                             less than expected</span>
  <span class="c1">// fgetc()                   EOF</span>
  <span class="c1">// fread()                   number of elements read</span>
  <span class="c1">//                             less than expected</span>
  <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">j</span><span class="o">=</span><span class="n">fscanf</span><span class="p">(</span><span class="n">fd_dynstrAscii</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">soStrtab</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">soStrtabSize</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
  <span class="n">fclose</span><span class="p">(</span><span class="n">fd_dynstrAscii</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">uint16_t</span> <span class="n">Cpu0DynFunIndex</span><span class="o">::</span><span class="n">correctDynFunIndex</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pltName</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">findPltName</span><span class="p">(</span><span class="n">pltName</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">soStrtabSize</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">soStrtab</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">exePltName</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="s">&quot;__plt_&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">soStrtabSize</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;cannot find &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">exePltName</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">j</span><span class="o">++</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">uint16_t</span><span class="p">)(</span><span class="n">j</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">uint16_t</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">Cpu0DynFunIndex</span> <span class="n">cpu0DynFunIndex</span><span class="p">;</span>

<span class="c1">// Modified from DisassembleObject()</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">DisassembleObjectInHexFormat</span><span class="p">(</span><span class="k">const</span> <span class="n">ObjectFile</span> <span class="o">*</span><span class="n">Obj</span>
<span class="cm">/*, bool InlineRelocs*/</span>  <span class="p">,</span> <span class="n">uint64_t</span><span class="o">&amp;</span> <span class="n">lastDumpAddr</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">Error</span><span class="p">;</span>
  <span class="n">uint64_t</span> <span class="n">soLastPrintAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">FILE</span> <span class="o">*</span><span class="n">fd_so_func_offset</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">num_dyn_entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">DumpSo</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fd_so_func_offset</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&quot;so_func_offset&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd_so_func_offset</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
      <span class="n">fclose</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">fd_so_func_offset</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;fd_so_func_offset == NULL&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">LinkSo</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cpu0DynFunIndex</span><span class="p">.</span><span class="n">createStrtab</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">Target</span> <span class="o">*</span><span class="n">TheTarget</span> <span class="o">=</span> <span class="n">getTarget</span><span class="p">(</span><span class="n">Obj</span><span class="p">);</span>
  <span class="c1">// getTarget() will have already issued a diagnostic if necessary, so</span>
  <span class="c1">// just bail here if it failed.</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TheTarget</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="c1">// Package up features to be passed to target/subtarget</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">FeaturesStr</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">MAttrs</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">SubtargetFeatures</span> <span class="n">Features</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">MAttrs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="n">Features</span><span class="p">.</span><span class="n">AddFeature</span><span class="p">(</span><span class="n">MAttrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">FeaturesStr</span> <span class="o">=</span> <span class="n">Features</span><span class="p">.</span><span class="n">getString</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MCRegisterInfo</span><span class="o">&gt;</span> <span class="n">MRI</span><span class="p">(</span><span class="n">TheTarget</span><span class="o">-&gt;</span><span class="n">createMCRegInfo</span><span class="p">(</span><span class="n">TripleName</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MRI</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;error: no register info for target &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">TripleName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Set up disassembler.</span>
  <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MCAsmInfo</span><span class="o">&gt;</span> <span class="n">AsmInfo</span><span class="p">(</span>
    <span class="n">TheTarget</span><span class="o">-&gt;</span><span class="n">createMCAsmInfo</span><span class="p">(</span><span class="o">*</span><span class="n">MRI</span><span class="p">,</span> <span class="n">TripleName</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AsmInfo</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;error: no assembly info for target &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">TripleName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MCSubtargetInfo</span><span class="o">&gt;</span> <span class="n">STI</span><span class="p">(</span>
    <span class="n">TheTarget</span><span class="o">-&gt;</span><span class="n">createMCSubtargetInfo</span><span class="p">(</span><span class="n">TripleName</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">FeaturesStr</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STI</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;error: no subtarget info for target &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">TripleName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MCInstrInfo</span><span class="o">&gt;</span> <span class="n">MII</span><span class="p">(</span><span class="n">TheTarget</span><span class="o">-&gt;</span><span class="n">createMCInstrInfo</span><span class="p">());</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MII</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;error: no instruction info for target &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">TripleName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="n">MCDisassembler</span><span class="o">&gt;</span> <span class="n">DisAsm</span><span class="p">(</span><span class="n">TheTarget</span><span class="o">-&gt;</span><span class="n">createMCDisassembler</span><span class="p">(</span><span class="o">*</span><span class="n">STI</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DisAsm</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;error: no disassembler for target &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">TripleName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MCObjectFileInfo</span><span class="o">&gt;</span> <span class="n">MOFI</span><span class="p">;</span>
  <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="n">MCContext</span><span class="o">&gt;</span> <span class="n">Ctx</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Symbolize</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">MOFI</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">MCObjectFileInfo</span><span class="p">);</span>
    <span class="n">Ctx</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">MCContext</span><span class="p">(</span><span class="n">AsmInfo</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">MRI</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">MOFI</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
    <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="n">MCRelocationInfo</span><span class="o">&gt;</span> <span class="n">RelInfo</span><span class="p">(</span>
      <span class="n">TheTarget</span><span class="o">-&gt;</span><span class="n">createMCRelocationInfo</span><span class="p">(</span><span class="n">TripleName</span><span class="p">,</span> <span class="o">*</span><span class="n">Ctx</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">RelInfo</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="n">MCSymbolizer</span><span class="o">&gt;</span> <span class="n">Symzer</span><span class="p">(</span>
        <span class="n">MCObjectSymbolizer</span><span class="o">::</span><span class="n">createObjectSymbolizer</span><span class="p">(</span><span class="o">*</span><span class="n">Ctx</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">RelInfo</span><span class="p">,</span> <span class="n">Obj</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Symzer</span><span class="p">)</span>
        <span class="n">DisAsm</span><span class="o">-&gt;</span><span class="n">setSymbolizer</span><span class="p">(</span><span class="n">Symzer</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MCInstrAnalysis</span><span class="o">&gt;</span>
    <span class="n">MIA</span><span class="p">(</span><span class="n">TheTarget</span><span class="o">-&gt;</span><span class="n">createMCInstrAnalysis</span><span class="p">(</span><span class="n">MII</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>

  <span class="kt">int</span> <span class="n">AsmPrinterVariant</span> <span class="o">=</span> <span class="n">AsmInfo</span><span class="o">-&gt;</span><span class="n">getAssemblerDialect</span><span class="p">();</span>
  <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="n">MCInstPrinter</span><span class="o">&gt;</span> <span class="n">IP</span><span class="p">(</span><span class="n">TheTarget</span><span class="o">-&gt;</span><span class="n">createMCInstPrinter</span><span class="p">(</span>
      <span class="n">AsmPrinterVariant</span><span class="p">,</span> <span class="o">*</span><span class="n">AsmInfo</span><span class="p">,</span> <span class="o">*</span><span class="n">MII</span><span class="p">,</span> <span class="o">*</span><span class="n">MRI</span><span class="p">,</span> <span class="o">*</span><span class="n">STI</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IP</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;error: no instruction printer for target &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">TripleName</span>
      <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">CFG</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="n">MCObjectDisassembler</span><span class="o">&gt;</span> <span class="n">OD</span><span class="p">(</span>
      <span class="k">new</span> <span class="n">MCObjectDisassembler</span><span class="p">(</span><span class="o">*</span><span class="n">Obj</span><span class="p">,</span> <span class="o">*</span><span class="n">DisAsm</span><span class="p">,</span> <span class="o">*</span><span class="n">MIA</span><span class="p">));</span>
    <span class="n">OwningPtr</span><span class="o">&lt;</span><span class="n">MCModule</span><span class="o">&gt;</span> <span class="n">Mod</span><span class="p">(</span><span class="n">OD</span><span class="o">-&gt;</span><span class="n">buildModule</span><span class="p">(</span><span class="cm">/* withCFG */</span> <span class="kc">true</span><span class="p">));</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">MCModule</span><span class="o">::</span><span class="n">const_atom_iterator</span> <span class="n">AI</span> <span class="o">=</span> <span class="n">Mod</span><span class="o">-&gt;</span><span class="n">atom_begin</span><span class="p">(),</span>
                                       <span class="n">AE</span> <span class="o">=</span> <span class="n">Mod</span><span class="o">-&gt;</span><span class="n">atom_end</span><span class="p">();</span>
                                       <span class="n">AI</span> <span class="o">!=</span> <span class="n">AE</span><span class="p">;</span> <span class="o">++</span><span class="n">AI</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Atom &quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">AI</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">MCTextAtom</span> <span class="o">*</span><span class="n">TA</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">MCTextAtom</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">AI</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">MCTextAtom</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">II</span> <span class="o">=</span> <span class="n">TA</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span> <span class="n">IE</span> <span class="o">=</span> <span class="n">TA</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">();</span>
             <span class="n">II</span> <span class="o">!=</span> <span class="n">IE</span><span class="p">;</span>
             <span class="o">++</span><span class="n">II</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">IP</span><span class="o">-&gt;</span><span class="n">printInst</span><span class="p">(</span><span class="o">&amp;</span><span class="n">II</span><span class="o">-&gt;</span><span class="n">Inst</span><span class="p">,</span> <span class="n">outs</span><span class="p">(),</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
          <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">MCModule</span><span class="o">::</span><span class="n">const_func_iterator</span> <span class="n">FI</span> <span class="o">=</span> <span class="n">Mod</span><span class="o">-&gt;</span><span class="n">func_begin</span><span class="p">(),</span>
                                       <span class="n">FE</span> <span class="o">=</span> <span class="n">Mod</span><span class="o">-&gt;</span><span class="n">func_end</span><span class="p">();</span>
                                       <span class="n">FI</span> <span class="o">!=</span> <span class="n">FE</span><span class="p">;</span> <span class="o">++</span><span class="n">FI</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">static</span> <span class="kt">int</span> <span class="n">filenum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">emitDOTFile</span><span class="p">((</span><span class="n">Twine</span><span class="p">((</span><span class="o">*</span><span class="n">FI</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">())</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span>
                   <span class="n">utostr</span><span class="p">(</span><span class="n">filenum</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.dot&quot;</span><span class="p">).</span><span class="n">str</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span>
                    <span class="o">**</span><span class="n">FI</span><span class="p">,</span> <span class="n">IP</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
      <span class="o">++</span><span class="n">filenum</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>


  <span class="n">error_code</span> <span class="n">ec</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">section_iterator</span> <span class="n">i</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">-&gt;</span><span class="n">begin_sections</span><span class="p">(),</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">-&gt;</span><span class="n">end_sections</span><span class="p">();</span>
                        <span class="n">i</span> <span class="o">!=</span> <span class="n">e</span><span class="p">;</span> <span class="n">i</span><span class="p">.</span><span class="n">increment</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">text</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">isText</span><span class="p">(</span><span class="n">text</span><span class="p">)))</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">text</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

    <span class="n">uint64_t</span> <span class="n">SectionAddr</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">getAddress</span><span class="p">(</span><span class="n">SectionAddr</span><span class="p">)))</span> <span class="k">break</span><span class="p">;</span>

    <span class="c1">// Make a list of all the symbols in this section.</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">uint64_t</span><span class="p">,</span> <span class="n">StringRef</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">Symbols</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">symbol_iterator</span> <span class="n">si</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">-&gt;</span><span class="n">begin_symbols</span><span class="p">(),</span>
                         <span class="n">se</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">-&gt;</span><span class="n">end_symbols</span><span class="p">();</span>
                         <span class="n">si</span> <span class="o">!=</span> <span class="n">se</span><span class="p">;</span> <span class="n">si</span><span class="p">.</span><span class="n">increment</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="p">{</span>
      <span class="kt">bool</span> <span class="n">contains</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">containsSymbol</span><span class="p">(</span><span class="o">*</span><span class="n">si</span><span class="p">,</span> <span class="n">contains</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">contains</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">uint64_t</span> <span class="n">Address</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getAddress</span><span class="p">(</span><span class="n">Address</span><span class="p">)))</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Address</span> <span class="o">==</span> <span class="n">UnknownAddressOrSize</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="n">Address</span> <span class="o">-=</span> <span class="n">SectionAddr</span><span class="p">;</span>

        <span class="n">StringRef</span> <span class="n">Name</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(</span><span class="n">Name</span><span class="p">)))</span> <span class="k">break</span><span class="p">;</span>
        <span class="n">Symbols</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">Name</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Sort the symbols by address, just in case they didn&#39;t come in that way.</span>
    <span class="n">array_pod_sort</span><span class="p">(</span><span class="n">Symbols</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">Symbols</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>

    <span class="c1">// Make a list of all the relocations for this section.</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">RelocationRef</span><span class="o">&gt;</span> <span class="n">Rels</span><span class="p">;</span>
<span class="cm">/*    if (InlineRelocs) {</span>
<span class="cm">      for (relocation_iterator ri = i-&gt;begin_relocations(),</span>
<span class="cm">                               re = i-&gt;end_relocations();</span>
<span class="cm">                               ri != re; ri.increment(ec)) {</span>
<span class="cm">        if (error(ec)) break;</span>
<span class="cm">        Rels.push_back(*ri);</span>
<span class="cm">      }</span>
<span class="cm">    }*/</span>

    <span class="c1">// Sort relocations by address.</span>
    <span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="n">Rels</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">Rels</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">RelocAddressLess</span><span class="p">);</span>

    <span class="n">StringRef</span> <span class="n">SegmentName</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">MachOObjectFile</span> <span class="o">*</span><span class="n">MachO</span> <span class="o">=</span>
        <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MachOObjectFile</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Obj</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">DataRefImpl</span> <span class="n">DR</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">getRawDataRefImpl</span><span class="p">();</span>
      <span class="n">SegmentName</span> <span class="o">=</span> <span class="n">MachO</span><span class="o">-&gt;</span><span class="n">getSectionFinalSegmentName</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">StringRef</span> <span class="n">name</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">DumpSo</span> <span class="o">&amp;&amp;</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&quot;.plt&quot;</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/*&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Disassembly of section &quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SegmentName</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
      <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">SegmentName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
    <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;:&#39;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*/&quot;</span><span class="p">;</span>

    <span class="c1">// If the section has no symbols just insert a dummy one and disassemble</span>
    <span class="c1">// the whole section.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Symbols</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
      <span class="n">Symbols</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>

    <span class="n">SmallString</span><span class="o">&lt;</span><span class="mi">40</span><span class="o">&gt;</span> <span class="n">Comments</span><span class="p">;</span>
    <span class="n">raw_svector_ostream</span> <span class="n">CommentStream</span><span class="p">(</span><span class="n">Comments</span><span class="p">);</span>

    <span class="n">StringRef</span> <span class="n">Bytes</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">getContents</span><span class="p">(</span><span class="n">Bytes</span><span class="p">)))</span> <span class="k">break</span><span class="p">;</span>
    <span class="n">StringRefMemoryObject</span> <span class="n">memoryObject</span><span class="p">(</span><span class="n">Bytes</span><span class="p">,</span> <span class="n">SectionAddr</span><span class="p">);</span>
    <span class="n">uint64_t</span> <span class="n">Size</span><span class="p">;</span>
    <span class="n">uint64_t</span> <span class="n">Index</span><span class="p">;</span>
    <span class="n">uint64_t</span> <span class="n">SectSize</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">(</span><span class="n">SectSize</span><span class="p">)))</span> <span class="k">break</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">RelocationRef</span><span class="o">&gt;::</span><span class="n">const_iterator</span> <span class="n">rel_cur</span> <span class="o">=</span> <span class="n">Rels</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">RelocationRef</span><span class="o">&gt;::</span><span class="n">const_iterator</span> <span class="n">rel_end</span> <span class="o">=</span> <span class="n">Rels</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
    <span class="c1">// Disassemble symbol by symbol.</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">si</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">se</span> <span class="o">=</span> <span class="n">Symbols</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">si</span> <span class="o">!=</span> <span class="n">se</span><span class="p">;</span> <span class="o">++</span><span class="n">si</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">uint64_t</span> <span class="n">Start</span> <span class="o">=</span> <span class="n">Symbols</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">first</span><span class="p">;</span>
      <span class="n">uint64_t</span> <span class="n">End</span><span class="p">;</span>
      <span class="c1">// The end is either the size of the section or the beginning of the next</span>
      <span class="c1">// symbol.</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">si</span> <span class="o">==</span> <span class="n">se</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">End</span> <span class="o">=</span> <span class="n">SectSize</span><span class="p">;</span>
      <span class="c1">// Make sure this symbol takes up space.</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Symbols</span><span class="p">[</span><span class="n">si</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">first</span> <span class="o">!=</span> <span class="n">Start</span><span class="p">)</span>
        <span class="n">End</span> <span class="o">=</span> <span class="n">Symbols</span><span class="p">[</span><span class="n">si</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">first</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// This symbol has the same address as the next symbol. Skip it.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">DumpSo</span><span class="cm">/* &amp;&amp; Symbols[si].second != &quot;__tls_get_addr&quot;*/</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> 
                  <span class="p">(</span><span class="n">uint8_t</span><span class="p">)(</span><span class="n">Symbols</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">first</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">));</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> 
                  <span class="p">(</span><span class="n">uint8_t</span><span class="p">)((</span><span class="n">Symbols</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">first</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> 
                  <span class="p">(</span><span class="n">uint8_t</span><span class="p">)((</span><span class="n">Symbols</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">first</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;%02x    &quot;</span><span class="p">,</span> 
                  <span class="p">(</span><span class="n">uint8_t</span><span class="p">)((</span><span class="n">Symbols</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">first</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
          <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">str</span> <span class="o">=</span> <span class="n">Symbols</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">second</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
          <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">strSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">strSize</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">strSize</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;%c%c &quot;</span><span class="p">,</span> 
                    <span class="n">hexdigit</span><span class="p">((</span><span class="n">str</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span>
                    <span class="n">hexdigit</span><span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
          <span class="p">}</span>
          <span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="n">strSize</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">48</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;/* %s */</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Symbols</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">second</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
          <span class="n">num_dyn_entry</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/*&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Symbols</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">second</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:*/</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">DumpSo</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">soLastPrintAddr</span> <span class="o">=</span> <span class="n">Symbols</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">first</span><span class="p">;</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">uint8_t</span><span class="p">)(</span><span class="n">Symbols</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">first</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">));</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> 
                <span class="p">(</span><span class="n">uint8_t</span><span class="p">)((</span><span class="n">Symbols</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">first</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> 
                <span class="p">(</span><span class="n">uint8_t</span><span class="p">)((</span><span class="n">Symbols</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">first</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;%02x    &quot;</span><span class="p">,</span> 
                <span class="p">(</span><span class="n">uint8_t</span><span class="p">)((</span><span class="n">Symbols</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">first</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">str</span> <span class="o">=</span> <span class="n">Symbols</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">second</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
        <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">strSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">strSize</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">strSize</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;%c%c &quot;</span><span class="p">,</span> 
                  <span class="n">hexdigit</span><span class="p">((</span><span class="n">str</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span> 
                  <span class="n">hexdigit</span><span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="n">strSize</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">48</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;/* %s */</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Symbols</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">second</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
        <span class="n">num_dyn_entry</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/*&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Symbols</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">second</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:*/</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
      <span class="n">uint16_t</span> <span class="n">funIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">LinkSo</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// correctDynFunIndex</span>
        <span class="n">funIndex</span> <span class="o">=</span> <span class="n">cpu0DynFunIndex</span><span class="p">.</span><span class="n">correctDynFunIndex</span><span class="p">(</span><span class="n">Symbols</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">second</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
      <span class="p">}</span>

<span class="cp">#ifndef NDEBUG</span>
        <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">DebugOut</span> <span class="o">=</span> <span class="n">DebugFlag</span> <span class="o">?</span> <span class="n">dbgs</span><span class="p">()</span> <span class="o">:</span> <span class="n">nulls</span><span class="p">();</span>
<span class="cp">#else</span>
        <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">DebugOut</span> <span class="o">=</span> <span class="n">nulls</span><span class="p">();</span>
<span class="cp">#endif</span>

      <span class="k">for</span> <span class="p">(</span><span class="n">Index</span> <span class="o">=</span> <span class="n">Start</span><span class="p">;</span> <span class="n">Index</span> <span class="o">&lt;</span> <span class="n">End</span><span class="p">;</span> <span class="n">Index</span> <span class="o">+=</span> <span class="n">Size</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">MCInst</span> <span class="n">Inst</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">LinkSo</span> <span class="o">&amp;&amp;</span> <span class="n">funIndex</span> <span class="o">&amp;&amp;</span> <span class="n">Index</span> <span class="o">==</span> <span class="n">Start</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;/*%8&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;:*/</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="cm">/*SectionAddr + */</span><span class="n">lastDumpAddr</span><span class="o">+</span><span class="n">Index</span><span class="p">);</span>
          <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;09 60 &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;%02&quot;</span> <span class="n">PRIx64</span><span class="p">,</span> <span class="n">funIndex</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span>
                  <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot; %02&quot;</span> <span class="n">PRIx64</span><span class="p">,</span> <span class="n">funIndex</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">);</span>
          <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;                                  /* addiu</span><span class="se">\t</span><span class="s">$t9, $zero, &quot;</span> 
                 <span class="o">&lt;&lt;</span> <span class="n">funIndex</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;($gp)*/</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">DisAsm</span><span class="o">-&gt;</span><span class="n">getInstruction</span><span class="p">(</span><span class="n">Inst</span><span class="p">,</span> <span class="n">Size</span><span class="p">,</span> <span class="n">memoryObject</span><span class="p">,</span>
                                     <span class="n">SectionAddr</span> <span class="o">+</span> <span class="n">Index</span><span class="p">,</span>
                                     <span class="n">DebugOut</span><span class="p">,</span> <span class="n">CommentStream</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;/*%8&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;:*/&quot;</span><span class="p">,</span> <span class="cm">/*SectionAddr + */</span><span class="n">lastDumpAddr</span><span class="o">+</span><span class="n">Index</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NoShowRawInsn</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>
              <span class="n">DumpBytes</span><span class="p">(</span><span class="n">StringRef</span><span class="p">(</span><span class="n">Bytes</span><span class="p">.</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">Index</span><span class="p">,</span> <span class="n">Size</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/*&quot;</span><span class="p">;</span>
            <span class="n">IP</span><span class="o">-&gt;</span><span class="n">printInst</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Inst</span><span class="p">,</span> <span class="n">outs</span><span class="p">(),</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
            <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">CommentStream</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
            <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*/&quot;</span><span class="p">;</span>
            <span class="n">Comments</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
            <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">ToolName</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: warning: invalid instruction encoding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
              <span class="n">Size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// skip illegible bytes</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">//  outs() &lt;&lt; &quot;Size = &quot; &lt;&lt; Size &lt;&lt;  &quot;Index = &quot; &lt;&lt; Index &lt;&lt; &quot;lastDumpAddr = &quot;</span>
        <span class="c1">//         &lt;&lt; lastDumpAddr &lt;&lt; &quot;\n&quot;; // debug</span>
        <span class="c1">// Print relocation for instruction.</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">rel_cur</span> <span class="o">!=</span> <span class="n">rel_end</span><span class="p">)</span> <span class="p">{</span>
          <span class="kt">bool</span> <span class="n">hidden</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="n">uint64_t</span> <span class="n">addr</span><span class="p">;</span>
          <span class="n">SmallString</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span> <span class="n">name</span><span class="p">;</span>
          <span class="n">SmallString</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">&gt;</span> <span class="n">val</span><span class="p">;</span>

          <span class="c1">// If this relocation is hidden, skip it.</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">rel_cur</span><span class="o">-&gt;</span><span class="n">getHidden</span><span class="p">(</span><span class="n">hidden</span><span class="p">)))</span> <span class="k">goto</span> <span class="n">skip_print_rel</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">hidden</span><span class="p">)</span> <span class="k">goto</span> <span class="n">skip_print_rel</span><span class="p">;</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">rel_cur</span><span class="o">-&gt;</span><span class="n">getOffset</span><span class="p">(</span><span class="n">addr</span><span class="p">)))</span> <span class="k">goto</span> <span class="n">skip_print_rel</span><span class="p">;</span>
          <span class="c1">// Stop when rel_cur&#39;s address is past the current instruction.</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">Index</span> <span class="o">+</span> <span class="n">Size</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">rel_cur</span><span class="o">-&gt;</span><span class="n">getTypeName</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span> <span class="k">goto</span> <span class="n">skip_print_rel</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">rel_cur</span><span class="o">-&gt;</span><span class="n">getValueString</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span> <span class="k">goto</span> <span class="n">skip_print_rel</span><span class="p">;</span>

          <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">/*%8&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;: &quot;</span><span class="p">,</span> <span class="n">SectionAddr</span> <span class="o">+</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">name</span>
                 <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*/</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

        <span class="nl">skip_print_rel:</span>
          <span class="o">++</span><span class="n">rel_cur</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">DumpSo</span><span class="p">)</span>
        <span class="n">soLastPrintAddr</span> <span class="o">=</span> <span class="n">End</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">lastDumpAddr</span> <span class="o">+=</span> <span class="n">Index</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">DumpSo</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">// Fix the issue that __tls_get_addr appear as file offset 0.</span>
<span class="c1">// Old lld version the __tls_get_addr appear at the last function name.</span>
    <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">uint64_t</span><span class="p">,</span> <span class="n">StringRef</span><span class="o">&gt;</span> <span class="n">dummy</span><span class="p">(</span><span class="n">soLastPrintAddr</span><span class="p">,</span> <span class="s">&quot;dummy&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">uint8_t</span><span class="p">)(</span><span class="n">dummy</span><span class="p">.</span><span class="n">first</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">));</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">uint8_t</span><span class="p">)((</span><span class="n">dummy</span><span class="p">.</span><span class="n">first</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">uint8_t</span><span class="p">)((</span><span class="n">dummy</span><span class="p">.</span><span class="n">first</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;%02x    &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">uint8_t</span><span class="p">)((</span><span class="n">dummy</span><span class="p">.</span><span class="n">first</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">str</span> <span class="o">=</span> <span class="n">dummy</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
    <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">strSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">strSize</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">strSize</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;%c%c &quot;</span><span class="p">,</span> <span class="n">hexdigit</span><span class="p">((</span><span class="n">str</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
              <span class="p">,</span> <span class="n">hexdigit</span><span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="n">strSize</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">48</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_so_func_offset</span><span class="p">,</span> <span class="s">&quot;/* %s */</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dummy</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
    <span class="n">num_dyn_entry</span><span class="o">++</span><span class="p">;</span>
    <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/*&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">dummy</span><span class="p">.</span><span class="n">second</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:*/</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">DumpSo</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">FILE</span> <span class="o">*</span><span class="n">fd_num_dyn_entry</span><span class="p">;</span>
    <span class="n">fd_num_dyn_entry</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&quot;num_dyn_entry&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd_num_dyn_entry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">fd_num_dyn_entry</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num_dyn_entry</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">fd_num_dyn_entry</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define DYNSYM_LIB_OFFSET 9</span>

<span class="c1">// Modified from PrintSectionContents()</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">PrintDataSections</span><span class="p">(</span><span class="k">const</span> <span class="n">ObjectFile</span> <span class="o">*</span><span class="n">o</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">lastDumpAddr</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">error_code</span> <span class="n">ec</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">Error</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">section_iterator</span> <span class="n">si</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">begin_sections</span><span class="p">(),</span>
                        <span class="n">se</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">end_sections</span><span class="p">();</span>
                        <span class="n">si</span> <span class="o">!=</span> <span class="n">se</span><span class="p">;</span> <span class="n">si</span><span class="p">.</span><span class="n">increment</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">StringRef</span> <span class="n">Name</span><span class="p">;</span>
    <span class="n">StringRef</span> <span class="n">Contents</span><span class="p">;</span>
    <span class="n">uint64_t</span> <span class="n">BaseAddr</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">BSS</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(</span><span class="n">Name</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getContents</span><span class="p">(</span><span class="n">Contents</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getAddress</span><span class="p">(</span><span class="n">BaseAddr</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">isBSS</span><span class="p">(</span><span class="n">BSS</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">Name</span> <span class="o">==</span> <span class="s">&quot;.rodata&quot;</span> <span class="o">||</span> <span class="n">Name</span> <span class="o">==</span> <span class="s">&quot;.rodata1&quot;</span> <span class="o">||</span> <span class="n">Name</span> <span class="o">==</span> <span class="s">&quot;.data&quot;</span> <span class="o">||</span> 
      <span class="n">Name</span> <span class="o">==</span> <span class="s">&quot;.data1&quot;</span> <span class="o">||</span> <span class="n">Name</span> <span class="o">==</span> <span class="s">&quot;.sdata&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Contents</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// Fill /*address*/ 00 00 00 00 between lastDumpAddr( = the address of last</span>
      <span class="c1">// end section + 1) and BaseAddr</span>
      <span class="n">uint64_t</span> <span class="n">cellingLastAddr4</span> <span class="o">=</span> <span class="p">((</span><span class="n">lastDumpAddr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
      <span class="n">assert</span><span class="p">((</span><span class="n">lastDumpAddr</span> <span class="o">&lt;=</span> <span class="n">BaseAddr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;lastDumpAddr must &lt;= BaseAddr&quot;</span><span class="p">);</span>
      <span class="c1">// Fill /*address*/ bytes is odd for 4 by 00 </span>
      <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;/*%04&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; */&quot;</span><span class="p">,</span> <span class="n">lastDumpAddr</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">cellingLastAddr4</span> <span class="o">&gt;</span> <span class="n">BaseAddr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="n">lastDumpAddr</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BaseAddr</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;00 &quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="n">lastDumpAddr</span> <span class="o">=</span> <span class="n">BaseAddr</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="n">lastDumpAddr</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cellingLastAddr4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;00 &quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="n">lastDumpAddr</span> <span class="o">=</span> <span class="n">cellingLastAddr4</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// Fill /*address*/ 00 00 00 00 for 4 bytes (1 Cpu0 word size)</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="n">lastDumpAddr</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">BaseAddr</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;/*%04&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; */&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;%02&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;%02&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> \
        <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;%02&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;%02&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/*Contents of section &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Name</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:*/</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
      <span class="c1">// Dump out the content as hex and printable ascii characters.</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">Contents</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;/*%04&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; */&quot;</span><span class="p">,</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="n">addr</span><span class="p">);</span>
        <span class="c1">// Dump line of hex.</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
            <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">hexdigit</span><span class="p">((</span><span class="n">Contents</span><span class="p">[</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
                   <span class="o">&lt;&lt;</span> <span class="n">hexdigit</span><span class="p">(</span><span class="n">Contents</span><span class="p">[</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// Print ascii.</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/*&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;  &quot;</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">isprint</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Contents</span><span class="p">[</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">))</span>
            <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">Contents</span><span class="p">[</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
          <span class="k">else</span>
            <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;.&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*/&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// save the end address of this section to lastDumpAddr</span>
      <span class="n">lastDumpAddr</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="n">Contents</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Name</span> <span class="o">==</span> <span class="s">&quot;.bss&quot;</span> <span class="o">||</span> <span class="n">Name</span> <span class="o">==</span> <span class="s">&quot;.sbss&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Contents</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// Fill /*address*/ 00 00 00 00 between lastDumpAddr( = the address of last</span>
      <span class="c1">// end section + 1) and BaseAddr</span>
      <span class="n">uint64_t</span> <span class="n">cellingLastAddr4</span> <span class="o">=</span> <span class="p">((</span><span class="n">lastDumpAddr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
      <span class="n">assert</span><span class="p">((</span><span class="n">lastDumpAddr</span> <span class="o">&lt;=</span> <span class="n">BaseAddr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;lastDumpAddr must &lt;= BaseAddr&quot;</span><span class="p">);</span>
      <span class="c1">// Fill /*address*/ bytes is odd for 4 by 00 </span>
      <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;/*%04&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; */&quot;</span><span class="p">,</span> <span class="n">lastDumpAddr</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">cellingLastAddr4</span> <span class="o">&gt;</span> <span class="n">BaseAddr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="n">lastDumpAddr</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BaseAddr</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;00 &quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="n">lastDumpAddr</span> <span class="o">=</span> <span class="n">BaseAddr</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="n">lastDumpAddr</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cellingLastAddr4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;00 &quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="n">lastDumpAddr</span> <span class="o">=</span> <span class="n">cellingLastAddr4</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// Fill /*address*/ 00 00 00 00 for 4 bytes (1 Cpu0 word size)</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="n">lastDumpAddr</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">BaseAddr</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;/*%04&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; */&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;%02&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;%02&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> \
        <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;%02&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;%02&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/*Contents of section &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Name</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:*/</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
      <span class="c1">// Dump out the content as hex and printable ascii characters.</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">Contents</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;/*%04&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; */&quot;</span><span class="p">,</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="n">addr</span><span class="p">);</span>
        <span class="c1">// Dump line of hex.</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
            <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;00 &quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// save the end address of this section to lastDumpAddr</span>
      <span class="n">lastDumpAddr</span> <span class="o">=</span> <span class="n">BaseAddr</span> <span class="o">+</span> <span class="n">Contents</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">DumpSo</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Name</span> <span class="o">==</span> <span class="s">&quot;.dynsym&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">num_dyn_entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">FILE</span> <span class="o">*</span><span class="n">fd_num_dyn_entry</span><span class="p">;</span>
        <span class="n">fd_num_dyn_entry</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&quot;num_dyn_entry&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fd_num_dyn_entry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">fscanf</span><span class="p">(</span><span class="n">fd_num_dyn_entry</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_dyn_entry</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">fclose</span><span class="p">(</span><span class="n">fd_num_dyn_entry</span><span class="p">);</span>
        <span class="n">raw_fd_ostream</span> <span class="n">fd_dynsym</span><span class="p">(</span><span class="s">&quot;dynsym&quot;</span><span class="p">,</span> <span class="n">Error</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">Contents</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">fd_dynsym</span> <span class="o">&lt;&lt;</span> <span class="n">hexdigit</span><span class="p">((</span><span class="n">Contents</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
                     <span class="o">&lt;&lt;</span> <span class="n">hexdigit</span><span class="p">(</span><span class="n">Contents</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
          <span class="n">fd_dynsym</span> <span class="o">&lt;&lt;</span> <span class="n">hexdigit</span><span class="p">((</span><span class="n">Contents</span><span class="p">[</span><span class="n">addr</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
                     <span class="o">&lt;&lt;</span> <span class="n">hexdigit</span><span class="p">(</span><span class="n">Contents</span><span class="p">[</span><span class="n">addr</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
          <span class="n">fd_dynsym</span> <span class="o">&lt;&lt;</span> <span class="n">hexdigit</span><span class="p">((</span><span class="n">Contents</span><span class="p">[</span><span class="n">addr</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
                     <span class="o">&lt;&lt;</span> <span class="n">hexdigit</span><span class="p">(</span><span class="n">Contents</span><span class="p">[</span><span class="n">addr</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
          <span class="n">fd_dynsym</span> <span class="o">&lt;&lt;</span> <span class="n">hexdigit</span><span class="p">((</span><span class="n">Contents</span><span class="p">[</span><span class="n">addr</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
                     <span class="o">&lt;&lt;</span> <span class="n">hexdigit</span><span class="p">(</span><span class="n">Contents</span><span class="p">[</span><span class="n">addr</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
          <span class="n">count</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_dyn_entry</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">fd_dynsym</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;00 00 00 00 &quot;</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Name</span> <span class="o">==</span> <span class="s">&quot;.dynstr&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">raw_fd_ostream</span> <span class="n">fd_dynstr</span><span class="p">(</span><span class="s">&quot;dynstr&quot;</span><span class="p">,</span> <span class="n">Error</span><span class="p">);</span>
        <span class="n">raw_fd_ostream</span> <span class="n">fd_dynstrAscii</span><span class="p">(</span><span class="s">&quot;dynstrAscii&quot;</span><span class="p">,</span> <span class="n">Error</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">Contents</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">fd_dynstr</span> <span class="o">&lt;&lt;</span> <span class="n">hexdigit</span><span class="p">((</span><span class="n">Contents</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
                     <span class="o">&lt;&lt;</span> <span class="n">hexdigit</span><span class="p">(</span><span class="n">Contents</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">Contents</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
            <span class="n">fd_dynstrAscii</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
          <span class="k">else</span>
            <span class="n">fd_dynstrAscii</span> <span class="o">&lt;&lt;</span> <span class="n">Contents</span><span class="p">[</span><span class="n">addr</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DumpSo</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Name</span> <span class="o">==</span> <span class="s">&quot;.got.plt&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">uint64_t</span> <span class="n">BaseAddr</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getAddress</span><span class="p">(</span><span class="n">BaseAddr</span><span class="p">)))</span> 
          <span class="n">assert</span><span class="p">(</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;Cannot get BaseAddr of section .got.plt&quot;</span><span class="p">);</span>
        <span class="n">raw_fd_ostream</span> <span class="n">fd_global_offset</span><span class="p">(</span><span class="s">&quot;global_offset&quot;</span><span class="p">,</span> <span class="n">Error</span><span class="p">);</span>
        <span class="n">fd_global_offset</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;%02&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">BaseAddr</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
        <span class="n">fd_global_offset</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;%02&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">BaseAddr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
        <span class="n">fd_global_offset</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;%02&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">BaseAddr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
        <span class="n">fd_global_offset</span> <span class="o">&lt;&lt;</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;%02&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;    &quot;</span><span class="p">,</span> <span class="n">BaseAddr</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">Elf2Hex</span><span class="p">(</span><span class="k">const</span> <span class="n">ObjectFile</span> <span class="o">*</span><span class="n">o</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">uint64_t</span> <span class="n">startAddr</span> <span class="o">=</span> <span class="n">GetSectionHeaderStartAddress</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="s">&quot;_start&quot;</span><span class="p">);</span>
<span class="c1">//  outs() &lt;&lt; format(&quot;_start address:%08&quot; PRIx64 &quot;\n&quot;, startAddr);</span>
  <span class="n">uint64_t</span> <span class="n">lastDumpAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">LinkSo</span><span class="p">)</span>
    <span class="n">cpu0DynFunIndex</span><span class="p">.</span><span class="n">createPltName</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
  <span class="n">DisassembleObjectInHexFormat</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">lastDumpAddr</span><span class="p">);</span>
<span class="c1">//  outs() &lt;&lt; format(&quot;lastDumpAddr:%08&quot; PRIx64 &quot;\n&quot;, lastDumpAddr);</span>
  <span class="n">PrintDataSections</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">lastDumpAddr</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/llvm-objdump/llvm-objdump.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;elf2hex.h&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">DumpObject</span><span class="p">(</span><span class="k">const</span> <span class="n">ObjectFile</span> <span class="o">*</span><span class="n">o</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ConvertElf2Hex</span><span class="p">)</span>
    <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/*&quot;</span><span class="p">;</span>
  <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">getFileName</span><span class="p">()</span>
         <span class="o">&lt;&lt;</span> <span class="s">&quot;:</span><span class="se">\t</span><span class="s">file format &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">getFileFormatName</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ConvertElf2Hex</span><span class="p">)</span>
    <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*/&quot;</span><span class="p">;</span>
  <span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Disassemble</span><span class="p">)</span>
    <span class="n">DisassembleObject</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">Relocations</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Relocations</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Disassemble</span><span class="p">)</span>
    <span class="n">PrintRelocations</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SectionHeaders</span><span class="p">)</span>
    <span class="n">PrintSectionHeaders</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SectionContents</span><span class="p">)</span>
    <span class="n">PrintSectionContents</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ConvertElf2Hex</span><span class="p">)</span>
    <span class="n">Elf2Hex</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SymbolTable</span><span class="p">)</span>
    <span class="n">PrintSymbolTable</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">UnwindInfo</span><span class="p">)</span>
    <span class="n">PrintUnwindInfo</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">PrivateHeaders</span><span class="p">)</span>
    <span class="n">printPrivateFileHeader</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Print a stack trace if we signal out.</span>
  <span class="n">sys</span><span class="o">::</span><span class="n">PrintStackTraceOnErrorSignal</span><span class="p">();</span>
  <span class="n">PrettyStackTraceProgram</span> <span class="n">X</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
  <span class="n">llvm_shutdown_obj</span> <span class="n">Y</span><span class="p">;</span>  <span class="c1">// Call llvm_shutdown() on exit.</span>

  <span class="c1">// Initialize targets and assembly printers/parsers.</span>
  <span class="n">llvm</span><span class="o">::</span><span class="n">InitializeAllTargetInfos</span><span class="p">();</span>
  <span class="n">llvm</span><span class="o">::</span><span class="n">InitializeAllTargetMCs</span><span class="p">();</span>
  <span class="n">llvm</span><span class="o">::</span><span class="n">InitializeAllAsmParsers</span><span class="p">();</span>
  <span class="n">llvm</span><span class="o">::</span><span class="n">InitializeAllDisassemblers</span><span class="p">();</span>

  <span class="c1">// Register the target printer for --version.</span>
  <span class="n">cl</span><span class="o">::</span><span class="n">AddExtraVersionPrinter</span><span class="p">(</span><span class="n">TargetRegistry</span><span class="o">::</span><span class="n">printRegisteredTargetsForVersion</span><span class="p">);</span>

  <span class="n">cl</span><span class="o">::</span><span class="n">ParseCommandLineOptions</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&quot;llvm object file dumper</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="n">TripleName</span> <span class="o">=</span> <span class="n">Triple</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">TripleName</span><span class="p">);</span>

  <span class="n">ToolName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

  <span class="c1">// Defaults to a.out if no filenames specified.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">InputFilenames</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">InputFilenames</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="s">&quot;a.out&quot;</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Disassemble</span>
      <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Relocations</span>
      <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">SectionHeaders</span>
      <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">SectionContents</span>
      <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ConvertElf2Hex</span>
      <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">SymbolTable</span>
      <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">UnwindInfo</span>
      <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">PrivateHeaders</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cl</span><span class="o">::</span><span class="n">PrintHelpMessage</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">InputFilenames</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">InputFilenames</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
                <span class="n">DumpInput</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The &#8220;if (DumpSo)&#8221; and &#8220;if (LinkSo)&#8221; included code are for dynamic linker support.
Others are used in both static and dynamic link execution file dump.</p>
</div>
<div class="section" id="static-linker">
<h2>Static linker<a class="headerlink" href="#static-linker" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s run the static linker first and explain it next.</p>
<div class="section" id="run">
<h3>Run<a class="headerlink" href="#run" title="Permalink to this headline">¶</a></h3>
<p>File printf-stdarg.c came from internet download which is GPL2 license. GPL2
is more restricted than LLVM license. File printf-stdarg-2.c is modified from
printf-stdarg.c of printf() function supplied and add some test function for
/demo/verification/debugpurpose on Cpu0 backend.
File printf-stdarg-1.c is file for testing the printf()
function implemented on PC OS platform. Let&#8217;s run printf-stdarg-2.c on Cpu0 and
compare with the result of printf() function which implemented by PC OS as
below.</p>
<p class="rubric">lbdex/InputFiles/printf-stdarg-1.c</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">  Copyright 2001, 2002 Georges Menie (www.menie.org)</span>
<span class="cm">  stdarg version contributed by Christian Ettinger</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU Lesser General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU Lesser General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU Lesser General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">  putchar is the only external dependency for this file,</span>
<span class="cm">  if you have a working putchar, leave it commented out.</span>
<span class="cm">  If not, uncomment the define below and</span>
<span class="cm">  replace outbyte(c) by your own function call.</span>

<span class="cm">#define putchar(c) outbyte(c)</span>
<span class="cm">*/</span>

<span class="cp">// gcc printf-stdarg-1.c</span>
<span class="cp">// ./a.out</span>

<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="cp">#define TEST_PRINTF</span>

<span class="cp">#ifdef TEST_PRINTF</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="s">&quot;Hello world!&quot;</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bs</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">mi</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

  <span class="n">mi</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bs</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;printf test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s is null pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d = 5</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d = - max int</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mi</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;char %c = &#39;a&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;hex %x = ff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;hex %02x = 00</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;signed %d = unsigned %u = hex %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d %s(s)%&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d %s(s) with %%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;justif: </span><span class="se">\&quot;</span><span class="s">%-10s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;left&quot;</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;justif: </span><span class="se">\&quot;</span><span class="s">%10s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;right&quot;</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; 3: %04d zero padded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; 3: %-4d left justif.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; 3: %4d right justif.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;-3: %04d zero padded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;-3: %-4d left justif.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;-3: %4d right justif.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * if you compile this file with</span>
<span class="cm"> *   gcc -Wall $(YOUR_C_OPTIONS) -DTEST_PRINTF -c printf.c</span>
<span class="cm"> * you will get a normal warning:</span>
<span class="cm"> *   printf.c:214: warning: spurious trailing `%&#39; in format</span>
<span class="cm"> * this line is testing an invalid % at the end of the format string.</span>
<span class="cm"> *</span>
<span class="cm"> * this should display (on 32bit int machine) :</span>
<span class="cm"> *</span>
<span class="cm"> * Hello world!</span>
<span class="cm"> * printf test</span>
<span class="cm"> * (null) is null pointer</span>
<span class="cm"> * 5 = 5</span>
<span class="cm"> * -2147483647 = - max int</span>
<span class="cm"> * char a = &#39;a&#39;</span>
<span class="cm"> * hex ff = ff</span>
<span class="cm"> * hex 00 = 00</span>
<span class="cm"> * signed -3 = unsigned 4294967293 = hex fffffffd</span>
<span class="cm"> * 0 message(s)</span>
<span class="cm"> * 0 message(s) with %</span>
<span class="cm"> * justif: &quot;left      &quot;</span>
<span class="cm"> * justif: &quot;     right&quot;</span>
<span class="cm"> *  3: 0003 zero padded</span>
<span class="cm"> *  3: 3    left justif.</span>
<span class="cm"> *  3:    3 right justif.</span>
<span class="cm"> * -3: -003 zero padded</span>
<span class="cm"> * -3: -3   left justif.</span>
<span class="cm"> * -3:   -3 right justif.</span>
<span class="cm"> */</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/InputFiles/printf-stdarg-2.c</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;print.h&quot;</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">printf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">sprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...);</span>

<span class="k">struct</span> <span class="n">Time</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">hour</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">minute</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">second</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">Date</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">year</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">month</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">day</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">hour</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">minute</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">second</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">gI</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">Date</span> <span class="n">gDate</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">};</span>

<span class="kt">int</span> <span class="n">test_global</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">gI</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">Date</span> <span class="n">copyDate</span><span class="p">(</span><span class="k">struct</span> <span class="n">Date</span> <span class="n">date</span><span class="p">)</span>
<span class="p">{</span> 
  <span class="k">return</span> <span class="n">date</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">Time</span> <span class="n">copyTime</span><span class="p">(</span><span class="k">struct</span> <span class="n">Time</span> <span class="n">time</span><span class="p">)</span>
<span class="p">{</span> 
  <span class="k">return</span> <span class="n">time</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// For memory IO</span>
<span class="kt">int</span> <span class="n">putchar</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">OUT_MEM</span><span class="p">;</span>
  <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="s">&quot;Hello world!&quot;</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bs</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">mi</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">Time</span> <span class="n">time1</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">};</span>
  <span class="k">struct</span> <span class="n">Time</span> <span class="n">time2</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">Date</span> <span class="n">date</span><span class="p">;</span>

  <span class="n">a</span> <span class="o">=</span> <span class="n">test_global</span><span class="p">();</span>  <span class="c1">// gI = 100</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;global variable gI = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;time1 = %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">time1</span><span class="p">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">time1</span><span class="p">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">time1</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
  <span class="n">date</span> <span class="o">=</span> <span class="n">copyDate</span><span class="p">(</span><span class="n">gDate</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;date = %d %d %d %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">date</span><span class="p">.</span><span class="n">year</span><span class="p">,</span> <span class="n">date</span><span class="p">.</span><span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="p">.</span><span class="n">day</span><span class="p">,</span> <span class="n">date</span><span class="p">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">date</span><span class="p">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">date</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
  <span class="n">time2</span> <span class="o">=</span> <span class="n">copyTime</span><span class="p">(</span><span class="n">time1</span><span class="p">);</span> <span class="c1">// test return V0, V1, A0</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;time2 = %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">time2</span><span class="p">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">time2</span><span class="p">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">time2</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>

  <span class="n">mi</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bs</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;printf test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s is null pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d = 5</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d = - max int</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mi</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;char %c = &#39;a&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;hex %x = ff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;hex %02x = 00</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;signed %d = unsigned %u = hex %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d %s(s)%&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d %s(s) with %%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;justif: </span><span class="se">\&quot;</span><span class="s">%-10s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;left&quot;</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;justif: </span><span class="se">\&quot;</span><span class="s">%10s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;right&quot;</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; 3: %04d zero padded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; 3: %-4d left justif.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; 3: %4d right justif.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;-3: %04d zero padded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;-3: %-4d left justif.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;-3: %4d right justif.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/InputFiles/printf-stdarg.c</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">	Copyright 2001, 2002 Georges Menie (www.menie.org)</span>
<span class="cm">	stdarg version contributed by Christian Ettinger</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU Lesser General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU Lesser General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU Lesser General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">	putchar is the only external dependency for this file,</span>
<span class="cm">	if you have a working putchar, leave it commented out.</span>
<span class="cm">	If not, uncomment the define below and</span>
<span class="cm">	replace outbyte(c) by your own function call.</span>

<span class="cm">#define putchar(c) outbyte(c)</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;stdarg.h&gt;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">printchar</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">extern</span> <span class="kt">int</span> <span class="n">putchar</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">**</span><span class="n">str</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">putchar</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define PAD_RIGHT 1</span>
<span class="cp">#define PAD_ZERO 2</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">prints</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">out</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pad</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="kt">int</span> <span class="n">pc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">padchar</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">register</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">register</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">string</span><span class="p">;</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span> <span class="o">++</span><span class="n">ptr</span><span class="p">)</span> <span class="o">++</span><span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">width</span><span class="p">)</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="n">width</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pad</span> <span class="o">&amp;</span> <span class="n">PAD_ZERO</span><span class="p">)</span> <span class="n">padchar</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pad</span> <span class="o">&amp;</span> <span class="n">PAD_RIGHT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">width</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printchar</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">padchar</span><span class="p">);</span>
			<span class="o">++</span><span class="n">pc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">*</span><span class="n">string</span> <span class="p">;</span> <span class="o">++</span><span class="n">string</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printchar</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">*</span><span class="n">string</span><span class="p">);</span>
		<span class="o">++</span><span class="n">pc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">width</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printchar</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">padchar</span><span class="p">);</span>
		<span class="o">++</span><span class="n">pc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">/* the following should be enough for 32 bit int */</span>
<span class="cp">#define PRINT_BUF_LEN 12</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">printi</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">out</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pad</span><span class="p">,</span> <span class="kt">int</span> <span class="n">letbase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">print_buf</span><span class="p">[</span><span class="n">PRINT_BUF_LEN</span><span class="p">];</span>
	<span class="k">register</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="n">neg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">u</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
		<span class="n">print_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">prints</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">print_buf</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sg</span> <span class="o">&amp;&amp;</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">neg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">u</span> <span class="o">=</span> <span class="o">-</span><span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">print_buf</span> <span class="o">+</span> <span class="n">PRINT_BUF_LEN</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">u</span> <span class="o">%</span> <span class="n">b</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="p">)</span>
			<span class="n">t</span> <span class="o">+=</span> <span class="n">letbase</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>
		<span class="o">*--</span><span class="n">s</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
		<span class="n">u</span> <span class="o">/=</span> <span class="n">b</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">neg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">width</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pad</span> <span class="o">&amp;</span> <span class="n">PAD_ZERO</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">printchar</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="sc">&#39;-&#39;</span><span class="p">);</span>
			<span class="o">++</span><span class="n">pc</span><span class="p">;</span>
			<span class="o">--</span><span class="n">width</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="o">*--</span><span class="n">s</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pc</span> <span class="o">+</span> <span class="n">prints</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">print</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">out</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="n">va_list</span> <span class="n">args</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">int</span> <span class="n">pc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">scr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="o">*</span><span class="n">format</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">++</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;%&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">++</span><span class="n">format</span><span class="p">;</span>
			<span class="n">width</span> <span class="o">=</span> <span class="n">pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;%&#39;</span><span class="p">)</span> <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">++</span><span class="n">format</span><span class="p">;</span>
				<span class="n">pad</span> <span class="o">=</span> <span class="n">PAD_RIGHT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">++</span><span class="n">format</span><span class="p">;</span>
				<span class="n">pad</span> <span class="o">|=</span> <span class="n">PAD_ZERO</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">*</span><span class="n">format</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">format</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">;</span> <span class="o">++</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">width</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
				<span class="n">width</span> <span class="o">+=</span> <span class="o">*</span><span class="n">format</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;s&#39;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">register</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="p">);</span>
				<span class="n">pc</span> <span class="o">+=</span> <span class="n">prints</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">s</span><span class="o">?</span><span class="nl">s:</span><span class="s">&quot;(null)&quot;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;d&#39;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">pc</span> <span class="o">+=</span> <span class="n">printi</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">va_arg</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;x&#39;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">pc</span> <span class="o">+=</span> <span class="n">printi</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">va_arg</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="p">),</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;X&#39;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">pc</span> <span class="o">+=</span> <span class="n">printi</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">va_arg</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="p">),</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;u&#39;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">pc</span> <span class="o">+=</span> <span class="n">printi</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">va_arg</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">format</span> <span class="o">==</span> <span class="sc">&#39;c&#39;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* char are converted to int then pushed on the stack */</span>
				<span class="n">scr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="p">);</span>
				<span class="n">scr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
				<span class="n">pc</span> <span class="o">+=</span> <span class="n">prints</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">scr</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
		<span class="nl">out:</span>
			<span class="n">printchar</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">*</span><span class="n">format</span><span class="p">);</span>
			<span class="o">++</span><span class="n">pc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">**</span><span class="n">out</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">va_end</span><span class="p">(</span> <span class="n">args</span> <span class="p">);</span>
	<span class="k">return</span> <span class="n">pc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">printf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
        <span class="n">va_list</span> <span class="n">args</span><span class="p">;</span>
        
        <span class="n">va_start</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="n">format</span> <span class="p">);</span>
        <span class="k">return</span> <span class="n">print</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">args</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">sprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
        <span class="n">va_list</span> <span class="n">args</span><span class="p">;</span>
        
        <span class="n">va_start</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="n">format</span> <span class="p">);</span>
        <span class="k">return</span> <span class="n">print</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">args</span> <span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef TEST_PRINTF</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="s">&quot;Hello world!&quot;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bs</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mi</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

	<span class="n">mi</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bs</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;printf test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s is null pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d = 5</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d = - max int</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mi</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;char %c = &#39;a&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;hex %x = ff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;hex %02x = 00</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;signed %d = unsigned %u = hex %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d %s(s)%&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d %s(s) with %%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;justif: </span><span class="se">\&quot;</span><span class="s">%-10s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;left&quot;</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;justif: </span><span class="se">\&quot;</span><span class="s">%10s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;right&quot;</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; 3: %04d zero padded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; 3: %-4d left justif.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; 3: %4d right justif.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;-3: %04d zero padded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;-3: %-4d left justif.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;-3: %4d right justif.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * if you compile this file with</span>
<span class="cm"> *   gcc -Wall $(YOUR_C_OPTIONS) -DTEST_PRINTF -c printf.c</span>
<span class="cm"> * you will get a normal warning:</span>
<span class="cm"> *   printf.c:214: warning: spurious trailing `%&#39; in format</span>
<span class="cm"> * this line is testing an invalid % at the end of the format string.</span>
<span class="cm"> *</span>
<span class="cm"> * this should display (on 32bit int machine) :</span>
<span class="cm"> *</span>
<span class="cm"> * Hello world!</span>
<span class="cm"> * printf test</span>
<span class="cm"> * (null) is null pointer</span>
<span class="cm"> * 5 = 5</span>
<span class="cm"> * -2147483647 = - max int</span>
<span class="cm"> * char a = &#39;a&#39;</span>
<span class="cm"> * hex ff = ff</span>
<span class="cm"> * hex 00 = 00</span>
<span class="cm"> * signed -3 = unsigned 4294967293 = hex fffffffd</span>
<span class="cm"> * 0 message(s)</span>
<span class="cm"> * 0 message(s) with %</span>
<span class="cm"> * justif: &quot;left      &quot;</span>
<span class="cm"> * justif: &quot;     right&quot;</span>
<span class="cm"> *  3: 0003 zero padded</span>
<span class="cm"> *  3: 3    left justif.</span>
<span class="cm"> *  3:    3 right justif.</span>
<span class="cm"> * -3: -003 zero padded</span>
<span class="cm"> * -3: -3   left justif.</span>
<span class="cm"> * -3:   -3 right justif.</span>
<span class="cm"> */</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/InputFiles/start.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;dynamic_linker.h&quot;</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">main</span><span class="p">();</span>

<span class="cp">#define initRegs() \</span>
<span class="cp">  asm(&quot;addiu $1,	$ZERO, 0&quot;); \</span>
<span class="cp">  asm(&quot;addiu $2,	$ZERO, 0&quot;); \</span>
<span class="cp">  asm(&quot;addiu $3,	$ZERO, 0&quot;); \</span>
<span class="cp">  asm(&quot;addiu $4,	$ZERO, 0&quot;); \</span>
<span class="cp">  asm(&quot;addiu $5,	$ZERO, 0&quot;); \</span>
<span class="cp">  asm(&quot;addiu $6,	$ZERO, 0&quot;); \</span>
<span class="cp">  asm(&quot;addiu $7,	$ZERO, 0&quot;); \</span>
<span class="cp">  asm(&quot;addiu $8,	$ZERO, 0&quot;); \</span>
<span class="cp">  asm(&quot;addiu $9,	$ZERO, 0&quot;); \</span>
<span class="cp">  asm(&quot;addiu $10,	$ZERO, 0&quot;); \</span>
<span class="cp">  asm(&quot;addiu $fp, $ZERO, 0&quot;);</span>

<span class="kt">void</span> <span class="n">start</span><span class="p">()</span> <span class="p">{</span>
<span class="c1">//  asm(&quot;boot:&quot;);</span>
  <span class="k">asm</span><span class="p">(</span><span class="s">&quot;lui   $1,  0x7&quot;</span><span class="p">);</span>
  <span class="k">asm</span><span class="p">(</span><span class="s">&quot;ori   $1,  $1, 0xfff0&quot;</span><span class="p">);</span>
  <span class="k">asm</span><span class="p">(</span><span class="s">&quot;ld    $gp, 0($1)&quot;</span><span class="p">);</span> <span class="c1">// load $gp($10) value from 0x7fff0</span>
  <span class="n">initRegs</span><span class="p">();</span>
  <span class="k">asm</span><span class="p">(</span><span class="s">&quot;addiu $sp, $zero, 0x6ffc&quot;</span><span class="p">);</span>
  <span class="n">main</span><span class="p">();</span>
  <span class="k">asm</span><span class="p">(</span><span class="s">&quot;addiu $lr, $ZERO, -1&quot;</span><span class="p">);</span>
  <span class="k">asm</span><span class="p">(</span><span class="s">&quot;ret $lr&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/InputFiles/build-printf-stdarg-2.sh</p>
<div class="highlight-c++"><pre>#!/usr/bin/env bash
#TOOLDIR=/home/Gamma/test/lld/cmake_debug_build/bin
TOOLDIR=/home/cschen/test/lld/cmake_debug_build/bin

cpu=cpu032I

/usr/local/llvm/release/cmake_debug_build/bin/clang -target mips-unknown-linux-gnu -c start.cpp -emit-llvm -o start.bc
/usr/local/llvm/release/cmake_debug_build/bin/clang -target mips-unknown-linux-gnu -c printf-stdarg.c -emit-llvm -o printf-stdarg.bc
/usr/local/llvm/release/cmake_debug_build/bin/clang -target mips-unknown-linux-gnu -c printf-stdarg-2.c -emit-llvm -o printf-stdarg-2.bc
${TOOLDIR}/llc -march=cpu0 -mcpu=${cpu} -relocation-model=static -filetype=obj  start.bc -o start.cpu0.o
${TOOLDIR}/llc -march=cpu0 -mcpu=${cpu} -relocation-model=static -filetype=obj printf-stdarg.bc -o printf-stdarg.cpu0.o
${TOOLDIR}/llc -march=cpu0 -mcpu=${cpu} -relocation-model=static -filetype=obj printf-stdarg-2.bc -o printf-stdarg-2.cpu0.o
${TOOLDIR}/lld -flavor gnu -target cpu0-unknown-linux-gnu start.cpu0.o printf-stdarg.cpu0.o printf-stdarg-2.cpu0.o -o a.out
${TOOLDIR}/llvm-objdump -elf2hex a.out &gt; ../cpu0_verilog/cpu0.hex
</pre>
</div>
<p>The cpu0_verilog/cpu0Is.v support cmp instruction and static linker as follows,</p>
<p class="rubric">lbdex/cpu0_verilog/cpu0Is.v</p>
<div class="highlight-c++"><pre>// TRACE: Display the memory contents of the loaded program and data
//`define TRACE 

`include "cpu0.v"

</pre>
</div>
<p>The cpu0_verilog/cpu0IIs.v support slt instruction and static linker as follows,</p>
<p class="rubric">lbdex/cpu0_verilog/cpu0IIs.v</p>
<div class="highlight-c++"><pre>`define CPU0II
// TRACE: Display the memory contents of the loaded program and data
//`define TRACE 

`include "cpu0.v"

</pre>
</div>
<p>The build-printf-stdarg-2.sh is for my PC setting. Please change this script to
your lld installed directory and run static linker example code as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>Gamma@localhost cpu0_verilog<span class="o">]</span><span class="nv">$ </span><span class="nb">pwd</span>
/home/Gamma/test/lbd/docs/BackendTutorial/source_ExampleCode/cpu0_verilog
<span class="o">[</span>Gamma@localhost cpu0_verilog<span class="o">]</span><span class="nv">$ </span>bash clean.sh
<span class="o">[</span>Gamma@localhost InputFiles<span class="o">]</span><span class="nv">$ </span><span class="nb">cd</span> ../InputFiles/
<span class="o">[</span>Gamma@localhost InputFiles<span class="o">]</span><span class="nv">$ </span>bash build-printf-stdarg-2.sh
<span class="nb">printf</span>-stdarg-2.c:85:19: warning: incomplete format specifier <span class="o">[</span>-Wformat<span class="o">]</span>
  <span class="nb">printf</span><span class="o">(</span><span class="s2">&quot;%d %s(s)%&quot;</span>, 0, <span class="s2">&quot;message&quot;</span><span class="o">)</span>;
                  ^
1 warning generated.
<span class="o">[</span>Gamma@localhost InputFiles<span class="o">]</span><span class="nv">$ </span><span class="nb">cd</span> ../cpu0_verilog/
<span class="o">[</span>Gamma@localhost cpu0_verilog<span class="o">]</span><span class="nv">$ </span><span class="nb">pwd</span>
/home/Gamma/test/lbd/docs/BackendTutorial/source_ExampleCode/cpu0_verilog
<span class="o">[</span>Gamma@localhost cpu0_verilog<span class="o">]</span><span class="nv">$ </span>iverilog -o cpu0IIs cpu0IIs.v
<span class="o">[</span>Gamma@localhost cpu0_verilog<span class="o">]</span><span class="nv">$ </span>ls
clean.sh  cpu0Id.v  cpu0IId.v  cpu0IIs  cpu0IIs.v  cpu0Is.v  cpu0.v  dynlinker.v
flashio.v
<span class="o">[</span>Gamma@localhost cpu0_verilog<span class="o">]</span><span class="nv">$ </span>./cpu0IIs
WARNING: cpu0.v:365: <span class="nv">$readmemh</span><span class="o">(</span>cpu0s.hex<span class="o">)</span>: Not enough words in the file <span class="k">for</span>
the requested range <span class="o">[</span>0:524287<span class="o">]</span>.
taskInterrupt<span class="o">(</span>001<span class="o">)</span>
global variable <span class="nv">gI</span> <span class="o">=</span> 100
<span class="nv">time1</span> <span class="o">=</span> 1 10 12
<span class="nv">date</span> <span class="o">=</span> 2012 10 12 1 2 3
<span class="nv">time2</span> <span class="o">=</span> 1 10 12
Hello world!
<span class="nb">printf test</span>
<span class="o">(</span>null<span class="o">)</span> is null pointer
<span class="nv">5</span> <span class="o">=</span> 5
-2147483647 <span class="o">=</span> - max int
char <span class="nv">a</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
hex <span class="nv">ff</span> <span class="o">=</span> ff
hex <span class="nv">00</span> <span class="o">=</span> 00
signed -3 <span class="o">=</span> unsigned <span class="nv">4294967293</span> <span class="o">=</span> hex fffffffd
0 message<span class="o">(</span>s<span class="o">)</span>
0 message<span class="o">(</span>s<span class="o">)</span> with <span class="se">\%</span>
justif: <span class="s2">&quot;left      &quot;</span>
justif: <span class="s2">&quot;     right&quot;</span>
 3: 0003 zero padded
 3: 3    left justif.
 3:    3 right justif.
-3: -003 zero padded
</pre></div>
</div>
<p>Let&#8217;s check the result with PC program printf-stdarg-1.c output as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>Gamma@localhost InputFiles<span class="o">]</span><span class="nv">$ </span>gcc <span class="nb">printf</span>-stdarg-1.c
/usr/lib/gcc/x86_64-redhat-linux/4.7.2/../../../../lib64/crt1.o: In <span class="k">function</span>
<span class="sb">`</span>_start<span class="s1">&#39;:</span>
<span class="s1">(.text+0x20): undefined reference to `main&#39;</span>
collect2: error: ld returned 1 <span class="nb">exit </span>status
<span class="o">[</span>Gamma@localhost InputFiles<span class="o">]</span><span class="nv">$ </span>gcc <span class="nb">printf</span>-stdarg-1.c
<span class="o">[</span>Gamma@localhost InputFiles<span class="o">]</span><span class="nv">$ </span>./a.out
Hello world!
<span class="nb">printf test</span>
<span class="o">(</span>null<span class="o">)</span> is null pointer
<span class="nv">5</span> <span class="o">=</span> 5
-2147483647 <span class="o">=</span> - max int
char <span class="nv">a</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
hex <span class="nv">ff</span> <span class="o">=</span> ff
hex <span class="nv">00</span> <span class="o">=</span> 00
signed -3 <span class="o">=</span> unsigned <span class="nv">4294967293</span> <span class="o">=</span> hex fffffffd
0 message<span class="o">(</span>s<span class="o">)</span>
0 message<span class="o">(</span>s<span class="o">)</span> with <span class="se">\%</span>
justif: <span class="s2">&quot;left      &quot;</span>
justif: <span class="s2">&quot;     right&quot;</span>
 3: 0003 zero padded
 3: 3    left justif.
 3:    3 right justif.
-3: -003 zero padded
-3: -3   left justif.
-3:   -3 right justif.
</pre></div>
</div>
<p>They are same after the &#8220;Hello world!&#8221; of printf() function support.
The cpu0I use cmp instruction. You can verify the slt
instructions is work fine too by change cpu to cpu032II as follows,</p>
<p class="rubric">lbdex/InputFiles/build-printf-stdarg-2.sh</p>
<div class="highlight-bash"><div class="highlight"><pre>...
<span class="nv">cpu</span><span class="o">=</span>cpu032II
...
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>Gamma@localhost cpu0_verilog<span class="o">]</span><span class="nv">$ </span><span class="nb">pwd</span>
/home/Gamma/test/lbd/docs/BackendTutorial/source_ExampleCode/cpu0_verilog
<span class="o">[</span>Gamma@localhost cpu0_verilog<span class="o">]</span><span class="nv">$ </span>bash clean.sh
<span class="o">[</span>Gamma@localhost InputFiles<span class="o">]</span><span class="nv">$ </span><span class="nb">cd</span> ../InputFiles/
<span class="o">[</span>Gamma@localhost InputFiles<span class="o">]</span><span class="nv">$ </span>bash build-printf-stdarg-2.sh
<span class="nb">printf</span>-stdarg.c:102:19: warning: incomplete format specifier <span class="o">[</span>-Wformat<span class="o">]</span>
  <span class="nb">printf</span><span class="o">(</span><span class="s2">&quot;%d %s(s)\%&quot;</span>, 0, <span class="s2">&quot;message&quot;</span><span class="o">)</span>;
                  ^
1 warning generated.
<span class="o">[</span>Gamma@localhost cpu0_verilog<span class="o">]</span><span class="nv">$ </span>./cpu0IIs
</pre></div>
</div>
<p>The verilog machine cpu032II include cpu0I all instructions (cmp, jeq, ...
are included also) and add Chapter12_2 slt, beq, ..., instructions.
Run build-printf-stdarg-2.sh with cpu=cpu032II will generate slt, beq and bne
instructions instead cmp, jeq, ... instructions. Since cpu0IIs include both
slt, cmp, ... instructions, the slt and cmp both code generated can be run on
it without any problem.</p>
</div>
<div class="section" id="cpu0-lld-structure">
<h3>Cpu0 lld structure<a class="headerlink" href="#cpu0-lld-structure" title="Permalink to this headline">¶</a></h3>
<div class="figure align-center" id="lld-f1">
<a class="reference internal image-reference" href="_images/16.png"><img alt="_images/16.png" src="_images/16.png" style="width: 757.0px; height: 830.0px;" /></a>
<p class="caption">Figure 1: Cpu0 lld class relation ship</p>
</div>
<div class="figure align-center" id="lld-f2">
<a class="reference internal image-reference" href="_images/25.png"><img alt="_images/25.png" src="_images/25.png" style="width: 459.2px; height: 699.2px;" /></a>
<p class="caption">Figure 2: Cpu0 lld ELFLinkingContext and DefaultLayout member functions</p>
</div>
<div class="figure align-center" id="lld-f3">
<a class="reference internal image-reference" href="_images/34.png"><img alt="_images/34.png" src="_images/34.png" style="width: 833.0px; height: 726.0px;" /></a>
<p class="caption">Figure 3: Cpu0 lld RelocationPass</p>
</div>
<p>The Cpu0LinkingContext include the context information for those obj files you
want to link.
When do linking, the following code will create Cpu0LinkingContext.</p>
<p class="rubric">lbdex/Cpu0_lld_1030/ELFLinkingContext.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">ELFLinkingContext</span><span class="o">&gt;</span>
<span class="n">ELFLinkingContext</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span> <span class="n">triple</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">triple</span><span class="p">.</span><span class="n">getArch</span><span class="p">())</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span><span class="o">::</span><span class="nl">cpu0:</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">ELFLinkingContext</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="k">new</span> <span class="n">lld</span><span class="o">::</span><span class="n">elf</span><span class="o">::</span><span class="n">Cpu0LinkingContext</span><span class="p">(</span><span class="n">triple</span><span class="p">));</span>
  <span class="k">default</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">nullptr</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>While Cpu0LinkingContext is created by lld ELF driver as above, the following
code in Cpu0LinkingContext constructor will create Cpu0TargetHandler and passing
the Cpu0LinkingContext object pointer to Cpu0TargeHandler.</p>
<p class="rubric">lbdex/Cpu0_lld_1030/Cpu0/Cpu0LinkingContext.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Cpu0LinkingContext</span> <span class="n">LLVM_FINAL</span> <span class="o">:</span> <span class="k">public</span> <span class="n">ELFLinkingContext</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0LinkingContext</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span> <span class="n">triple</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">ELFLinkingContext</span><span class="p">(</span><span class="n">triple</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">TargetHandlerBase</span><span class="o">&gt;</span><span class="p">(</span>
                                  <span class="k">new</span> <span class="n">Cpu0TargetHandler</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)))</span> <span class="p">{}</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Finally, the Cpu0TargeHandler constructor will create other related objects
and set up the relation reference object pointers as <a class="pageref" href="#lld-f1">Figure  1</a>
depicted by the following code.</p>
<p class="rubric">lbdex/Cpu0_lld_1030/Cpu0/Cpu0TargetHandler.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">Cpu0TargetHandler</span><span class="o">::</span><span class="n">Cpu0TargetHandler</span><span class="p">(</span><span class="n">Cpu0LinkingContext</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">DefaultTargetHandler</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="n">_gotFile</span><span class="p">(</span><span class="k">new</span> <span class="n">GOTFile</span><span class="p">(</span><span class="n">context</span><span class="p">)),</span>
      <span class="n">_relocationHandler</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="n">_targetLayout</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="p">{}</span>
</pre></div>
</div>
<p>According chapter ELF, the linker stands for resolve the relocation records.
The following code give the chance to let lld system call our relocation
function at proper time.</p>
<p class="rubric">lbdex/Cpu0_lld_1030/Cpu0/Cpu0RelocationPass.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Pass</span><span class="o">&gt;</span>
<span class="n">lld</span><span class="o">::</span><span class="n">elf</span><span class="o">::</span><span class="n">createCpu0RelocationPass</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0LinkingContext</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">getOutputELFType</span><span class="p">())</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="nl">ET_EXEC:</span>
<span class="cp">#ifdef DLINKER</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">isDynamic</span><span class="p">())</span>
      <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Pass</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">DynamicRelocationPass</span><span class="p">(</span><span class="n">ctx</span><span class="p">));</span>
    <span class="k">else</span>
<span class="cp">#endif </span><span class="c1">// DLINKER</span>
      <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Pass</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">StaticRelocationPass</span><span class="p">(</span><span class="n">ctx</span><span class="p">));</span>
<span class="cp">#ifdef DLINKER</span>
  <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="nl">ET_DYN:</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Pass</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">DynamicRelocationPass</span><span class="p">(</span><span class="n">ctx</span><span class="p">));</span>
<span class="cp">#endif </span><span class="c1">// DLINKER</span>
  <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">ELF</span><span class="o">::</span><span class="nl">ET_REL:</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Pass</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="k">default</span><span class="o">:</span>
    <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;Unhandled output file type&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The &#8220;#ifdef DLINKER&#8221; part is for dynamic linker will used in next section.
For static linker, a StaticRelocationPass object is created and return.</p>
<p>Now the following code of Cpu0TargetRelocationHandler::applyRelocation()
will be called through
Cpu0TargetHandler by lld ELF driver when it meet each relocation record.</p>
<p class="rubric">lbdex/Cpu0_lld_1030/Cpu0/Cpu0RelocationHandler.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">ErrorOr</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">Cpu0TargetRelocationHandler</span><span class="o">::</span><span class="n">applyRelocation</span><span class="p">(</span>
    <span class="n">ELFWriter</span> <span class="o">&amp;</span><span class="n">writer</span><span class="p">,</span> <span class="n">llvm</span><span class="o">::</span><span class="n">FileOutputBuffer</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="n">lld</span><span class="o">::</span><span class="n">AtomLayout</span> <span class="o">&amp;</span><span class="n">atom</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">Reference</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>

  <span class="k">switch</span> <span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">kind</span><span class="p">())</span> <span class="p">{</span>
  <span class="k">case</span> <span class="nl">R_CPU0_NONE:</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">R_CPU0_HI16:</span>
    <span class="n">relocHI16</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">relocVAddress</span><span class="p">,</span> <span class="n">targetVAddress</span><span class="p">,</span> <span class="n">ref</span><span class="p">.</span><span class="n">addend</span><span class="p">());</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">R_CPU0_LO16:</span>
    <span class="n">relocLO16</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">relocVAddress</span><span class="p">,</span> <span class="n">targetVAddress</span><span class="p">,</span> <span class="n">ref</span><span class="p">.</span><span class="n">addend</span><span class="p">());</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">...</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">error_code</span><span class="o">::</span><span class="n">success</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/Cpu0_lld_1030/Cpu0/Cpu0TargetHandler.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Cpu0TargetHandler</span> <span class="n">LLVM_FINAL</span>
    <span class="o">:</span> <span class="k">public</span> <span class="n">DefaultTargetHandler</span><span class="o">&lt;</span><span class="n">Cpu0ELFType</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="p">..</span>
  <span class="k">virtual</span> <span class="k">const</span> <span class="n">Cpu0TargetRelocationHandler</span> <span class="o">&amp;</span><span class="n">getRelocationHandler</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">_relocationHandler</span><span class="p">;</span>
  <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="dynamic-linker">
<h2>Dynamic linker<a class="headerlink" href="#dynamic-linker" title="Permalink to this headline">¶</a></h2>
<p>Except the lld code with #ifdef DLINKER. The following code in Verilog exist to
support dynamic linker.</p>
<p class="rubric">lbdex/cpu0_verilog/dynlinker.v</p>
<div class="highlight-c++"><pre>`define DLINKER_INFO_ADDR  'h70000
`define GPADDR    'h7FFF0

`ifdef DLINKER
  task setDynLinkerInfo; begin
// below code set memory as follows,
//                                                            (4 bytes) 
//                                                      ---------------------------------------
// DLINKER_INFO_ADDR ----------&gt;                        | numDynEntry                         |
//                                                      ---------------------------------------
// DLINKER_INFO_ADDR+4 --------&gt;                        | index of dynsym (0st row)           |
//   above is the 1st word of section .dynsym of libfoobar.cpu0.so. 
// DLINKER_INFO_ADDR+8 --------&gt;                        | index of dynsym (1st row)           |
//                                                      | ...                                 |
// DLINKER_INFO_ADDR+(numDynEntry-1)*4 ---------------&gt; | index of dynsym (the last row)      |
//                                                      ---------------------------------------
// DLINKER_INFO_ADDR+numDynEntry*4 -------------------&gt; | 1st function (foo()) offset in lib  |
// DLINKER_INFO_ADDR+numDynEntry*4+4 -----------------&gt; | 1st function (foo()) name (48 bytes)|
//                                                      | ...                                 |
// DLINKER_INFO_ADDR+numDynEntry+(numDynEntry-1)*4 ---&gt; | last function (foo()) offset in lib |
// DLINKER_INFO_ADDR+numDynEntry+(numDynEntry-1)*4+4 -&gt; | last function (foo()) name          |
//                                                      ---------------------------------------
// DLINKER_INFO_ADDR+4+numDynEntry*4+numDynEntry*52 --&gt; | .dynstr of lib                      |
//                                                      |   ...                               |
//                                                      ---------------------------------------
  // caculate number of dynamic entries
    numDynEntry = 0;
    j = 0;
    for (i=0; i &lt; 384 &amp;&amp; j == 0; i=i+52) begin
       if (so_func_offset[i] == `MEMEMPTY &amp;&amp; so_func_offset[i+1] == `MEMEMPTY &amp;&amp; 
           so_func_offset[i+2] == `MEMEMPTY &amp;&amp; so_func_offset[i+3] == `MEMEMPTY) begin
         numDynEntry = i/52;
         j = 1;
       `ifdef DEBUG_DLINKER
         $display("numDynEntry = %8x", numDynEntry);
       `endif
       end
    end
  // save number of dynamic entries to memory address `DLINKER_INFO_ADDR
    m[`DLINKER_INFO_ADDR] = numDynEntry[31:24];
    m[`DLINKER_INFO_ADDR+1] = numDynEntry[23:16];
    m[`DLINKER_INFO_ADDR+2] = numDynEntry[15:8];
    m[`DLINKER_INFO_ADDR+3] = numDynEntry[7:0];
  // copy section .dynsym of ELF to memory address `DLINKER_INFO_ADDR+4
    i = `DLINKER_INFO_ADDR+4;
    for (j=0; j &lt; (4*numDynEntry); j=j+4) begin
      m[i] = dsym[j];
      m[i+1] = dsym[j+1];
      m[i+2] = dsym[j+2];
      m[i+3] = dsym[j+3];
      i = i + 4;
    end
  // copy the offset values of section .text of shared library .so of ELF to 
  // memory address `DLINKER_INFO_ADDR+4+numDynEntry*4
    i = `DLINKER_INFO_ADDR+4+numDynEntry*4;
    l = 0;
    for (j=0; j &lt; numDynEntry; j=j+1) begin
      for (k=0; k &lt; 52; k=k+1) begin
        m[i] = so_func_offset[l];
        i = i + 1;
        l = l + 1;
      end
    end
  `ifdef DEBUG_DLINKER
    i = `DLINKER_INFO_ADDR+4+numDynEntry*4;
    for (j=0; j &lt; (8*numDynEntry); j=j+8) begin
       $display("%8x: %8x", i, {m[i], m[i+1], m[i+2], m[i+3]});
      i = i + 8;
    end
  `endif
  // copy section .dynstr of ELF to memory address 
  // `DLINKER_INFO_ADDR+4+numDynEntry*4+numDynEntry*52
    i=`DLINKER_INFO_ADDR+4+numDynEntry*4+numDynEntry*52;
    for (j=0; dstr[j] != `MEMEMPTY; j=j+1) begin
      m[i] = dstr[j];
      i = i + 1;
    end
  `ifdef DEBUG_DLINKER
    $display("In setDynLinkerInfo()");
    for (i=`DLINKER_INFO_ADDR; i &lt; `MEMSIZE; i=i+4) begin
       if (m[i] != `MEMEMPTY || m[i+1] != `MEMEMPTY || 
         m[i+2] != `MEMEMPTY || m[i+3] != `MEMEMPTY)
         $display("%8x: %8x", i, {m[i], m[i+1], m[i+2], m[i+3]});
    end
    $display("global address %8x", {m[`GPADDR], m[`GPADDR+1], 
             m[`GPADDR+2], m[`GPADDR+3]});
    $display("gp = %8x", gp);
  `endif
// below code set memory as follows,
//                                 -----------------------------------
// gp ---------------------------&gt; | all 0                           | (16 bytes)
// gp+16 ------------------------&gt; | 0                          |
// gp+16+1*4 --------------------&gt; | 1st plt entry address      | (4 bytes)
//                                 | ...                        |
// gp+16+(numDynEntry-1)*4 ------&gt; | the last plt entry address |
//                                 ------------------------------
// gp ---------------------------&gt; | all 0                           | (16 bytes)
// gp+16+0*8'h10 ----------------&gt; | 32'h10: pointer to plt0         |
// gp+16+1*8'h10 ----------------&gt; | 1st plt entry                   |
// gp+16+2*8'h10 ----------------&gt; | 2nd plt entry                   |
//                                 | ...                             |
// gp+16+(numDynEntry-1)*8'h10 --&gt; | the last plt entry              |
//                                 -----------------------------------
// note: gp point to the _GLOBAL_OFFSET_TABLE_, 
//       numDynEntry = actual number of functions + 1.
//   gp+1*4..gp+numDynEntry*4 set to 8'h10 plt0 which will jump to dynamic 
//   linker.
//   After dynamic linker load function to memory, it will set gp+index*4 to 
//   function memory address. For example, if the function index is 2, then the 
//   gp+2*4 is set to the memory address of this loaded function. 
//   Then the the caller call 
//   "ld $t9, 2*4($gp)" and "ret $t9" will jump to this loaded function directly.

    gpPlt = gp+16+numDynEntry*4;
    // set (gpPlt-16..gpPlt-1) to 0
    for (j=16; j &gt;= 1; j=j-1)
      m[gpPlt+j] = 8'h00;
    // put plt in (gpPlt..gpPlt+numDynEntry*8'h10+1)
    for (i=1; i &lt; numDynEntry; i=i+1) begin
      j=i*4;
      // (gp+'8h10..gp+numDynEntry*'8h10+15) set to plt entry
      // addiu	$t9, $zero, dynsym_idx
      m[gpPlt+i*8'h10] = 8'h09;
      m[gpPlt+i*8'h10+1] = 8'h60;
      m[gpPlt+i*8'h10+2] = i[15:8];
      m[gpPlt+i*8'h10+3] = i[7:0];
      // st	$t9, j($gp)
      m[gpPlt+i*8'h10+4] = 8'h02;
      m[gpPlt+i*8'h10+5] = 8'h6b;
      m[gpPlt+i*8'h10+6] = 0;
      m[gpPlt+i*8'h10+7] = 0;
      // ld	$t9, ('16h0010)($gp)
      m[gpPlt+i*8'h10+8] = 8'h01;
      m[gpPlt+i*8'h10+9] = 8'h6b;
      m[gpPlt+i*8'h10+10] = 0;
      m[gpPlt+i*8'h10+11] = 8'h10;
      // ret	$t9
      m[gpPlt+i*8'h10+12] = 8'h3c;
      m[gpPlt+i*8'h10+13] = 8'h60;
      m[gpPlt+i*8'h10+14] = 0;
      m[gpPlt+i*8'h10+15] = 0;
    end

  // .got.plt offset(0x00.0x03) has been set to 0 in elf already.
  // Set .got.plt offset(8'h10..numDynEntry*'8h10) point to plt entry as above.
  `ifdef DEBUG_DLINKER
         $display("numDynEntry = %8x", numDynEntry);
  `endif
//      j32=32'h1fc0; // m[32'h1fc]="something" will hang. Very tricky
    m[gp+16] = 8'h0;
    m[gp+16+1] = 8'h0;
    m[gp+16+2] = 8'h0;
    m[gp+16+3] = 8'h10;
    j32=gpPlt+16;
    for (i=1; i &lt; numDynEntry; i=i+1) begin
      m[gp+16+i*4] = j32[31:24];
      m[gp+16+i*4+1] = j32[23:16];
      m[gp+16+i*4+2] = j32[15:8];
      m[gp+16+i*4+3] = j32[7:0];
      j32=j32+16;
    end
  `ifdef DEBUG_DLINKER
    // show (gp..gp+numDynEntry*4-1)
    for (i=0; i &lt; numDynEntry; i=i+1) begin
      $display("%8x: %8x", gp+16+i*4, {m[gp+16+i*4], m[gp+16+i*4+1], 
               m[gp+16+i*4+2], m[gp+16+i*4+3]});
    end
    // show (gpPlt..gpPlt+(numDynEntry+1)*8'h10-1)
    for (i=0; i &lt; numDynEntry; i=i+1) begin
      for (j=0; j &lt; 16; j=j+4)
        $display("%8x: %8x", gpPlt+i*8'h10+j, 
                 {m[gpPlt+i*8'h10+j], 
                  m[gpPlt+i*8'h10+j+1], 
                  m[gpPlt+i*8'h10+j+2], 
                  m[gpPlt+i*8'h10+j+3]});
    end
  `endif
  end endtask
`endif

`ifdef DLINKER
  task loadToFlash; begin
  // erase memory
    for (i=0; i &lt; `MEMSIZE; i=i+1) begin
       flash[i] = `MEMEMPTY;
    end
    $readmemh("libso.hex", flash);
  `ifdef DEBUG_DLINKER
    for (i=0; i &lt; `MEMSIZE &amp;&amp; (flash[i] != `MEMEMPTY || 
         flash[i+1] != `MEMEMPTY || flash[i+2] != `MEMEMPTY || 
         flash[i+3] != `MEMEMPTY); i=i+4) begin
       $display("%8x: %8x", i, {flash[i], flash[i+1], flash[i+2], flash[i+3]});
    end
  `endif
  end endtask
`endif

`ifdef DLINKER
  task createDynInfo; begin
    $readmemh("global_offset", globalAddr);
    m[`GPADDR]   = globalAddr[0];
    m[`GPADDR+1] = globalAddr[1];
    m[`GPADDR+2] = globalAddr[2];
    m[`GPADDR+3] = globalAddr[3];
    gp[31:24] = globalAddr[0];
    gp[23:16] = globalAddr[1];
    gp[15:8] = globalAddr[2];
    gp[7:0] = globalAddr[3];
  `ifdef DEBUG_DLINKER
    $display("global address %8x", {m[`GPADDR], m[`GPADDR+1], 
             m[`GPADDR+2], m[`GPADDR+3]});
    $display("gp = %8x", gp);
  `endif
`endif
`ifdef DLINKER
    for (i=0; i &lt; 192; i=i+1) begin
       dsym[i] = `MEMEMPTY;
    end
    for (i=0; i &lt; 96; i=i+1) begin
       dstr[i] = `MEMEMPTY;
    end
    for (i=0; i &lt;384; i=i+1) begin
       so_func_offset[i] = `MEMEMPTY;
    end
    $readmemh("dynsym", dsym);
    $readmemh("dynstr", dstr);
    $readmemh("so_func_offset", so_func_offset);
    setDynLinkerInfo();
  end endtask
`endif

</pre>
</div>
<p class="rubric">lbdex/cpu0_verilog/flashio.v</p>
<div class="highlight-c++"><pre>`define FLASHADDR 'hA0000

`ifdef DLINKER
    end else if (abus &gt;= `FLASHADDR &amp;&amp; abus &lt;= `FLASHADDR+`MEMSIZE-4) begin
      fabus = abus-`FLASHADDR;
      if (en == 1 &amp;&amp; rw == 0) begin // r_w==0:write
        data = dbus_in;
        case (m_size)
        `BYTE:  {flash[fabus]} = dbus_in[7:0];
        `INT16: {flash[fabus], flash[fabus+1] } = dbus_in[15:0];
        `INT24: {flash[fabus], flash[fabus+1], flash[fabus+2]} = dbus_in[24:0];
        `INT32: {flash[fabus], flash[fabus+1], flash[fabus+2], flash[fabus+3]} 
                = dbus_in;
        endcase
      end else if (en == 1 &amp;&amp; rw == 1) begin// r_w==1:read
        case (m_size)
        `BYTE:  data = {8'h00  , 8'h00,   8'h00,   flash[fabus]};
        `INT16: data = {8'h00  , 8'h00,   flash[fabus], flash[fabus+1]};
        `INT24: data = {8'h00  , flash[fabus], flash[fabus+1], flash[fabus+2]};
        `INT32: data = {flash[fabus], flash[fabus+1], flash[fabus+2], 
                       flash[fabus+3]};
        endcase
      end else
        data = 32'hZZZZZZZZ;
`endif

</pre>
</div>
<p class="rubric">lbdex/cpu0_verilog/cpu0Id.v</p>
<div class="highlight-c++"><pre>`define DLINKER  // Dynamic Linker Support
//`define DEBUG_DLINKER   // Dynamic Linker Debug
// TRACE: Display the memory contents of the loaded program and data
//`define TRACE 

`include "cpu0.v"

</pre>
</div>
<p class="rubric">lbdex/cpu0_verilog/cpu0IId.v</p>
<div class="highlight-c++"><pre>`define CPU0II
`define DLINKER  // Dynamic Linker Support
//`define DEBUG_DLINKER   // Dynamic Linker Debug
// TRACE: Display the memory contents of the loaded program and data
//`define TRACE 

`include "cpu0.v"

</pre>
</div>
<p>The following code ch_dynamiclinker.cpp and foobar.cpp is the example for
dynamic linker demostration. File dynamic_linker.cpp is what our implementaion
to execute the dynamic linker function on Cpu0 Verilog machine.</p>
<p class="rubric">lbdex/InputFiles/dynamic_linker.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#ifndef _DYNAMIC_LINKER_H_</span>
<span class="cp">#define _DYNAMIC_LINKER_H_</span>

<span class="cp">#define DYNLINKER_INFO_ADDR  0x70000</span>
<span class="cp">#define DYNENT_SIZE          4</span>
<span class="cp">#define DYNPROGSTART         0x40000</span>
<span class="cp">#define FLASHADDR            0xA0000</span>
<span class="cp">#define GPADDR               0x7FFF0</span>

<span class="cp">#define STOP \</span>
<span class="cp">  asm(&quot;lui $t9, 0xffff&quot;); \</span>
<span class="cp">  asm(&quot;addiu $t9, $zero, 0xffff&quot;); \</span>
<span class="cp">  asm(&quot;ret $t9&quot;);</span>

<span class="cp">#define ENABLE_TRACE \</span>
<span class="cp">  asm(&quot;mfsw $at&quot;); \</span>
<span class="cp">  asm(&quot;ori $at, $at, 0x0004&quot;); \</span>
<span class="cp">  asm(&quot;mtsw $at&quot;);</span>

<span class="cp">#define DISABLE_TRACE \</span>
<span class="cp">  asm(&quot;mfsw $at&quot;); \</span>
<span class="cp">  asm(&quot;andi $at, $at, 0xfffb&quot;); \</span>
<span class="cp">  asm(&quot;mtsw $at&quot;);</span>

<span class="k">struct</span> <span class="n">ProgAddr</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">memAddr</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">dynamic_linker_init</span><span class="p">();</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">dynamic_linker</span><span class="p">();</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/InputFiles/dynamic_linker.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;dynamic_linker.h&quot;</span>

<span class="cp">//#define DEBUG_DLINKER</span>
<span class="cp">#define PLT0ADDR 0x10</span>
<span class="cp">#define REGADDR  0x7ff00</span>

<span class="cp">#define SAVE_REGISTERS          \</span>
<span class="cp">  asm(&quot;lui $at, 7&quot;);            \</span>
<span class="cp">  asm(&quot;ori $at, $at, 0xff00&quot;);  \</span>
<span class="cp">  asm(&quot;st $2, 0($at)&quot;);         \</span>
<span class="cp">  asm(&quot;st $3, 4($at)&quot;);         \</span>
<span class="cp">  asm(&quot;st $4, 8($at)&quot;);         \</span>
<span class="cp">  asm(&quot;st $5, 12($at)&quot;);        \</span>
<span class="cp">  asm(&quot;st $6, 16($at)&quot;);        \</span>
<span class="cp">  asm(&quot;st $7, 20($at)&quot;);        \</span>
<span class="cp">  asm(&quot;st $8, 24($at)&quot;);        \</span>
<span class="cp">  asm(&quot;st $9, 28($at)&quot;);        \</span>
<span class="cp">  asm(&quot;st $10, 32($at)&quot;);       \</span>
<span class="cp">  asm(&quot;st $11, 36($at)&quot;);</span>

<span class="cp">#define RESTORE_REGISTERS       \</span>
<span class="cp">  asm(&quot;lui $at, 7&quot;);            \</span>
<span class="cp">  asm(&quot;ori $at, $at, 0xff00&quot;);  \</span>
<span class="cp">  asm(&quot;ld $2, 0($at)&quot;);         \</span>
<span class="cp">  asm(&quot;ld $3, 4($at)&quot;);         \</span>
<span class="cp">  asm(&quot;ld $4, 8($at)&quot;);         \</span>
<span class="cp">  asm(&quot;ld $5, 12($at)&quot;);        \</span>
<span class="cp">  asm(&quot;ld $6, 16($at)&quot;);        \</span>
<span class="cp">  asm(&quot;ld $7, 20($at)&quot;);        \</span>
<span class="cp">  asm(&quot;ld $8, 24($at)&quot;);        \</span>
<span class="cp">  asm(&quot;ld $9, 28($at)&quot;);        \</span>
<span class="cp">  asm(&quot;ld $10, 32($at)&quot;);       \</span>
<span class="cp">  asm(&quot;ld $11, 36($at)&quot;);</span>


<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">int</span> <span class="n">printf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...);</span>

<span class="kt">int</span> <span class="n">got_plt_fill</span><span class="p">[</span><span class="mh">0x80</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">progCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// program counter, init to 0 in main()</span>

<span class="n">ProgAddr</span> <span class="n">prog</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

<span class="kt">void</span> <span class="n">dynamic_linker</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">SAVE_REGISTERS</span><span class="p">;</span>
<span class="c1">//  static ProgAddr prog[10]; // has side effect (ProgAddr cannot be written in </span>
<span class="c1">// Virtual Box on iMac).</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">nextFreeAddr</span><span class="p">;</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">numDynEntry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">dynsym_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">dynsym</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">dynstr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">libOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">nextFunLibOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">volatile</span> <span class="kt">int</span> <span class="n">memAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">numDynEntry</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="n">DYNLINKER_INFO_ADDR</span><span class="p">));</span>
  <span class="kt">int</span> <span class="n">gp</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">GPADDR</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG_DLINKER</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;gp = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gp</span><span class="p">);</span>
<span class="cp">#endif</span>
  <span class="n">dynsym_idx</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">gp</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG_DLINKER</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;numDynEntry = %d, dynsym_idx = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">numDynEntry</span><span class="p">,</span> <span class="n">dynsym_idx</span><span class="p">);</span>
<span class="cp">#endif</span>
  <span class="n">dynsym</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)((</span><span class="n">DYNLINKER_INFO_ADDR</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">dynsym_idx</span><span class="o">*</span><span class="n">DYNENT_SIZE</span><span class="p">));</span>
  <span class="n">dynstr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">DYNLINKER_INFO_ADDR</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="n">numDynEntry</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="n">numDynEntry</span><span class="o">*</span><span class="mi">52</span><span class="o">+</span><span class="n">dynsym</span><span class="p">);</span>
  <span class="n">libOffset</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="n">DYNLINKER_INFO_ADDR</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="n">numDynEntry</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="p">(</span><span class="n">dynsym_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">52</span><span class="p">));</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">dynsym_idx</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numDynEntry</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">nextFunLibOffset</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="n">DYNLINKER_INFO_ADDR</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="n">numDynEntry</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">52</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">libOffset</span> <span class="o">!=</span> <span class="n">nextFunLibOffset</span><span class="p">)</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="cp">#ifdef DEBUG_DLINKER</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;address of dstr = %x, dynsym = %d, dstr = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
         <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">dynstr</span><span class="p">,</span> <span class="n">dynsym</span><span class="p">,</span> <span class="n">dynstr</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;libOffset = %d, nextFunLibOffset = %d, progCounter = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
         <span class="n">libOffset</span><span class="p">,</span> <span class="n">nextFunLibOffset</span><span class="p">,</span> <span class="n">progCounter</span><span class="p">);</span>
<span class="cp">#endif</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">progCounter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
     <span class="n">nextFreeAddr</span> <span class="o">=</span> <span class="n">DYNPROGSTART</span><span class="p">;</span>
  <span class="k">else</span>
     <span class="n">nextFreeAddr</span> <span class="o">=</span> <span class="n">prog</span><span class="p">[</span><span class="n">progCounter</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">memAddr</span><span class="o">+</span><span class="n">prog</span><span class="p">[</span><span class="n">progCounter</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
  <span class="n">prog</span><span class="p">[</span><span class="n">progCounter</span><span class="p">].</span><span class="n">memAddr</span> <span class="o">=</span> <span class="n">nextFreeAddr</span><span class="p">;</span>
  <span class="n">prog</span><span class="p">[</span><span class="n">progCounter</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">nextFunLibOffset</span> <span class="o">-</span> <span class="n">libOffset</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG_DLINKER</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;prog[progCounter].memAddr = %d, prog[progCounter].size = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
         <span class="n">prog</span><span class="p">[</span><span class="n">progCounter</span><span class="p">].</span><span class="n">memAddr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">prog</span><span class="p">[</span><span class="n">progCounter</span><span class="p">].</span><span class="n">size</span><span class="p">));</span>
<span class="cp">#endif</span>
  <span class="c1">// Load program from (FLASHADDR+libOffset..FLASHADDR+nextFunLibOffset-1) to</span>
  <span class="c1">// (nextFreeAddr..nextFreeAddr+prog[progCounter].size-1)</span>
  <span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="n">FLASHADDR</span><span class="o">+</span><span class="n">libOffset</span><span class="p">);</span>
  <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="n">src</span><span class="o">+</span><span class="n">prog</span><span class="p">[</span><span class="n">progCounter</span><span class="p">].</span><span class="n">size</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG_DLINKER</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;end = %x, src = %x, nextFreeAddr = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
         <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">end</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">src</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">nextFreeAddr</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;*src = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="o">*</span><span class="n">src</span><span class="p">));</span>
<span class="cp">#endif</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;loading %s...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dynstr</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="n">prog</span><span class="p">[</span><span class="n">progCounter</span><span class="p">].</span><span class="n">memAddr</span><span class="p">);</span> <span class="n">src</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">src</span><span class="o">++</span><span class="p">,</span> <span class="n">dest</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG_DLINKER</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;*dest = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="o">*</span><span class="n">dest</span><span class="p">));</span>
<span class="cp">#endif</span>
  <span class="p">}</span>
  <span class="n">progCounter</span><span class="o">++</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG_DLINKER</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;progCounter-1 = %x, prog[progCounter-1].memAddr = %x, \</span>
<span class="s">         *prog[progCounter-1].memAddr = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
         <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">progCounter</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">prog</span><span class="p">[</span><span class="n">progCounter</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">memAddr</span><span class="p">),</span> 
         <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="n">prog</span><span class="p">[</span><span class="n">progCounter</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">memAddr</span><span class="p">));</span>
<span class="cp">#endif</span>
  <span class="c1">// Change .got.plt for &quot;ld	$t9, idx($gp)&quot;</span>
  <span class="o">*</span><span class="p">((</span><span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="n">gp</span><span class="o">+</span><span class="mh">0x10</span><span class="o">+</span><span class="n">dynsym_idx</span><span class="o">*</span><span class="mh">0x04</span><span class="p">))</span> <span class="o">=</span> <span class="n">prog</span><span class="p">[</span><span class="n">progCounter</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">memAddr</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="mh">0x7FFE0</span><span class="p">)</span> <span class="o">=</span> <span class="n">prog</span><span class="p">[</span><span class="n">progCounter</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">memAddr</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG_DLINKER</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;*((int*)(gp+0x10+dynsym_idx*0x10)) = %x, *(int*)(0x7FFE0) = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
         <span class="o">*</span><span class="p">((</span><span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="n">gp</span><span class="o">+</span><span class="mh">0x10</span><span class="o">+</span><span class="n">dynsym_idx</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="mh">0x7FFE0</span><span class="p">)));</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;*((int*)(gp+0x04)) = %x, *((int*)(gp+0x08)) = %x, *((int*)(gp+0x0c)) = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
         <span class="o">*</span><span class="p">((</span><span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="n">gp</span><span class="o">+</span><span class="mh">0x04</span><span class="p">)),</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="n">gp</span><span class="o">+</span><span class="mh">0x08</span><span class="p">)),</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="n">gp</span><span class="o">+</span><span class="mh">0x0c</span><span class="p">)));</span>
<span class="cp">#endif</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;run %s...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dynstr</span><span class="p">);</span>
  <span class="n">RESTORE_REGISTERS</span><span class="p">;</span>

  <span class="c1">// restore $lr. The next instruction of foo() of main.cpp for the main.cpp</span>
  <span class="c1">// call foo() first time example.</span>
  <span class="c1">// The $lr, $fp and $sp saved in cpu0Plt0AtomContent of Cpu0LinkingContext.cpp.</span>
  <span class="k">asm</span><span class="p">(</span><span class="s">&quot;ld $lr, 4($gp)&quot;</span><span class="p">);</span> <span class="c1">// restore $lr</span>
<span class="cp">#ifdef DEBUG_DLINKER</span>
  <span class="n">ENABLE_TRACE</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="k">asm</span><span class="p">(</span><span class="s">&quot;ld $fp, 8($gp)&quot;</span><span class="p">);</span> <span class="c1">// restore $fp</span>
  <span class="k">asm</span><span class="p">(</span><span class="s">&quot;ld $sp, 12($gp)&quot;</span><span class="p">);</span> <span class="c1">// restore $sp</span>
<span class="cp">#ifdef DEBUG_DLINKER</span>
  <span class="n">DISABLE_TRACE</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="c1">// jmp to the dynamic linked function. It&#39;s foo() for the </span>
  <span class="c1">// caller, ch_dynamic_linker.cpp, call foo() </span>
  <span class="c1">// first time example.</span>
  <span class="k">asm</span><span class="p">(</span><span class="s">&quot;lui $t9, 0x7&quot;</span><span class="p">);</span>
  <span class="k">asm</span><span class="p">(</span><span class="s">&quot;ori $t9, $t9, 0xFFE0&quot;</span><span class="p">);</span>
  <span class="k">asm</span><span class="p">(</span><span class="s">&quot;ld $t9, 0($t9)&quot;</span><span class="p">);</span>
  <span class="k">asm</span><span class="p">(</span><span class="s">&quot;ret $t9&quot;</span><span class="p">);</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/InputFiles/ch_dynamiclinker.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;dynamic_linker.h&quot;</span>
<span class="cp">#include &quot;print.h&quot;</span>

<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">int</span> <span class="n">printf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...);</span>

<span class="c1">// For memory IO</span>
<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">int</span> <span class="n">putchar</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">OUT_MEM</span><span class="p">;</span>
  <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">la</span><span class="p">(</span><span class="kt">int</span> <span class="n">x1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x2</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">foo</span><span class="p">(</span><span class="kt">int</span> <span class="n">x1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x2</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">bar</span><span class="p">();</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
<span class="c1">//  ENABLE_TRACE;</span>
  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">  a = la(1, 2);</span>
<span class="c">  printf(&quot;la(1, 2) = %d\n&quot;, a);</span>
<span class="cp">#endif</span>
<span class="cp">#if 1</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">foo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;foo(1, 2) = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#if 1</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">bar</span><span class="p">();</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;bar() = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
<span class="cp">#endif</span>
  
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/InputFiles/foobar.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;dynamic_linker.h&quot;</span>

<span class="kt">int</span> <span class="n">la</span><span class="p">(</span><span class="kt">int</span> <span class="n">x1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x2</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="n">sum</span><span class="p">;</span> 
<span class="p">}</span>

<span class="kt">int</span> <span class="n">foo</span><span class="p">(</span><span class="kt">int</span> <span class="n">x1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x2</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="n">sum</span><span class="p">;</span> 
<span class="p">}</span>

<span class="kt">int</span> <span class="n">bar</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
<span class="c1">//  ENABLE_TRACE;</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">foo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">a</span> <span class="o">+=</span> <span class="n">la</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="c1">// 4+7=11</span>

  <span class="k">return</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="id3">
<h3>Run<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>Gamma@localhost cpu0_verilog<span class="o">]</span><span class="nv">$ </span><span class="nb">pwd</span>
/home/Gamma/test/lbd/docs/BackendTutorial/source_ExampleCode/cpu0_verilog
<span class="o">[</span>Gamma@localhost cpu0_verilog<span class="o">]</span><span class="nv">$ </span>bash clean.sh
<span class="o">[</span>Gamma@localhost InputFiles<span class="o">]</span><span class="nv">$ </span><span class="nb">cd</span> ../InputFiles/
<span class="o">[</span>Gamma@localhost InputFiles<span class="o">]</span><span class="nv">$ </span>bash build-dlinker.sh
<span class="o">[</span>Gamma@localhost InputFiles<span class="o">]</span><span class="nv">$ </span><span class="nb">cd</span> ../cpu0_verilog/
<span class="o">[</span>Gamma@localhost cpu0_verilog<span class="o">]</span><span class="nv">$ </span><span class="nb">pwd</span>
/home/Gamma/test/lbd/docs/BackendTutorial/source_ExampleCode/cpu0_verilog
<span class="o">[</span>Gamma@localhost cpu0_verilog<span class="o">]</span><span class="nv">$ </span>iverilog -o cpu0IId cpu0IId.v
<span class="o">[</span>Gamma@localhost cpu0_verilog<span class="o">]</span><span class="nv">$ </span>ls
clean.sh  cpu0Id  cpu0Id.v  cpu0IId.v  cpu0IIs.v  cpu0Is.v  cpu0.v  dynlinker.v
flashio.v
<span class="o">[</span>Gamma@localhost cpu0_verilog<span class="o">]</span><span class="nv">$ </span>./cpu0Id
WARNING: ./cpu0.v:371: <span class="nv">$readmemh</span><span class="o">(</span>cpu0.hex<span class="o">)</span>: Not enough words in the file <span class="k">for</span>
the requested range <span class="o">[</span>0:524287<span class="o">]</span>.
WARNING: ./dynlinker.v:185: <span class="nv">$readmemh</span><span class="o">(</span>libso.hex<span class="o">)</span>: Not enough words in the
file <span class="k">for </span>the requested range <span class="o">[</span>0:524287<span class="o">]</span>.
WARNING: ./dynlinker.v:223: <span class="nv">$readmemh</span><span class="o">(</span>dynsym<span class="o">)</span>: Not enough words in the file
<span class="k">for </span>the requested range <span class="o">[</span>0:191<span class="o">]</span>.
WARNING: ./dynlinker.v:224: <span class="nv">$readmemh</span><span class="o">(</span>dynstr<span class="o">)</span>: Not enough words in the file
<span class="k">for </span>the requested range <span class="o">[</span>0:95<span class="o">]</span>.
WARNING: ./dynlinker.v:225: <span class="nv">$readmemh</span><span class="o">(</span>so_func_offset<span class="o">)</span>: Not enough words in
the file <span class="k">for </span>the requested range <span class="o">[</span>0:383<span class="o">]</span>.
<span class="nv">numDynEntry</span> <span class="o">=</span> 00000005
taskInterrupt<span class="o">(</span>001<span class="o">)</span>
loading _Z3fooii...
run _Z3fooii...
foo<span class="o">(</span>1, 2<span class="o">)</span> <span class="o">=</span> 3
loading _Z3barv...
run _Z3barv...
loading _Z2laii...
run _Z2laii...
bar<span class="o">()</span> <span class="o">=</span> 11
RET to PC &lt; 0, finished!
</pre></div>
</div>
<p>The &#8220;#ifdef DEBUG_DLINKER&#8221; part of code in dynamic_linker.cpp is for debugging
purpose (since we coding it and take time to debug). After skip these debug
code, the dynamic_linker.cpp is short and not difficult to read.</p>
<p>The run result is under expectation. The main() call foo() function first.
Function foo() is loaded by dynamic linker (dynamic_linker.cpp) from memory
address FLASHADDR (defined in dynamic_linker.h) to memory.
The flashio.v implement the simulation read from flash address.
After loaded foo() body from flash, dynamic_linker.cpp jump to this loaded
address by &#8220;ret $t9&#8221; instruction.</p>
<p>Same as static linker, you can generate slt instruction instead of cmp by
change from cpu=cpu0I to cpu0=cpu0II in build-dlinker.sh and run it again to
get the same result.</p>
</div>
<div class="section" id="cpu0-lld-dynamic-linker-structure">
<h3>Cpu0 lld dynamic linker structure<a class="headerlink" href="#cpu0-lld-dynamic-linker-structure" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>Thanks the llvm open source project.
To write a linker and ELF to Hex tools for the new CPU architecture is easy and
reliable.
Combine with the llvm compiler backend of support new architecture Cpu0 and
Verilog language program in the previouse Chapters, we design a software
toolchain to compile C/C++ code, link and run it on Verilog Cpu0 simulated
machine of PC without any real hardware to investment.
If you like to pay money to buy the FPGA development hardware, we believe the
code can run on FPGA CPU without problem even though we didn&#8217;t do it.
System program toolchain can be designed just like we show you at this point.
School knowledge of system program, compiler, linker, loader, computer
architecture and CPU design can be translated into a real work and see how it be
run. Now, these school books knowledge is not limited on paper.
We program it, design it and run it on real world.</p>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="http://lld.llvm.org/">http://lld.llvm.org/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="http://lld.llvm.org/getting_started.html#on-unix-like-systems">http://lld.llvm.org/getting_started.html#on-unix-like-systems</a></td></tr>
</tbody>
</table>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="optimize.html">Backend Optimization</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="install.html">Appendix A: Getting Started: Installing LLVM and the Cpu0 example code</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2012, LLVM.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>